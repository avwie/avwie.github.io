<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"/><title>avwie&#x27;s programming blog</title><style data-href="/styles.1707c2e51bd7641396d7.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&display=swap);@import url(https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap);body{font-family:"Noto Serif",serif;font-size:11pt}body code[class*=language-],body pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body code[class*=language-] ::selection,body code[class*=language-]::selection,body pre[class*=language-] ::selection,body pre[class*=language-]::selection{background:#073642}body pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}body :not(pre)>code[class*=language-],body pre[class*=language-]{background-color:#fdf6e3}body :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}body .token.cdata,body .token.comment,body .token.doctype,body .token.prolog{color:#93a1a1}body .token.punctuation{color:#586e75}body .token.namespace{opacity:.7}body .token.boolean,body .token.constant,body .token.deleted,body .token.number,body .token.property,body .token.symbol,body .token.tag{color:#268bd2}body .token.attr-name,body .token.builtin,body .token.char,body .token.inserted,body .token.selector,body .token.string,body .token.url{color:#2aa198}body .token.entity{background:#eee8d5;color:#657b83}body .token.atrule,body .token.attr-value,body .token.keyword{color:#859900}body .token.class-name,body .token.function{color:#b58900}body .token.important,body .token.regex,body .token.variable{color:#cb4b16}body .token.bold,body .token.important{font-weight:700}body .token.italic{font-style:italic}body .token.entity{cursor:help}body .markdown h1,body .markdown h2{text-decoration:underline}body .markdown h1,body .markdown h2,body .markdown h3,body .markdown h4,body .markdown h5,body .markdown h6{margin-top:1em}body .markdown strong{text-decoration:underline}body .markdown code{font-size:.9em!important}body .markdown code[class*=language-],body .markdown pre[class*=language-]{border-radius:.5em;font-family:Fira Code,monospace;font-size:.95em}body.dark{@import"https://fonts.googleapis.com/css2?family=Fira+Code&display=swap";background-color:#1b1e23!important;color:#ccc}body.dark code[class*=language-],body.dark pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body.dark code[class*=language-] ::selection,body.dark code[class*=language-]::selection,body.dark pre[class*=language-] ::selection,body.dark pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}body.dark pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body.dark :not(pre)>code[class*=language-],body.dark pre[class*=language-]{background:#2b2b2b}body.dark :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}body.dark .token.cdata,body.dark .token.comment,body.dark .token.prolog{color:gray}body.dark .token.atrule,body.dark .token.boolean,body.dark .token.delimiter,body.dark .token.important,body.dark .token.keyword,body.dark .token.selector{color:#cc7832}body.dark .token.attr-name,body.dark .token.operator,body.dark .token.punctuation{color:#a9b7c6}body.dark .token.builtin,body.dark .token.doctype,body.dark .token.tag,body.dark .token.tag .punctuation{color:#e8bf6a}body.dark .token.entity,body.dark .token.number,body.dark .token.symbol{color:#6897bb}body.dark .token.constant,body.dark .token.property,body.dark .token.variable{color:#9876aa}body.dark .token.char,body.dark .token.string{color:#6a8759}body.dark .token.attr-value,body.dark .token.attr-value .punctuation{color:#a5c261}body.dark .token.attr-value .punctuation:first-child{color:#a9b7c6}body.dark .token.url{color:#287bde;text-decoration:underline}body.dark .token.function{color:#ffc66d}body.dark .token.regex{background:#364135}body.dark .token.bold{font-weight:700}body.dark .token.italic{font-style:italic}body.dark .token.inserted{background:#294436}body.dark .token.deleted{background:#484a4a}body.dark code.language-css .token.property,body.dark code.language-css .token.property+.token.punctuation{color:#a9b7c6}body.dark code.language-css .token.id,body.dark code.language-css .token.selector>.token.attribute,body.dark code.language-css .token.selector>.token.class,body.dark code.language-css .token.selector>.token.pseudo-class,body.dark code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body.dark a{color:#6c96d6}body.dark .bg-light,body.dark .card{background-color:#333842!important}body.dark .btn-primary{background-color:#1b1e23;border-color:#1b1e23}body.dark .border-light{border-color:#333842!important}</style><meta name="generator" content="Gatsby 3.14.6"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="avwie&#x27;s programming blog" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-4cc8ddc26a0a44222046.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-9887230afd096a67a0dc.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-20bea7f0f0f45d234f8d.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-881b6afcff1906b380f8.js"/><link as="fetch" rel="preload" href="/page-data/multithreaded-web-applications-in-kotlin-with-web-workers/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="navbar navbar-dark bg-dark"><div class="container-lg d-flex"><span class="navbar-brand mt-2 mb-2 h1"><a class="text-decoration-none text-white" href="/">@avwie&#x27;s programming blog</a></span><div class="text-light mx-3"><a class="px-2" title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a class="px-2" title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a class="px-2" title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a><span class="px-2"><img alt="dark-mode" width="24" height="24" src="/layout/dark-mode-48.png"/></span></div></div></nav><div class="container-lg mt-4"><h1 class="text-decoration-underline fs-1 py-2">Multithreaded web applications in Kotlin with Web Workers</h1><h4>25 Apr, 2022</h4><div class="markdown mb-4 fs-6 col-lg-9"><p>One of the things that always interested me, but so far I never have used, are <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Web Workers</a>. To quote the MDN documentation here:</p>
<blockquote>
<p><em>"Web Workers are a simple means for web content to run scripts in background threads."</em></p>
</blockquote>
<p>This interests me, because the browser context is inherently single-threaded. Async behavior is implemented by an event-loop, but it is not possible to parallel computations inside a single scripts.</p>
<p>Web Workers solve this and this means it should also be possible to get this behavior in Kotlin, however it requires some tricks. Nevertheless I am quite happy with the result.</p>
<h2 id="separate-compilations">Separate compilations</h2>
<p>The biggest challenge I was facing was how to organize it in my project. I worked with Multiplatform projects before, but I always just used the standard settings, and I find Gradle.... challenging. Besides that, the Kotlin Mulitplatform Gradle plugin is also a complicated beast.</p>
<p>The big difference between multithreading in a 'normal' application (e.g. Java, C#, Rust etc) is that you can spin up threads from within your code <em>and</em> pass data to this thread. They all run in the same codebase and compilation unit. In browserworld however, with Web Workers, you need to launch a Worker by passing it a script file the worker should run <em>and</em> this script runs in a different environment than a normal browser script. A worker is launched in JS via <code class="language-text">new Worker("worker.js")</code> where <code class="language-text">worker.js</code> is your separate script with the worker code. This <code class="language-text">Worker</code> runs in a <code class="language-text">DedicatedWorkerGlobalScope</code>, which means that all the normal stuff, like <code class="language-text">document</code> and <code class="language-text">window</code> aren't available. Besides that, sending and receiving data is handled via message passing. Most JS objects can pass through this message-bus, but since we are using Kotlin (compiled to JS), we can't be entirely sure how the compiler handles this. So we need to be very certain about what data we pass around.</p>
<p>What is clear is that we need a project with <strong>two</strong> Javascript targets in them. One is the <em>frontend</em> and one is the <em>worker</em>. An issue with MPP programming is that the Gradle distribution tasks tends to throw everything in the <code class="language-text">distribution</code> folder and name everything the same (the name of the project).</p>
<p>However, I came up with the following solution:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// build.gradle.kts</span>
kotlin <span class="token punctuation">{</span>
    <span class="token function">js</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"worker"</span></span><span class="token punctuation">,</span> IR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        binaries<span class="token punctuation">.</span><span class="token function">executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        browser <span class="token punctuation">{</span>
            webpackTask <span class="token punctuation">{</span>
                outputFileName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"worker.js"</span></span>
            <span class="token punctuation">}</span>
            distribution <span class="token punctuation">{</span>
                name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"worker"</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">js</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"frontend"</span></span><span class="token punctuation">,</span> IR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        binaries<span class="token punctuation">.</span><span class="token function">executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        browser <span class="token punctuation">{</span>
            runTask <span class="token punctuation">{</span>
                outputFileName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"frontend.js"</span></span>
            <span class="token punctuation">}</span>

            webpackTask <span class="token punctuation">{</span>
                outputFileName <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"frontend.js"</span></span>
            <span class="token punctuation">}</span>

            distribution <span class="token punctuation">{</span>
                name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"frontend"</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// sourceSets etc</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And after building we have two separate JS files living in separate folders. </p>
<p>However, when running the frontend code via <code class="language-text">frontendBrowserDevelopmentRun</code> it can not access the <code class="language-text">worker.js</code> file. Therefore we need to add a dependency to that file via the resource. What I did as solutions was:</p>
<ul>
<li>Frontend depends on worker.js to be ready</li>
<li>Make sure worker is build before processing the resources of frontend</li>
<li>Add the build worker.js as a resource to the frontend target</li>
</ul>
<p>This is done like this in the build file:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin">kotlin <span class="token punctuation">{</span>
    sourceSets <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

        <span class="token keyword">val</span> frontendMain <span class="token keyword">by</span> getting <span class="token punctuation">{</span>
            resources<span class="token punctuation">.</span><span class="token function">srcDirs</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"./build/worker"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

tasks<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">"frontendProcessResources"</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>dependsOn<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"workerBrowserDistribution"</span></span><span class="token punctuation">)</span></code></pre></div>
<p>What we have achieved with these few lines is that the <code class="language-text">./build/worker</code> directory (where the output of the distribution task of the worker JS module is moved to) is added to the resources of the frontend module. During the <code class="language-text">processResources</code> task of the frontend module, all the related resources are moved to root of the output directory of the frontend module.</p>
<p>And, if we look to the output after running the <code class="language-text">build</code> task of frontend, we see the following:</p>
<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 300px; '>
      <a class='gatsby-resp-image-link' href='/static/f50805ffb04d7af946f5debbe961095e/5a46d/dependencies.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 116.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAACyklEQVQ4y5WUC3PaRhSF+f+/qDNtseO6NRiCKWCMg4Ml0GP1Ar14SEj7ZVZITtxJwdmZMyvNaj6du/fstmSx59V1eXh5YTL6zOz5kclkSL/fwbZXQIGUOVIegctqwZKsXFHqbVK9je0N2O+eAQu1JqWOlMv6+TSfU0tKDdA4HheU1ie2qyvcoM9mPSDP54BRrTffXVJLOUBqHAodad2QmdcIr4dl/Y3v94njMcfjV0CvofpZnRxKjZIViFt2S1V2D0eoPfwHITq10+WvAQsFtG/Yar8jvD6+d4/n3ZMkY8py8esO81Kn9DpsrVscf4Aj7gjDfynL10oN8BK09eOflcv9dkZgXLPeDHEcVfYdSTJ5K/kisOleWc0rzLDHk32F73ZZrwe4bpc0ffw48LvDU2M2yRjbahMEA4S4w/d7VckNrAH+H/jdHkqvy8G6wTZuiKIRRfGVolhUzr/rfHPegCqHrNpVbKzggSgcsts/EYbDag9Vt+N49K5B53ModYp4RKb/SWD+hfD7WNZtJQVVHQ/Dh9rxGeDbotQ4YlKuP5MtfmPt3SOcTlU6mHW5xgdLfoO+kmMh/XuK1TWW0+Own1XrTR4/3JTTraIhq1NhYCdDpvYnPLeLp46i06328NIRPJVcvWjIqiwT5JIkfURY7So2KuAqk5f2r3aobhv9FBv3joN9i7d5YO33ydIxef5Cln0hy+Y/5FH/qWrgAuSCTMXBuiJf/YHtdXHdDkk6qRth1jLq5vz8LlSslpQbkBuO5ZrEmeGbY4TziONMEWJEFL0QhnOC4IkgmLLZPHM4OOz3opobZZkLhAoIEpClREQ7pmLNJhB4voVtv6LrUwxjznI5q2QYX0iShDCMieOEJNkSRQlpukONlsJJRa1HvgsJzCc8X+D7BlHk89GhOK0GpubmOU63GKaB6+oIoREENqY5x/NW7779r5TDbxQL19ImB4kFAAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='Dependency on the worker.js output' title='Dependency on the worker.js output' src='/static/f50805ffb04d7af946f5debbe961095e/5a46d/dependencies.png' srcset='/static/f50805ffb04d7af946f5debbe961095e/3684f/dependencies.png 225w,
/static/f50805ffb04d7af946f5debbe961095e/5a46d/dependencies.png 300w' sizes='(max-width: 300px) 100vw, 300px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span></p>
<p>In the <em>frontend</em> folder we now see all the required files.</p>
<h2 id="wrapping-the-web-worker-messaging-api-into-coroutines">Wrapping the Web Worker messaging API into coroutines</h2>
<p>Communicating to Web Workers goes via a simple messaging API:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">external</span> <span class="token keyword">open</span> <span class="token keyword">class</span> <span class="token function">Worker</span><span class="token punctuation">(</span>scriptURL<span class="token operator">:</span> String<span class="token punctuation">,</span> options<span class="token operator">:</span> WorkerOptions <span class="token operator">=</span> definedExternally<span class="token punctuation">)</span> <span class="token operator">:</span> EventTarget<span class="token punctuation">,</span> AbstractWorker <span class="token punctuation">{</span>
    <span class="token keyword">var</span> onmessage<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MessageEvent<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">dynamic</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token keyword">override</span> <span class="token keyword">var</span> onerror<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">dynamic</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token keyword">fun</span> <span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> transfer<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token keyword">dynamic</span><span class="token operator">></span> <span class="token operator">=</span> definedExternally<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This means that in order to have a request/response dynamic we need to work with some sort off callback mechanism:</p>
<ul>
<li>first establish what should happen <em>on</em> a message <em>from</em> the worker via <code class="language-text">onmessage</code></li>
<li>then send a message via <code class="language-text">postMessage</code></li>
</ul>
<p>Working with callbacks feels a bit wrong when you have a nice coroutine library available in Kotlin. Luckily it is quite a breeze to wrap this in a coroutine via the <code class="language-text">suspendCoroutine</code> function, where we can hook into the current running coroutine.</p>
<p>By creating a nice extension function on <code class="language-text">Worker</code> we are able to create a suspending function which does the heavy lifting:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> Worker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">=</span> suspendCoroutine<span class="token operator">&lt;</span>MessageEvent<span class="token operator">></span> <span class="token punctuation">{</span> continuation <span class="token operator">-></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token punctuation">{</span> messageEvent <span class="token operator">-></span>
        continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>messageEvent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token punctuation">{</span> event <span class="token operator">-></span> continuation<span class="token punctuation">.</span><span class="token function">resumeWithException</span><span class="token punctuation">(</span><span class="token function">WorkerException</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We use <code class="language-text">send</code> to send basic <code class="language-text">String</code> data to the worker and return a <code class="language-text">MessageEvent</code> (the original API) when the Worker responds.</p>
<h2 id="implementing-the-worker">Implementing the Worker</h2>
<p>Creating the Worker also requires some tricks. First of all, we need to check if we are in a <code class="language-text">WorkerGlobalScope</code> or in the normal browser scope. If the latter is the case the script can not be used. Secondly, if we are in the <code class="language-text">WorkerGlobalScope</code> we need to get a reference to <code class="language-text">self</code>. The Kotlin/JS library doesn't support it. Luckily for us it is pretty simple to implement.</p>
<p>After that we also need to wrap the <code class="language-text">onmessage</code> API of the <code class="language-text">Worker</code>. I made the <code class="language-text">block</code> function suspending, so we are allowed to run suspending functions in there:</p>
<p>I poured it all into one class and created a nice helper function:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">worker</span><span class="token punctuation">(</span>block<span class="token operator">:</span> WorkerScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> isWorkerGlobalScope <span class="token operator">=</span> <span class="token function">js</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"typeof(WorkerGlobalScope) !== \"undefined\""</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">?</span> Boolean  <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Boolean cast went wrong"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isWorkerGlobalScope<span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token keyword">val</span> self <span class="token operator">=</span> <span class="token function">js</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"self"</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">?</span> DedicatedWorkerGlobalScope <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"DedicatedWorkerGlobalScope cast went wrong"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> scope <span class="token operator">=</span> <span class="token function">WorkerScope</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    <span class="token function">block</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">WorkerScope</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> self<span class="token operator">:</span> DedicatedWorkerGlobalScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> workerId <span class="token operator">=</span> <span class="token function">URLSearchParams</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"id"</span></span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">"Unknown worker"</span></span>

    <span class="token keyword">fun</span> <span class="token function">receive</span><span class="token punctuation">(</span>block<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> <span class="token operator">-></span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token punctuation">{</span> messageEvent <span class="token operator">-></span>
            GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
                self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token function">block</span><span class="token punctuation">(</span>messageEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <code class="language-text">isWorkerGlobalScope</code> checks if <code class="language-text">WorkerGlobalScope</code> is <code class="language-text">undefined</code> or not. If it is <code class="language-text">true</code> it means that we are in a valid worker scope. After that it is important to get the <code class="language-text">self</code>. We just use the simple <code class="language-text">js(...)</code> trick here also to execute some raw Javascript.
A small trick I added is to add an identifier to the worker by passing an <code class="language-text">id</code> query parameter to the script.</p>
<h2 id="wiring-it-up">Wiring it up</h2>
<p>We can now implement a simple ping as follows:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// frontend</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> worker <span class="token operator">=</span> <span class="token function">Worker</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"./worker.js?id=ping-server"</span></span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>worker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"PING!"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// worker</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> worker <span class="token punctuation">{</span>
    receive <span class="token punctuation">{</span> <span class="token keyword">data</span> <span class="token operator">-></span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token string-literal singleline"><span class="token string">"Sending back from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">workerId</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword">data</span></span></span><span class="token string">"</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And after running <code class="language-text">frontendBrowserDevelopmentRun</code> we get the following happy console message after 1000ms:</p>
<p><code class="language-text">Sending back from ping-server: PING!</code></p>
<h2 id="creating-a-worker-pool">Creating a Worker Pool</h2>
<p>One of things that I really wanted to try was to create some sort of Worker Pool. A group of workers which I can send a message to and it gets distributed between the non-busy workers. This proved to be very easy actually. The most important thing here was that I needed a way to save the request on some queue and attach to this request the information of the coroutine that send this request. Since this is pretty similar as registering a callback somewhere we could just use the <code class="language-text">suspendCoroutine</code> function again. The worker pool is implemented like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">WorkerPool</span><span class="token punctuation">(</span>size<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">private</span> <span class="token keyword">val</span> workerScript<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// this class stores the request to send _and_ the continuation token of the `suspendCoroutine` function. When the worker returns, it continues the coroutine owning the token.</span>
    <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Job</span><span class="token punctuation">(</span><span class="token keyword">val</span> <span class="token keyword">data</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> continuation<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">execute</span><span class="token punctuation">(</span>worker<span class="token operator">:</span> Worker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> response <span class="token operator">=</span> worker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
                continuation<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>t<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                continuation<span class="token punctuation">.</span><span class="token function">resumeWithException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> availableWorkers <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>Worker<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> jobs <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>Job<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">init</span> <span class="token punctuation">{</span>
        <span class="token function">repeat</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span> nr <span class="token operator">-></span>
            availableWorkers<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token function">Worker</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">workerScript</span></span><span class="token string">?id=Worker-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">nr</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// when sending data to the pool, we just put it in the queue and check if there is work to do for the pool</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">=</span> suspendCoroutine<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span> continuation <span class="token operator">-></span>
        jobs<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token function">Job</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> continuation<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">checkAvailableWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// the main function. It removes the amount of available workers and jobs from the queues and launches the jobs with the available worker.</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkAvailableWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> availableWorkers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">val</span> noOfMessages <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>jobs<span class="token punctuation">.</span>size<span class="token punctuation">,</span> availableWorkers<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
        <span class="token keyword">val</span> work <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> until noOfMessages<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> jobs<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">to</span> availableWorkers<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        work<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>job<span class="token punctuation">,</span> worker<span class="token punctuation">)</span> <span class="token operator">-></span>
            GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
                job<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>
                availableWorkers<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>
                <span class="token comment">// after finishing the job, it is important that we check if there is still work remaining</span>
                <span class="token function">checkAvailableWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We can now easily launch 50 Ping requests to a pool, like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> pool <span class="token operator">=</span> <span class="token function">WorkerPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"./worker.js"</span></span><span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Ping </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">i</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And the console output is as follows:</p>
<p><img src="/static/pool-361baeb521b8f3114cfbb18e11127bbf.gif" alt="Worker pool"></p>
<p>As can be seen, the workers are running parallel, and are being reused!</p>
<h2 id="a-type-safe-requestresponse-mechanism">A type-safe request/response mechanism</h2>
<p>For now we made the bare minimum of sending <code class="language-text">String</code> data. However, it is much interesting to have some sort of type-safe request/response mechanism, where actually some jobs can be launched. By using the <code class="language-text">kotlinx.serialization</code> library we can pass these messages easily over the worker-boundary.</p>
<p>To do this I created a simple messaging hierarchy in the <code class="language-text">common</code> module, so both frontend and worker can use it:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Serializable</span> <span class="token keyword">sealed</span> <span class="token keyword">interface</span> Message
<span class="token annotation builtin">@Serializable</span> <span class="token keyword">sealed</span> <span class="token keyword">interface</span> Request<span class="token operator">&lt;</span>R <span class="token operator">:</span> RequestResult<span class="token operator">></span> <span class="token operator">:</span> Message
<span class="token annotation builtin">@Serializable</span> <span class="token keyword">sealed</span> <span class="token keyword">interface</span> RequestResult <span class="token operator">:</span> Message
<span class="token annotation builtin">@Serializable</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Response</span><span class="token punctuation">(</span><span class="token keyword">val</span> workerId<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> result<span class="token operator">:</span> RequestResult<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">val</span> error<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> Message

<span class="token annotation builtin">@Serializable</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token keyword">val</span> ms<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Request<span class="token operator">&lt;</span>SleepResult<span class="token operator">></span>
<span class="token annotation builtin">@Serializable</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">SleepResult</span><span class="token punctuation">(</span><span class="token keyword">val</span> ms<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> RequestResult

<span class="token annotation builtin">@Serializable</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">PIApproximation</span><span class="token punctuation">(</span><span class="token keyword">val</span> iterations<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Request<span class="token operator">&lt;</span>PIApproximationResult<span class="token operator">></span>
<span class="token annotation builtin">@Serializable</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">PIApproximationResult</span><span class="token punctuation">(</span><span class="token keyword">val</span> pi<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token operator">:</span> RequestResult</code></pre></div>
<p>We have the high-level interface <code class="language-text">Message</code>. A <code class="language-text">Request</code> has a type parameter <code class="language-text">R</code> which is the response type, which should be of <code class="language-text">RequestResult</code> type. The <code class="language-text">Response</code> contains the actual response being send back.
The <code class="language-text">Sleep</code> and <code class="language-text">PIApproximation</code> requests are just some examples I'll implement later in the worker.</p>
<p>First we need to implement a way to handle the request data to send to the worker. This is pretty easy with the serialization library:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"UNCHECKED_CAST"</span></span><span class="token punctuation">)</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>R <span class="token operator">:</span> RequestResult<span class="token operator">></span> Worker<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token operator">&lt;</span>R<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> R <span class="token punctuation">{</span>
    <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> Json<span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>request <span class="token keyword">as</span> Request<span class="token operator">&lt;</span>RequestResult<span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> messageEvent <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> response <span class="token operator">=</span> Json<span class="token punctuation">.</span>decodeFromString<span class="token operator">&lt;</span>Response<span class="token operator">></span><span class="token punctuation">(</span>messageEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>error <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">WorkerException</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>result <span class="token keyword">as</span> R
<span class="token punctuation">}</span></code></pre></div>
<p>Since we know that we send a request with a response type <code class="language-text">R</code> we can safely cast it to <code class="language-text">R</code> if we don't get any errrors.</p>
<p>In the worker code we can just add an extra method to the <code class="language-text">WorkerScope</code> class:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> WorkerScope <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">fun</span> <span class="token function">receiveRequest</span><span class="token punctuation">(</span>block<span class="token operator">:</span> <span class="token keyword">suspend</span> <span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">-></span> RequestResult<span class="token punctuation">)</span> <span class="token operator">=</span> receive <span class="token punctuation">{</span> <span class="token keyword">data</span> <span class="token operator">-></span>
        <span class="token keyword">val</span> message <span class="token operator">=</span> Json<span class="token punctuation">.</span>decodeFromString<span class="token operator">&lt;</span>Message<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> response <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token function">block</span><span class="token punctuation">(</span>message <span class="token keyword">as</span> Request<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span>
            <span class="token function">Response</span><span class="token punctuation">(</span>workerId <span class="token operator">=</span> workerId<span class="token punctuation">,</span> result <span class="token operator">=</span> result<span class="token punctuation">,</span> error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Response</span><span class="token punctuation">(</span>workerId <span class="token operator">=</span> workerId<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> error <span class="token operator">=</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Json<span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And if we want to use the WorkerPool we can also extend that one:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> WorkerPool <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"UNCHECKED_CAST"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>R <span class="token operator">:</span> RequestResult<span class="token operator">></span> <span class="token function">request</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token operator">&lt;</span>R<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> R <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> Json<span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>request <span class="token keyword">as</span> Request<span class="token operator">&lt;</span>RequestResult<span class="token operator">></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> response <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> deserialized <span class="token operator">=</span> Json<span class="token punctuation">.</span>decodeFromString<span class="token operator">&lt;</span>Response<span class="token operator">></span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">return</span> deserialized<span class="token punctuation">.</span>result <span class="token keyword">as</span> R
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And now we can use our new type-safe request/response system like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// frontend</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> pool <span class="token operator">=</span> <span class="token function">WorkerPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"./worker.js"</span></span><span class="token punctuation">)</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
        GlobalScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            <span class="token keyword">when</span> <span class="token punctuation">{</span>
                i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">-></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"PI approximation: "</span></span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token function">PIApproximation</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pi<span class="token punctuation">)</span>
                <span class="token keyword">else</span> <span class="token operator">-></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Sleeping for: "</span></span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token function">Sleep</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ms<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// worker</span>
<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> worker <span class="token punctuation">{</span>
    receiveRequest <span class="token punctuation">{</span> request <span class="token operator">-></span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">is</span> PIApproximation <span class="token operator">-></span> <span class="token function">PIApproximationResult</span><span class="token punctuation">(</span><span class="token function">approximatePI</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>iterations<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">is</span> Sleep <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token function">delay</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>ms<span class="token punctuation">)</span>
                <span class="token function">SleepResult</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>ms<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And when looking into our console output we get the following:</p>
<p><img src="/static/requests-ecc15c41a83cdd592e55347a8f367ab6.gif" alt="Requests and responses"></p>
<p>Everything is working!</p>
<h2 id="conclusion">Conclusion</h2>
<p>This was a very nice proof-of-concept to work out. I ran into quite a few problems with configuring Multiplatform projects, but the people from Jetbrains are always very very helpful in the Slack channels. Most of the time it was my fault, but I found a bug in their Gradle plugin. Nevertheless, I really enjoyed to built this. Especially the wrapping of the callback code into coroutines made this look pretty elegant.</p>
<p>I think this has potential, but there is a huge drawback when using coroutines and serialization in Kotlin/JS. The package-sizes are becoming huge. Both the <code class="language-text">frontend.js</code> and <code class="language-text">worker.js</code> files are ~500kB in size <em>after</em> dead code elimination and minifying.... So there's definitely some improvements to be had.</p>
<p>If you want to ask questions, don't hesitate to contact me via Twitter <a href="https://twitter.com/avwie">@avwie</a>, or look at <a href="https://github.com/avwie/scribbles/tree/ff779032f8afda5c862f12151612a6afaea02b9d">my repository of the coding examples</a>. </p></div></div><div class="border-top border-light py-2"><div class="container-lg text-muted fw-light text-center" style="font-size:0.8em"><small>Build <!-- -->909899a<!-- --> - <!-- -->2022-04-27T10:21:41.000Z</small></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YZ9NCTW594"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YZ9NCTW594', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/multithreaded-web-applications-in-kotlin-with-web-workers";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-9887230afd096a67a0dc.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-19c651befc200e8a6535.js"],"component---src-templates-post-js":["/component---src-templates-post-js-881b6afcff1906b380f8.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-881b6afcff1906b380f8.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-20bea7f0f0f45d234f8d.js" async=""></script><script src="/app-9887230afd096a67a0dc.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-4cc8ddc26a0a44222046.js" async=""></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script></body></html>