<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"/><title>avwie&#x27;s programming blog</title><style data-href="/styles.f842382f92405a0f4c11.css" id="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;700&display=swap);code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}body{font-family:Source Sans Pro,sans-serif}.markdown h1,.markdown h2{text-decoration:underline}.markdown h1,.markdown h2,.markdown h3,.markdown h4,.markdown h5,.markdown h6{margin-top:1em}.markdown strong{text-decoration:underline}.markdown code,.markdown pre{font-size:.9em!important}</style><meta name="generator" content="Gatsby 2.32.4"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-f11f189b3d4edcb0da38.js"/><link as="script" rel="preload" href="/framework-3e6dec6139dadaa7d0c7.js"/><link as="script" rel="preload" href="/styles-9411612e31e4f14527d1.js"/><link as="script" rel="preload" href="/app-dc1bc41ffd8ac9f229ed.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-4199f1725a6b7564f99b.js"/><link as="fetch" rel="preload" href="/page-data/compositional-patterns-in-kotlin/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="navbar navbar-dark bg-dark"><div class="container-lg d-flex"><span class="navbar-brand mt-2 mb-2 h1"><a class="text-decoration-none text-white" href="/">@avwie&#x27;s programming blog</a></span><div class="text-light mx-3"><a title="Github" href="https://github.com/avwie" target="_blank" rel="noopener"><img alt="Github" width="24" height="24" src="/layout/github.png"/></a></div></div></nav><div class="container-lg mt-4"><h1 class="text-decoration-underline fs-1 py-2">Compositional Patterns in Kotlin</h1><h4>28 Feb, 2021</h4><div class="markdown mb-4 fs-6 col-lg-9"><p>Roughly speaking there are two ways to obtain polymorphic behavior in OOP languages, 'classical' inheritance and composition. There are clear benefits in either approach depending on the domain one is trying to model. So this post is not a rant about the drawbacks of inheritance, but more an evaluation of the benefits of composition in some domains. A lot has been written about both approaches, and their intended uses, but when speaking for myself I see clear benefit of inheritance when the domain is clearly described by a hierarchical tree, or the hierarchies are not very deep and diverse and there are not a lot of cross-cutting concerns. Animals are a typical example of a hierarchy that models pretty well into the inheritance paradigm. A typical drawback of deep inheritance hierarchies can be that they can be a little reluctant to change.</p>
<p>However, composition is beneficial when there is not a clear hierarchy and there are a lot of cross-cutting concerns. Think of game engines and all the elements there. A player has health, some sprite and some positional information associated with it, just like an enemy. However, a plant or a cloud are maybe just graphics and a position. Then an enemy and a player both can have some sort of weapon or attack method. However, a venomous plant on the other hand also should have some attack method. When trying to model this in a classical inheritance tree one gets stuck pretty fast.</p>
<p>Whereas inheritance is typically supported by the language in its syntax (think of <code class="language-text">class</code>, <code class="language-text">interface</code>, <code class="language-text">extends</code> <code class="language-text">implements</code> keywords in typical languages), and as such was a go-to method of modelling until a few years ago, not a lot of languages support composition natively as a language feature with keywords. Nevertheless, there is some change in that respect in recent years in languages to provide constructs for composition. Scala and Rust provide a trait system, C# has default interface implementation, Java has project Lombok which aims to provide a delegation system.</p>
<p>This post aims to show a few different methods of obtaining composition in <strong>Kotlin</strong>.</p>
<h2>The delegation pattern</h2>
<p>Kotlin has language support for the <a href="https://kotlinlang.org/docs/delegation.html">delegation pattern</a>. I think it is best shown via some code examples. Let's stay in the theme of the game example above.</p>
<h2>Defining the components</h2>
<p>First we need to describe the components we want to have, lets model these as <code class="language-text">interfaces</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Health <span class="token punctuation">{</span>
    <span class="token keyword">val</span> health<span class="token operator">:</span> Int
    <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean

    <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Sprite <span class="token punctuation">{</span>
    <span class="token keyword">val</span> spriteData<span class="token operator">:</span> ByteArray
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Position <span class="token punctuation">{</span>
    <span class="token keyword">val</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Dynamics <span class="token operator">:</span> Position <span class="token punctuation">{</span>
    <span class="token keyword">val</span> mass<span class="token operator">:</span> Double
    <span class="token keyword">val</span> velocity<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span>
    <span class="token keyword">val</span> acceleration<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span>

    <span class="token keyword">fun</span> <span class="token function">applyForce</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">updateDynamics</span><span class="token punctuation">(</span>dt<span class="token operator">:</span> Double<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Drawable <span class="token operator">:</span> Sprite<span class="token punctuation">,</span> Position

<span class="token keyword">interface</span> Dangerous <span class="token punctuation">{</span>
    <span class="token keyword">val</span> damage<span class="token operator">:</span> Int

    <span class="token keyword">fun</span> <span class="token function">attack</span><span class="token punctuation">(</span>other<span class="token operator">:</span> Health<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>These interfaces clearly communicate their intent. In the <code class="language-text">Dangerous</code> interface the attack references some other entity which should have a <code class="language-text">Health</code> interface. We also combine interfaces to, <code class="language-text">Drawable</code> in this case, to show that if two interfaces are combined this can lead to new behavior.</p>
<p>I could have chosen to have the state variables be <code class="language-text">var</code>s and have reference implementations of the functions in the interfaces themselves, but I chose not to. The reason is that I only want to have the state variables be mutated by the methods inside the interfaces, to keep things tidy and controlled. However, you could go the other way, which would require less code in the long run with the cost of loosing track how state variables are mutated. This would result in a rewritten <code class="language-text">Health</code> interface like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Health <span class="token punctuation">{</span>
    <span class="token keyword">var</span> health<span class="token operator">:</span> Int
    <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> health <span class="token operator">&lt;=</span> <span class="token number">0</span>
    
    <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">-=</span> amount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Creating the default implementations</h2>
<p>We can now define default implementations for the interfaces, to be used later for the composition:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">HealthImpl</span><span class="token punctuation">(</span>initialHealth<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Health <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">var</span> health<span class="token operator">:</span> Int <span class="token operator">=</span> initialHealth
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> health <span class="token operator">&lt;=</span> <span class="token number">0</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">-=</span> amount
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">replenish</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">+=</span> amount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> spriteData<span class="token operator">:</span> ByteArray<span class="token punctuation">)</span><span class="token operator">:</span> Sprite

<span class="token keyword">class</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Position

<span class="token keyword">class</span> <span class="token function">DynamicsImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> mass<span class="token operator">:</span> Double<span class="token punctuation">,</span> initialPosition<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Dynamics <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">var</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span> <span class="token operator">=</span> initialPosition
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">var</span> velocity<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span> <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">var</span> acceleration<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span> <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">applyForce</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">)</span> <span class="token operator">=</span> amount
        acceleration <span class="token operator">=</span> ax <span class="token operator">+</span> fx <span class="token operator">/</span> mass <span class="token keyword">to</span> ay <span class="token operator">+</span> fy <span class="token operator">/</span> mass
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">updateDynamics</span><span class="token punctuation">(</span>dt<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>vx<span class="token punctuation">,</span> vy<span class="token punctuation">)</span> <span class="token operator">=</span> velocity
        <span class="token keyword">val</span> <span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span> <span class="token operator">=</span> position
        
        <span class="token comment">// this is clearly naive, since this is not deterministic, however... it serves the purpose for this post</span>
        velocity <span class="token operator">=</span> vx <span class="token operator">+</span> ax <span class="token operator">*</span> dt <span class="token keyword">to</span> vy <span class="token operator">+</span> ay <span class="token operator">*</span> dt
        position <span class="token operator">=</span> sx <span class="token operator">+</span> vx <span class="token operator">*</span> dt <span class="token keyword">to</span> sy <span class="token operator">+</span> vy <span class="token operator">*</span> dt
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Dangerous <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">attack</span><span class="token punctuation">(</span>other<span class="token operator">:</span> Health<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        other<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Composing classes</h2>
<p>Using the reference implementations we can now construct our classes using the delegation pattern. What we immediately notice is that the constructor becomes quite big. However, we can mitigate this by just defining methods on the <code class="language-text">companion object</code> which makes the construction of a class easier, by using the reference implementations.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Player</span><span class="token punctuation">(</span> <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> healthImpl<span class="token operator">:</span> Health<span class="token punctuation">,</span> spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> dynamicsImpl<span class="token operator">:</span> Dynamics<span class="token punctuation">,</span> dangerousImpl<span class="token operator">:</span> Dangerous<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Health <span class="token keyword">by</span> healthImpl<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Dynamics <span class="token keyword">by</span> dynamicsImpl<span class="token punctuation">,</span> Dangerous <span class="token keyword">by</span> dangerousImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// just for mocking purposes</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> health<span class="token operator">:</span> Int<span class="token punctuation">,</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">,</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Player <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Player</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">HealthImpl</span><span class="token punctuation">(</span>health<span class="token punctuation">)</span><span class="token punctuation">,</span> sprite<span class="token punctuation">,</span> <span class="token function">DynamicsImpl</span><span class="token punctuation">(</span><span class="token number">74.0</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Orc</span><span class="token punctuation">(</span>healthImpl<span class="token operator">:</span> Health<span class="token punctuation">,</span> spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> dynamicsImpl<span class="token operator">:</span> Dynamics<span class="token punctuation">,</span> dangerousImpl<span class="token operator">:</span> Dangerous<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Health <span class="token keyword">by</span> healthImpl<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Dynamics <span class="token keyword">by</span> dynamicsImpl<span class="token punctuation">,</span> Dangerous <span class="token keyword">by</span> dangerousImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// just for mocking purposes</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">,</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Orc <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Orc</span><span class="token punctuation">(</span><span class="token function">HealthImpl</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sprite<span class="token punctuation">,</span> <span class="token function">DynamicsImpl</span><span class="token punctuation">(</span><span class="token number">120.0</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Tree</span><span class="token punctuation">(</span>spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> positionImpl<span class="token operator">:</span> PositionImpl<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Position <span class="token keyword">by</span> positionImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// just for mocking purposes</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Tree <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Tree</span><span class="token punctuation">(</span>sprite<span class="token punctuation">,</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">VenomousPlant</span><span class="token punctuation">(</span>spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> positionImpl<span class="token operator">:</span> PositionImpl<span class="token punctuation">,</span> dangerousImpl<span class="token operator">:</span> Dangerous<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Position <span class="token keyword">by</span> positionImpl<span class="token punctuation">,</span> Dangerous <span class="token keyword">by</span> dangerousImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">,</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> VenomousPlant <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">VenomousPlant</span><span class="token punctuation">(</span>sprite<span class="token punctuation">,</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Okay, that was quite some code, but the implications are clear. We are constructing classes by combining reference implementations for the interfaces we want to implement by leveraging the Kotlin-specific <code class="language-text">[interface] by [implementation]</code> keyword. Whats even more interesting is that we implement <code class="language-text">Drawable</code> by specifying implementations for the <code class="language-text">Sprite</code> and <code class="language-text">Position</code> interfaces, even though <code class="language-text">Orc</code> and <code class="language-text">Player</code> both implement the <code class="language-text">Position</code> interface again via the <code class="language-text">Dynamics</code> interface.  </p>
<h2>Constructing instances</h2>
<p>It is now quite a breeze to instantiate classes:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// constructing instances</span>
<span class="token keyword">val</span> player <span class="token operator">=</span> Player<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"Frodo"</span><span class="token punctuation">,</span> health <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> position <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span> damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> orc <span class="token operator">=</span> Orc<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> tree <span class="token operator">=</span> Tree<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">15.0</span> <span class="token keyword">to</span> <span class="token number">25.0</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> poisonIvy <span class="token operator">=</span> VenomousPlant<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">8.0</span> <span class="token keyword">to</span> <span class="token number">11.0</span><span class="token punctuation">,</span> damage <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> entities <span class="token operator">:</span> List<span class="token operator">&lt;</span>Any<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> orc<span class="token punctuation">,</span> tree<span class="token punctuation">,</span> poisonIvy<span class="token punctuation">)</span>

<span class="token comment">// have them interact</span>
player<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span>orc<span class="token punctuation">)</span>
orc<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span>
poisonIvy<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span>
<span class="token comment">// player.attack(tree) &lt;- does not compile, since tree does not have a Health component</span>

<span class="token function">println</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token comment">// prints Pair(15.0, 25.0)</span>

<span class="token comment">// update all dynamics</span>
entities<span class="token punctuation">.</span>filterIsInstance<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> dynamics <span class="token operator">-></span> dynamics<span class="token punctuation">.</span><span class="token function">updateDynamics</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token comment">// draw them</span>
entities<span class="token punctuation">.</span>filterIsInstance<span class="token operator">&lt;</span>Drawable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foreach</span> <span class="token punctuation">{</span> drawable <span class="token operator">-></span>
    screen<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>drawable<span class="token punctuation">.</span>position<span class="token punctuation">,</span> drawable<span class="token punctuation">.</span>spriteData<span class="token punctuation">)</span> 
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen the actual code becomes quite clear, <em>and</em>, the invariants are enforced by the compiler. It is impossible to have a <code class="language-text">Player</code> attack a <code class="language-text">Tree</code>. We can easily iterate over the cross-cutting concerns and process, which is shown in the cases of <code class="language-text">Dynamics</code> and <code class="language-text">Drawable</code>.</p>
<h2>Extending the model</h2>
<p>One of the clear benefits of the compositional model is that it is pretty easy to extend it. Imagine there are some entities in the world that are edible and by eating you gain health. In the traditional inheritance tree one would add interface <code class="language-text">Edible</code> at all the places this is required and implement those. However, we can easily extend it by creating a new <code class="language-text">Interface</code>, building a reference implementation <em>and</em> adding the reference implementation to the concrete classes which require those.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Edible <span class="token punctuation">{</span>
    <span class="token keyword">val</span> nutritionalValue<span class="token operator">:</span> Int
<span class="token punctuation">}</span>

<span class="token comment">// and we modify Health</span>
<span class="token keyword">interface</span> Health <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">fun</span> <span class="token function">eat</span><span class="token punctuation">(</span>edible<span class="token operator">:</span> Edible<span class="token punctuation">)</span> <span class="token comment">// this one is added</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">EdibleImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> nutritionalValue<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Edible

<span class="token keyword">class</span> <span class="token function">HealthImpl</span><span class="token punctuation">(</span>initialHealth<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Health <span class="token punctuation">{</span>
    <span class="token comment">// ... </span>
    <span class="token comment">// the eat function is implemented</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">eat</span><span class="token punctuation">(</span>edible<span class="token operator">:</span> Edible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">+=</span> edible<span class="token punctuation">.</span>nutritionalValue
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Potato</span><span class="token punctuation">(</span>spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> positionImpl<span class="token operator">:</span> Position<span class="token punctuation">,</span> edibleImpl<span class="token operator">:</span> EdibleImpl<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Position <span class="token keyword">by</span> positionImpl<span class="token punctuation">,</span> Edible <span class="token keyword">by</span> edibleImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>nutritionalValue<span class="token operator">:</span> Int<span class="token punctuation">,</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Potato <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Potato</span><span class="token punctuation">(</span>sprite<span class="token punctuation">,</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">EdibleImpl</span><span class="token punctuation">(</span>nutritionalValue<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// and using it is easy</span>
<span class="token keyword">val</span> food <span class="token operator">=</span> Potato<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">3.0</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span>food<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>Fun with extensions</h2>
<p>One of the cool features of Kotlin is the ability to add <a href="https://kotlinlang.org/docs/extensions.html">extensions</a>. This is a way to extend the behavior of certain types with extra functions or values without modifying the original code. </p>
<p>Imagine we want to have a Berserk function. When  <code class="language-text">health &lt;= 10</code> any player can go berserk and do double damage. This requires a class to implement both <code class="language-text">Health</code> and <code class="language-text">Dangerous</code>. To do this with extensions one can follow this approach.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// Can be in any file. Typically I place it in a subpackage called 'extensions' to keep it clean.</span>
<span class="token keyword">val</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T<span class="token punctuation">.</span>isBerserk <span class="token operator">:</span> Boolean <span class="token keyword">where</span> T <span class="token operator">:</span> Health<span class="token punctuation">,</span> T <span class="token operator">:</span> Dangerous <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isDead
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T<span class="token punctuation">.</span><span class="token function">berserkAttack</span><span class="token punctuation">(</span>enemy<span class="token operator">:</span> Health<span class="token punctuation">)</span> <span class="token keyword">where</span> T <span class="token operator">:</span> Health<span class="token punctuation">,</span> T <span class="token operator">:</span> Dangerous <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isBerserk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        enemy<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>damage <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        enemy<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>damage<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// and in your game code:</span>
<span class="token keyword">val</span> berserkPlayer <span class="token operator">=</span> Player<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"Almost dead"</span><span class="token punctuation">,</span> health <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> position <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span> damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> unfortunateOrc <span class="token operator">=</span> Orc<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>

<span class="token function">println</span><span class="token punctuation">(</span>unfortunateOrc<span class="token punctuation">.</span>health<span class="token punctuation">)</span> <span class="token comment">// prints 150</span>
berserkPlayer<span class="token punctuation">.</span><span class="token function">berserkAttack</span><span class="token punctuation">(</span>unfortunateOrc<span class="token punctuation">)</span>
<span class="token function">println</span><span class="token punctuation">(</span>unfortunateOrc<span class="token punctuation">.</span>health<span class="token punctuation">)</span> <span class="token comment">// prints 90</span></code></pre></div>
<h2>Conclusion</h2>
<p>This concludes my post on the composition pattern in Kotlin. I think this pattern has a lot of strengths compared to inheritance in certain situations. But, each has their own strenghts in their own situations.</p>
<p>This was my first ever programming blogpost I have ever written, and thanks for reading it. If you have any questions or remarks, please reach out to me via Twitter or email. I'd love to get feedback.  </p></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/compositional-patterns-in-kotlin";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-38cce18603b1d20cac17.js"],"app":["/app-dc1bc41ffd8ac9f229ed.js"],"component---src-pages-404-js":["/component---src-pages-404-js-af84eba3d2a2bbe6e79c.js"],"component---src-pages-index-js":["/component---src-pages-index-js-8d015020d9368e329211.js"],"component---src-templates-post-js":["/component---src-templates-post-js-4199f1725a6b7564f99b.js"]};/*]]>*/</script><script src="/polyfill-38cce18603b1d20cac17.js" nomodule=""></script><script src="/component---src-templates-post-js-4199f1725a6b7564f99b.js" async=""></script><script src="/app-dc1bc41ffd8ac9f229ed.js" async=""></script><script src="/styles-9411612e31e4f14527d1.js" async=""></script><script src="/framework-3e6dec6139dadaa7d0c7.js" async=""></script><script src="/webpack-runtime-f11f189b3d4edcb0da38.js" async=""></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script></body></html>