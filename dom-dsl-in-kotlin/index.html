<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"/><title>avwie&#x27;s programming blog</title><style data-href="/styles.02bd3ab1061aadf3c819.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;700&display=swap);@import url(https://fonts.googleapis.com/css2?family=Fira+Code&display=swap);code[class*=language-],pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2b2b2b}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.prolog{color:gray}.token.atrule,.token.boolean,.token.delimiter,.token.important,.token.keyword,.token.selector{color:#cc7832}.token.attr-name,.token.operator,.token.punctuation{color:#a9b7c6}.token.builtin,.token.doctype,.token.tag,.token.tag .punctuation{color:#e8bf6a}.token.entity,.token.number,.token.symbol{color:#6897bb}.token.constant,.token.property,.token.variable{color:#9876aa}.token.char,.token.string{color:#6a8759}.token.attr-value,.token.attr-value .punctuation{color:#a5c261}.token.attr-value .punctuation:first-child{color:#a9b7c6}.token.url{color:#287bde;text-decoration:underline}.token.function{color:#ffc66d}.token.regex{background:#364135}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.inserted{background:#294436}.token.deleted{background:#484a4a}code.language-css .token.property,code.language-css .token.property+.token.punctuation{color:#a9b7c6}code.language-css .token.id,code.language-css .token.selector>.token.attribute,code.language-css .token.selector>.token.class,code.language-css .token.selector>.token.pseudo-class,code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body{font-family:Source Sans Pro,sans-serif;font-size:11pt}.markdown h1,.markdown h2{text-decoration:underline}.markdown h1,.markdown h2,.markdown h3,.markdown h4,.markdown h5,.markdown h6{margin-top:1em}.markdown strong{text-decoration:underline}.markdown code{font-size:.9em!important}.markdown pre[class*=language-]{border-radius:.5em}.markdown p code{background-color:revert;color:revert;text-shadow:revert}</style><meta name="generator" content="Gatsby 3.14.6"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link as="script" rel="preload" href="/webpack-runtime-5b944b32a8cd6d0186fb.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-9887230afd096a67a0dc.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-c84cd9785c086ddb17fc.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-881b6afcff1906b380f8.js"/><link as="fetch" rel="preload" href="/page-data/dom-dsl-in-kotlin/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="navbar navbar-dark bg-dark"><div class="container-lg d-flex"><span class="navbar-brand mt-2 mb-2 h1"><a class="text-decoration-none text-white" href="/">@avwie&#x27;s programming blog</a></span><div class="text-light mx-3"><a class="px-2" title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a class="px-2" title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a class="px-2" title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a></div></div></nav><div class="container-lg mt-4"><h1 class="text-decoration-underline fs-1 py-2">Building a multiplatform DOM DSL in Kotlin</h1><h4>09 Apr, 2022</h4><div class="markdown mb-4 fs-6 col-lg-9"><p>For a project I needed to generate a lot of SVG's both in JS as well as in a backend. I assumed that this could easily be solved by using Kotlin Multiplatform, but I ran into some problems. Eventually I decided to build a minimal DSL to solve the problem I had.</p>
<h2 id="generating-dom-documents-in-js-and-the-jvm">Generating DOM Documents in JS and the JVM</h2>
<p>In this project I needed to <em>generate</em> dynamic SVG files based on some parameters. Since identical images needed to be created in the frontend (JS), as well as in the backend (JVM) and we were already using Kotlin, the obvious choice was just to make a Kotlin Multiplatform library. By <a href="https://kotlinlang.org/docs/multiplatform-connect-to-apis.html">connecting to platform specific api's</a> I thought I could easily wrap the <code class="language-text">Document</code> API's of both the JVM and the browser.</p>
<p>However, as I soon found out, they aren't completely identical. Besides, I didn't feel like having to create a whole bunch of <code class="language-text">expect</code>/<code class="language-text">actual</code> things for a hiararchy of interfaces and or classes. </p>
<p>I thought Jetbrains already solved this issue with the <a href="https://github.com/Kotlin/kotlinx.html">kotilinx.html</a> library, but that only focusses on HTML, and not on SVG's or DOM Documents in general.</p>
<h2 id="use-cases">Use cases</h2>
<p>What I wanted was at least the following:</p>
<ul>
<li>Generate DOM elements in the browser</li>
<li>Generate DOM elements in the backend</li>
<li>Have the same codebase for both</li>
<li>Have support for namespaces (for SVG's)</li>
<li>Have a more ergonomic API than the classical imperative API</li>
<li>Support a Virtual DOM</li>
</ul>
<h2 id="basic-setup">Basic setup</h2>
<p>Okay, so I created a new Kotlin Multiplatform library and started working only on the Common module, to be as language agnostic as possible. </p>
<h3 id="definition-and-writers">Definition and writers</h3>
<p>The first thing was that I wanted to separate the content or definition of the DOM Document from the actual implementation. I solved this by creating an interface named <code class="language-text">Definition</code> that can write to a <code class="language-text">Writer</code>. They are initially defined as follows:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token keyword">interface</span> Definition <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">write</span><span class="token punctuation">(</span>writer<span class="token operator">:</span> Writer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Writer <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">beginElement</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">endElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">fun</span> <span class="token function">writeAttribute</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">writeText</span><span class="token punctuation">(</span>text<span class="token operator">:</span> String<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <code class="language-text">Definition</code> interface has only 1 method and can as such be written as a <a href="https://kotlinlang.org/docs/fun-interfaces.html">functional interface</a>. The <code class="language-text">Writer</code> encapsulates the side-effects, whereas the <code class="language-text">Definition</code> contains the structure of the DOM Document.</p>
<h3 id="definition-builder-dsl">Definition Builder DSL</h3>
<p>The most important thing to do is to be able to generate a <code class="language-text">Definition</code>. One could just implement them for every DOM Document I want to generate but that makes it very cumbersome and verbose. More interesting would be to create a nice builder DSL that writer to a <code class="language-text">Writer</code> and wire the <code class="language-text">Builder</code> up to a <code class="language-text">Definition</code> later. </p>
<p>We start with the following <code class="language-text">Builder</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Builder</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> writer<span class="token operator">:</span> Writer<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">element</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">beginElement</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
        <span class="token function">block</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span><span class="token function">endElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">attribute</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">writeAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">text</span><span class="token punctuation">(</span>raw<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">writeText</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <code class="language-text">Builder</code> requires a <code class="language-text">Writer</code> instance and a <code class="language-text">namespace</code> after which it is possible to write to a <code class="language-text">Writer</code>. This wouldn't be very interesting if it wasn't for the <code class="language-text">block: Builder.() -> Unit</code> arguments in the <code class="language-text">element</code> method. This is a <a href="https://kotlinlang.org/docs/lambdas.html#function-literals-with-receiver">function literal with a receiver</a>, which means that the <code class="language-text">this</code> in the scope of the lambda refers to the <code class="language-text">Builder</code> instance that is passed as first argument. So, we can use it like follows:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> writer<span class="token operator">:</span> Writer <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">val</span> builder <span class="token operator">=</span> <span class="token function">Builder</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string-literal singleline"><span class="token string">"ns"</span></span><span class="token punctuation">)</span>

<span class="token function">with</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// `this` is builder</span>
    <span class="token function">element</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"root"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// `this` is builder still</span>
        <span class="token function">attribute</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"bar"</span></span><span class="token punctuation">)</span>
        <span class="token function">element</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"child"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// this translates to:</span>
writer<span class="token punctuation">.</span><span class="token function">beginElement</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"root"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"ns"</span></span><span class="token punctuation">)</span>
writer<span class="token punctuation">.</span><span class="token function">writeAttribute</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"bar"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"ns"</span></span><span class="token punctuation">)</span>
writer<span class="token punctuation">.</span><span class="token function">beginElement</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"child"</span></span><span class="token punctuation">)</span>
writer<span class="token punctuation">.</span><span class="token function">endElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
writer<span class="token punctuation">.</span><span class="token function">endElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<h2 id="wiring-up-the-builder-to-the-definition">Wiring up the Builder to the Definition</h2>
<p>It is pretty trivial to add the builder to the definition now:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token keyword">interface</span> Definition <span class="token punctuation">{</span>

    <span class="token keyword">fun</span> <span class="token function">write</span><span class="token punctuation">(</span>writer<span class="token operator">:</span> Writer<span class="token punctuation">)</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">fun</span> <span class="token function">build</span><span class="token punctuation">(</span>
            namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
            block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token operator">:</span> Definition <span class="token operator">=</span> Definition <span class="token punctuation">{</span> writer <span class="token operator">-></span>
            <span class="token function">block</span><span class="token punctuation">(</span><span class="token function">Builder</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And now we can create a definition like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> domDefinition <span class="token operator">=</span> Definition<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"ns"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">element</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"root"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// `this` is builder still</span>
        <span class="token function">attribute</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"bar"</span></span><span class="token punctuation">)</span>
        <span class="token function">element</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"child"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// and write to it like this</span>
<span class="token keyword">val</span> writer <span class="token operator">:</span> Writer <span class="token operator">=</span> <span class="token operator">..</span><span class="token operator">..</span>
domDefinition<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span></code></pre></div>
<h2 id="improving-the-dsl">Improving the DSL</h2>
<p>It is still a bit verbose, so by modifying the <code class="language-text">Builder</code> we can make it a little bit more ergonomic:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Builder</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> writer<span class="token operator">:</span> Writer<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">element</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">beginElement</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
        <span class="token function">block</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span><span class="token function">endElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">attribute</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">writeAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">text</span><span class="token punctuation">(</span>raw<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writer<span class="token punctuation">.</span><span class="token function">writeText</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Adding these operator functions</span>
    <span class="token keyword">operator</span> <span class="token keyword">fun</span> String<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">element</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> block<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">operator</span> <span class="token keyword">fun</span> String<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>
        <span class="token keyword">vararg</span> args<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">,</span>
        block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">element</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            args<span class="token punctuation">.</span><span class="token function">filterNotNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-></span> name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">attribute</span><span class="token punctuation">(</span>name<span class="token operator">!!</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token function">block</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We are using <a href="https://kotlinlang.org/docs/extensions.html">extension functions</a> on <code class="language-text">String</code> <em>inside</em> the <code class="language-text">Builder</code> class. We add the <code class="language-text">invoke</code> operator function to <code class="language-text">String</code> which allows us to 'call' <code class="language-text">String</code> inside the scope of <code class="language-text">Builder</code>. Together with <code class="language-text">varargs</code> we have a very simple expressive DSL, whic results into:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> domDefinition <span class="token operator">=</span> Definition<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"ns"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string-literal singleline"><span class="token string">"root"</span></span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"bar"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string-literal singleline"><span class="token string">"child"</span></span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"baz"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"bat"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"quux"</span></span> <span class="token keyword">to</span> <span class="token number">1234</span><span class="token punctuation">)</span>
        <span class="token string-literal singleline"><span class="token string">"single"</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Now, by adding some utility functions we can improve our DSL a little more:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">xml</span><span class="token punctuation">(</span>
    root<span class="token operator">:</span> String<span class="token punctuation">,</span>
    namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword">vararg</span> args<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">,</span>
    block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Definition <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Definition<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> block<span class="token operator">=</span>block<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">xml</span><span class="token punctuation">(</span>root<span class="token operator">:</span> String<span class="token punctuation">,</span> block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">xml</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block <span class="token operator">=</span> block<span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">xml</span><span class="token punctuation">(</span>root<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">vararg</span>  args<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">,</span> block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">xml</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token operator">=</span>args<span class="token punctuation">,</span> block <span class="token operator">=</span> block<span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token function">svg</span><span class="token punctuation">(</span>
    width<span class="token operator">:</span> Int<span class="token operator">?</span><span class="token punctuation">,</span>
    height<span class="token operator">:</span> Int<span class="token operator">?</span><span class="token punctuation">,</span>
    viewBox<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    block<span class="token operator">:</span> Builder<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Definition <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Definition<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"http://www.w3.org/2000/svg"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string-literal singleline"><span class="token string">"svg"</span></span><span class="token punctuation">(</span>
            <span class="token string-literal singleline"><span class="token string">"xmlns"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"http://www.w3.org/2000/svg"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"version"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"1.1"</span></span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"width"</span></span> <span class="token keyword">to</span> width<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"height"</span></span> <span class="token keyword">to</span> height<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewBox <span class="token operator">&amp;&amp;</span> width <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> height <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token string-literal singleline"><span class="token string">"viewBox"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"0 0 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">width</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">height</span></span><span class="token string">"</span></span> <span class="token keyword">else</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            block <span class="token operator">=</span> block
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen we can now eaily generate XML elements (or SVG) elements using these simple functions:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> test <span class="token operator">=</span> <span class="token function">svg</span><span class="token punctuation">(</span>width <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string-literal singleline"><span class="token string">"rect"</span></span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"width"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"100%"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"height"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"100%"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"red"</span></span><span class="token punctuation">)</span>
        <span class="token string-literal singleline"><span class="token string">"circle"</span></span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"cx"</span></span> <span class="token keyword">to</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"cy"</span></span> <span class="token keyword">to</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"r"</span></span> <span class="token keyword">to</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"green"</span></span><span class="token punctuation">)</span>
        <span class="token string-literal singleline"><span class="token string">"text"</span></span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"x"</span></span> <span class="token keyword">to</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"y"</span></span> <span class="token keyword">to</span> <span class="token number">125</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"font-size"</span></span> <span class="token keyword">to</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"text-anchor"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"middle"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"white"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"SVG"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>which will be rendered to:</p>
<div class="gatsby-highlight" data-language="xml"><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>red<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>150<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>80<span class="token punctuation">"</span></span> <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>green<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>150<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>125<span class="token punctuation">"</span></span> <span class="token attr-name">font-size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span> <span class="token attr-name">text-anchor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>middle<span class="token punctuation">"</span></span> <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>white<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>SVG<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span></code></pre></div>
<p>To be honest, this isn't necessarily less verbose than XML itself is. But the power comes from the flexibility of creating writers.</p>
<h2 id="creating-writers">Creating Writers</h2>
<h3 id="appendable">Appendable</h3>
<p>The first one is a <code class="language-text">common</code>-module writer which just writer the definition to an <code class="language-text">Appendable</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">AppendableWriter</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> appendable<span class="token operator">:</span> Appendable<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> prettyPrint<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> prettyPrintIndent<span class="token operator">:</span> Int
<span class="token punctuation">)</span> <span class="token operator">:</span> Writer <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> tags <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> hasChildren <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> level <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> indent <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prettyPrint<span class="token punctuation">)</span> <span class="token string-literal singleline"><span class="token string">" "</span></span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>prettyPrintIndent<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string-literal singleline"><span class="token string">""</span></span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> newline <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prettyPrint<span class="token punctuation">)</span> <span class="token string-literal singleline"><span class="token string">"\n"</span></span> <span class="token keyword">else</span> <span class="token string-literal singleline"><span class="token string">""</span></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">beginElement</span><span class="token punctuation">(</span>tag<span class="token operator">:</span> String<span class="token punctuation">,</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasChildren<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> currentHasChildren <span class="token operator">=</span> hasChildren<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentHasChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                appendable<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">newline</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            hasChildren<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        level <span class="token operator">+=</span> <span class="token number">1</span>
        appendable<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression"><span class="token function">indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">tag</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        tags<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
        hasChildren<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">endElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> tag <span class="token operator">=</span> tags<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>hasChildren<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token boolean">true</span> <span class="token operator">-></span> appendable<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression"><span class="token function">indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">tag</span></span><span class="token string">></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">newline</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">else</span> <span class="token operator">-></span> appendable<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" /></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">newline</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        level <span class="token operator">-=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeAttribute</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        appendable<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">" </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">name</span></span><span class="token string">=\"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">value</span></span><span class="token string">\""</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeText</span><span class="token punctuation">(</span>text<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        appendable<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">indent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> indent<span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>level <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// and a convencience extension function:</span>
<span class="token keyword">fun</span> Definition<span class="token punctuation">.</span><span class="token function">renderAsString</span><span class="token punctuation">(</span>
    prettyPrint<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    prettyPrintIndent<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> builder <span class="token operator">-></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">AppendableWriter</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> prettyPrint<span class="token punctuation">,</span> prettyPrintIndent<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// and we can now write:</span>
<span class="token keyword">val</span> test <span class="token operator">:</span> String <span class="token operator">=</span> <span class="token function">xml</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">renderAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>This one will now work in <em>all</em> platforms, since it is purely a <code class="language-text">common</code>-module.</p>
<h3 id="browser-dom">Browser DOM</h3>
<p>A writer that is used in the <code class="language-text">JS</code> module only is easily written as well:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>document
<span class="token keyword">import</span> org<span class="token punctuation">.</span>w3c<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>Element

<span class="token keyword">class</span> BrowserWriter <span class="token operator">:</span> Writer <span class="token punctuation">{</span>

    <span class="token keyword">var</span> result<span class="token operator">:</span> Element<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> stack <span class="token operator">=</span> ArrayDeque<span class="token operator">&lt;</span>Element<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">beginElement</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        stack<span class="token punctuation">.</span><span class="token function">firstOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
        stack<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">endElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeAttribute</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stack<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeText</span><span class="token punctuation">(</span>text<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stack<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// and a convenience extension function</span>
<span class="token keyword">fun</span> Definition<span class="token punctuation">.</span><span class="token function">toElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Element <span class="token operator">=</span> <span class="token function">BrowserWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> writer <span class="token operator">-></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>result<span class="token operator">!!</span>

<span class="token comment">// and we can now write:</span>
<span class="token keyword">val</span> test <span class="token operator">:</span> Element <span class="token operator">=</span> <span class="token function">svg</span><span class="token punctuation">(</span><span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>We use a simple <code class="language-text">ArrayDeque</code> as a stack here, to keep track of the current element and its parents. We can now test this in our browser eaily by creating a <code class="language-text">main</code> in our JS module and creating an SVG in it.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">demo</span><span class="token punctuation">(</span>angle<span class="token operator">:</span> Double<span class="token punctuation">)</span><span class="token operator">:</span> Definition <span class="token operator">=</span> <span class="token function">svg</span><span class="token punctuation">(</span>width <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string-literal singleline"><span class="token string">"rect"</span></span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"width"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"100%"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"height"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"100%"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"red"</span></span><span class="token punctuation">)</span>
    <span class="token string-literal singleline"><span class="token string">"g"</span></span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"transform"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"rotate(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">angle</span></span><span class="token string">, 150, 100)"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string-literal singleline"><span class="token string">"circle"</span></span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"cx"</span></span> <span class="token keyword">to</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"cy"</span></span> <span class="token keyword">to</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"r"</span></span> <span class="token keyword">to</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"green"</span></span><span class="token punctuation">)</span>
        <span class="token string-literal singleline"><span class="token string">"text"</span></span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"x"</span></span> <span class="token keyword">to</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"y"</span></span> <span class="token keyword">to</span> <span class="token number">125</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"font-size"</span></span> <span class="token keyword">to</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"text-anchor"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"middle"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">to</span> <span class="token string-literal singleline"><span class="token string">"white"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"SVG"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"app"</span></span><span class="token punctuation">)</span><span class="token operator">!!</span>

    <span class="token comment">// render them as normal elements</span>
    <span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
        app<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">demo</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">90.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>and this will result in:
<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; '>
      <a class='gatsby-resp-image-link' href='/static/7a4b009bdee262db7b764ba5e7b1258e/d7e70/svg-elements.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 75.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAADEUlEQVQ4y22TXWgUVxTHz87urCaBZs1Xk7Cz5KPb7X4kTZMqDYZsTNYkq26IXYtFFCmhD1aE0gfpF22x0kSMGmmLHyhR89A++KJ99E1BCwGtVrMlRoS2D0ILYmKhZDP3V+bOFE3aC4f/Of+5859z7/+MzNy7x/T0NL8UChQKBWYfzDH/dAFnKaV0sAJt3Hie+zeXwuwsP929S2FujtuFGX6evsXC43lXEP6DSzxbTm0/lzsh7N0LgwOwaQtkt/Dr7hyPtg1COgOZDCrzDHWezvBbLs2dt9LQm4G+jdjpbhgZQdk2stTYACL8JcJwvyDvC+Y+4cs20bwtgvLQqY/HhdgnIaIHaxkcEp54vO3oOILFV1s1MZ4OIqdqKR9bQ9mRKszxEDcsH4ifxYABYjBTG0A+F+KTr5O5sBE5avBpv6nfL7amvA5bUpp4902TroubyZ7ZwPC5LC+feY2zre7X//a7eOkVH/KF0DIRY93XbchBIf+23+0wmXAFiy1JTVxMGcjxCuRQCTIRwjqwhocvuEJLPhf/KBWqPhAaptbScb4LOezjbIfhdpjyBJWj7N3DN+1C+4jQvUu4EvHEZDn+WC8Mv1NK13sljL/hck6oeNy9Q/r6UDU1qIgFIQvqLaixoMKiGAlDOIwKu6jrSifqUHW1UB6GSARVXQ29vV6HbW2ug/4gk+0GPSMBcjsDXG9w7sZkKWiC6aGY3A6bbN9ZQnZPOac6gxAI6hMqx1xtSiqhW/4h5sM4GkLGgsj4KqyPS/m9bPlxH68S6vYJJScj9Hy/Se+70OI+Kybjy13ek19NfKqTrZNZtk0NkZxcx7kVLl+O+ZADQv1oNf2nu5FRP/ntxgqXW13B0Z4AcqKaqrFKqo7Vs/pIJVe1MT4W/T6Nd+r8eg6tb6Pkv9uKHDPZP+COjTMtWtCOxTSxYAiDeUE+EmS/8OH6//9TvuoQXvysjNREjN4dwp8Bb1806rk8MIDtuNjQDI1N3FzfxP21zWA16Vo1NkI0ikomIZGAaIL7nTGu9TSjnDqewn6pGXI53eE/9Ua803/GTUIAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='SVG&#39;s generated' title='SVG&#39;s generated' src='/static/7a4b009bdee262db7b764ba5e7b1258e/1cfc2/svg-elements.png' srcset='/static/7a4b009bdee262db7b764ba5e7b1258e/3684f/svg-elements.png 225w,
/static/7a4b009bdee262db7b764ba5e7b1258e/fc2a6/svg-elements.png 450w,
/static/7a4b009bdee262db7b764ba5e7b1258e/1cfc2/svg-elements.png 900w,
/static/7a4b009bdee262db7b764ba5e7b1258e/d7e70/svg-elements.png 1286w' sizes='(max-width: 900px) 100vw, 900px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span></p>
<h3 id="making-a-virtual-dom-writer">Making a Virtual DOM Writer</h3>
<p>The goal was to also support a Virtual DOM, and this can now easily be done by levering a <a href="https://github.com/Matt-Esch/virtual-dom">virtual-dom library</a>.</p>
<p>First we need to add this <code class="language-text">npm</code> dependency in our JS project:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// in our build.gradle.kts</span>
<span class="token keyword">val</span> jsMain <span class="token keyword">by</span> getting <span class="token punctuation">{</span>
    dependencies <span class="token punctuation">{</span>
        <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">npm</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"virtual-dom"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"2.1.1"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We are going to use the hyperdom-package for generating so-called VNodes. To make this properly work in Kotlin we need to make sure we expose the required functions and classes in Kotlin via externals, which are <a href="https://kotlinlang.org/docs/using-packages-from-npm.html">pretty well described</a> in the docs. To reference the hyperdom and VNodes we add the following rules to a file:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">package</span> externals<span class="token punctuation">.</span>virtualDom

<span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>js<span class="token punctuation">.</span>Json

<span class="token annotation builtin">@JsModule</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"virtual-dom/vnode/vnode"</span></span><span class="token punctuation">)</span>
<span class="token annotation builtin">@JsNonModule</span>
<span class="token keyword">external</span> <span class="token keyword">interface</span> VNode

<span class="token annotation builtin">@JsModule</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"virtual-dom/h"</span></span><span class="token punctuation">)</span>
<span class="token annotation builtin">@JsNonModule</span>
<span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">h</span><span class="token punctuation">(</span>selector<span class="token operator">:</span> String<span class="token punctuation">,</span> properties<span class="token operator">:</span> Json <span class="token operator">=</span> definedExternally<span class="token punctuation">,</span> children<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token keyword">dynamic</span><span class="token operator">></span> <span class="token operator">=</span> definedExternally<span class="token punctuation">)</span><span class="token operator">:</span> VNode

<span class="token annotation builtin">@JsModule</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"virtual-dom/create-element"</span></span><span class="token punctuation">)</span>
<span class="token annotation builtin">@JsNonModule</span>
<span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">createElement</span><span class="token punctuation">(</span>vNode<span class="token operator">:</span> VNode<span class="token punctuation">)</span><span class="token operator">:</span> Element

<span class="token keyword">external</span> <span class="token keyword">interface</span> Patches

<span class="token annotation builtin">@JsModule</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"virtual-dom/diff"</span></span><span class="token punctuation">)</span>
<span class="token annotation builtin">@JsNonModule</span>
<span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">diff</span><span class="token punctuation">(</span>a<span class="token operator">:</span> VNode<span class="token punctuation">,</span> b<span class="token operator">:</span> VNode<span class="token punctuation">)</span><span class="token operator">:</span> Patches

<span class="token annotation builtin">@JsModule</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"virtual-dom/patch"</span></span><span class="token punctuation">)</span>
<span class="token annotation builtin">@JsNonModule</span>
<span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">patch</span><span class="token punctuation">(</span>element<span class="token operator">:</span> Element<span class="token punctuation">,</span> patches<span class="token operator">:</span> Patches<span class="token punctuation">)</span><span class="token operator">:</span> Element</code></pre></div>
<p>and some accompanying extensions to make our life easier:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> Definition<span class="token punctuation">.</span><span class="token function">toVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">=</span> <span class="token function">VirtualDomWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> writer <span class="token operator">-></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>result<span class="token operator">!!</span>

<span class="token keyword">fun</span> VNode<span class="token punctuation">.</span><span class="token function">toElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> VNode<span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>other<span class="token operator">:</span> VNode<span class="token punctuation">)</span><span class="token operator">:</span> Patches <span class="token operator">=</span> externals<span class="token punctuation">.</span>virtualDom<span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">)</span>
<span class="token keyword">fun</span> Element<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>patches<span class="token operator">:</span> Patches<span class="token punctuation">)</span><span class="token operator">:</span> Element <span class="token operator">=</span> externals<span class="token punctuation">.</span>virtualDom<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> patches<span class="token punctuation">)</span></code></pre></div>
<p>And now, with the magic of a virtual-dom we can make an easy rotating SVG:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> currentAngle <span class="token operator">=</span> <span class="token number">0.0</span>
<span class="token keyword">var</span> tree <span class="token operator">=</span> <span class="token function">demo</span><span class="token punctuation">(</span>currentAngle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> element <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">toElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>

window<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    currentAngle <span class="token operator">+=</span> <span class="token number">0.6</span>
    currentAngle <span class="token operator">%=</span> <span class="token number">360.0</span>
    <span class="token keyword">val</span> newTree <span class="token operator">=</span> <span class="token function">demo</span><span class="token punctuation">(</span>currentAngle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> patches <span class="token operator">=</span> newTree<span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>
    element <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>patches<span class="token punctuation">)</span>
    tree <span class="token operator">=</span> newTree
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span></code></pre></div>
<p>and this results in:</p>
<p><img src="/static/svg-rotation-fe9822589cd104d89d422fdd80e2ceba.gif" alt="SVG&#x27;s rotating"></p>
<h2 id="closing-remarks">Closing remarks</h2>
<p>So far I am pretty happy with the results, but there are some caveats of course:</p>
<ul>
<li>No escaping at this moment</li>
<li>No support for events</li>
</ul>
<p>However, it only took me a short time to come up with something relatively functional in common code, and with heavy flexibility. For me this blog post served more as a brain-dump than a very thorough blog. However, I am always open to questions. So contact me via <a href="mailto:info@avwie.nl">e-mail</a>, Twitter <a href="https://twitter.com/avwie">@avwie</a>, or look at <a href="https://github.com/avwie/scribbles/tree/main/kotlin/dom">my repository of the coding examples</a>.</p></div></div><div class="border-top border-light py-2"><div class="container-lg text-muted fw-light text-center" style="font-size:0.8em"><small>Build <!-- -->2ee78ad<!-- --> - <!-- -->2022-04-09T05:51:03.000Z</small></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YZ9NCTW594"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YZ9NCTW594', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/dom-dsl-in-kotlin";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-9887230afd096a67a0dc.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-979f3fd18ed5c2e808f6.js"],"component---src-templates-post-js":["/component---src-templates-post-js-881b6afcff1906b380f8.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-881b6afcff1906b380f8.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-c84cd9785c086ddb17fc.js" async=""></script><script src="/app-9887230afd096a67a0dc.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-5b944b32a8cd6d0186fb.js" async=""></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script></body></html>