<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><title>avwie&#x27;s programming blog</title><style data-href="/styles.e5d39825b48065011f83.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap);:root{--primary-color:#3a6ea5;--primary-light:#c6d8eb;--primary-dark:#004e98;--secondary-color:#ff6b6b;--text-color:#222;--text-light:#555;--background-color:#f9f9f9;--card-background:#fff;--border-color:#e0e0e0;--shadow-color:rgba(0,0,0,.05);--code-background:#f5f7f9;--transition-speed:0.3s;--container-width:800px;--spacing-xs:0.25rem;--spacing-sm:0.5rem;--spacing-md:1rem;--spacing-lg:2rem;--spacing-xl:3rem;--border-radius:8px}*{box-sizing:border-box}body{background-color:var(--background-color);color:var(--text-color);font-family:Open Sans,sans-serif;font-size:16px;font-weight:300;line-height:1.8;margin:0;transition:background-color var(--transition-speed),color var(--transition-speed)}body code[class*=language-],body pre[class*=language-]{word-wrap:normal;background:none;color:#111b27;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body code[class*=language-] ::selection,body code[class*=language-]::selection,body pre[class*=language-] ::selection,body pre[class*=language-]::selection{background:#8da1b9}body pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body :not(pre)>code[class*=language-],body pre[class*=language-]{background:#e3eaf2}body :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em .3em;white-space:normal}body .token.cdata,body .token.comment,body .token.doctype,body .token.prolog{color:#3c526d}body .token.punctuation{color:#111b27}body .token.delimiter.important,body .token.selector .parent,body .token.tag,body .token.tag .token.punctuation{color:#006d6d}body .token.attr-name,body .token.boolean,body .token.boolean.important,body .token.constant,body .token.number,body .token.selector .token.attribute{color:#755f00}body .token.class-name,body .token.key,body .token.parameter,body .token.property,body .token.property-access,body .token.variable{color:#005a8e}body .token.attr-value,body .token.color,body .token.inserted,body .token.selector .token.value,body .token.string,body .token.string .token.url-link{color:#116b00}body .token.builtin,body .token.keyword-array,body .token.package,body .token.regex{color:#af00af}body .token.function,body .token.selector .token.class,body .token.selector .token.id{color:#7c00aa}body .token.atrule .token.rule,body .token.combinator,body .token.keyword,body .token.operator,body .token.pseudo-class,body .token.pseudo-element,body .token.selector,body .token.unit{color:#a04900}body .token.deleted,body .token.important{color:#c22f2e}body .token.keyword-this,body .token.this{color:#005a8e}body .token.bold,body .token.important,body .token.keyword-this,body .token.this{font-weight:700}body .token.delimiter.important{font-weight:inherit}body .token.italic{font-style:italic}body .token.entity{cursor:help}body .language-markdown .token.title,body .language-markdown .token.title .token.punctuation{color:#005a8e;font-weight:700}body .language-markdown .token.blockquote.punctuation{color:#af00af}body .language-markdown .token.code{color:#006d6d}body .language-markdown .token.hr.punctuation{color:#005a8e}body .language-markdown .token.url>.token.content{color:#116b00}body .language-markdown .token.url-link{color:#755f00}body .language-markdown .token.list.punctuation{color:#af00af}body .language-json .token.operator,body .language-markdown .token.table-header{color:#111b27}body .language-scss .token.variable{color:#006d6d}body .token.cr:before,body .token.lf:before,body .token.space:before,body .token.tab:not(:empty):before{color:#3c526d}body div.code-toolbar>.toolbar a,body div.code-toolbar>.toolbar button{background:#005a8e;color:#e3eaf2}body div.code-toolbar>.toolbar a:focus,body div.code-toolbar>.toolbar a:hover,body div.code-toolbar>.toolbar button:focus,body div.code-toolbar>.toolbar button:hover{background:rgba(0,90,142,.855);color:#e3eaf2;text-decoration:none}body div.code-toolbar>.toolbar span,body div.code-toolbar>.toolbar span:focus,body div.code-toolbar>.toolbar span:hover{background:#3c526d;color:#e3eaf2}body .line-highlight{background:rgba(141,161,185,.184);background:linear-gradient(90deg,rgba(141,161,185,.184) 70%,rgba(141,161,185,.145))}body .line-highlight:before,body .line-highlight[data-end]:after{background-color:#3c526d;box-shadow:0 1px #8da1b9;color:#e3eaf2}body pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(60,82,109,.122)}body .line-numbers .line-numbers-rows{background:rgba(208,218,231,.478);border-right:1px solid rgba(141,161,185,.478)}body .line-numbers-rows>span:before{color:rgba(60,82,109,.855)}body .rainbow-braces .token.punctuation.brace-level-1,body .rainbow-braces .token.punctuation.brace-level-5,body .rainbow-braces .token.punctuation.brace-level-9{color:#755f00}body .rainbow-braces .token.punctuation.brace-level-10,body .rainbow-braces .token.punctuation.brace-level-2,body .rainbow-braces .token.punctuation.brace-level-6{color:#af00af}body .rainbow-braces .token.punctuation.brace-level-11,body .rainbow-braces .token.punctuation.brace-level-3,body .rainbow-braces .token.punctuation.brace-level-7{color:#005a8e}body .rainbow-braces .token.punctuation.brace-level-12,body .rainbow-braces .token.punctuation.brace-level-4,body .rainbow-braces .token.punctuation.brace-level-8{color:#7c00aa}body pre.diff-highlight>code .token.deleted:not(.prefix),body pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(194,47,46,.122)}body pre.diff-highlight>code .token.inserted:not(.prefix),body pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(17,107,0,.122)}body .command-line-prompt{border-right:1px solid rgba(141,161,185,.478)}body .command-line-prompt>span:before{color:rgba(60,82,109,.855)}body h1,body h2,body h3,body h4,body h5,body h6{color:var(--primary-dark);font-family:Lora,serif;font-weight:500;line-height:1.3;margin-bottom:var(--spacing-md);margin-top:var(--spacing-lg)}body h1{font-size:2.5rem;margin-top:var(--spacing-xl)}body h2{font-size:2rem}body h3{font-size:1.5rem}body p{margin-bottom:var(--spacing-md)}body a{color:var(--primary-color);text-decoration:none;transition:color var(--transition-speed)}body a:hover{color:var(--primary-dark);text-decoration:underline}body blockquote{background-color:var(--primary-light);border-left:4px solid var(--primary-color);border-radius:0 var(--border-radius) var(--border-radius) 0;color:var(--text-color);font-style:italic;margin:var(--spacing-lg) 0;padding:var(--spacing-md) var(--spacing-lg)}body blockquote p{margin:0}body nav{background-color:var(--primary-dark);box-shadow:0 2px 4px var(--shadow-color);padding:var(--spacing-md) 0;position:-webkit-sticky;position:sticky;top:0;width:100%;z-index:1000}body nav *{color:#fff}body nav>.container{align-items:center;display:flex;flex-direction:row;justify-content:space-between}body nav a{font-size:1.2rem;font-weight:600}body nav a:hover{opacity:.9;text-decoration:none}body nav .social{display:flex;flex-direction:row;gap:var(--spacing-md)}body nav .social a{align-items:center;display:flex;justify-content:center;transition:-webkit-transform var(--transition-speed);transition:transform var(--transition-speed);transition:transform var(--transition-speed),-webkit-transform var(--transition-speed)}body nav .social a:hover{-webkit-transform:scale(1.1);transform:scale(1.1)}body nav .social a.dark-mode{cursor:pointer}body nav .social img{height:24px;width:24px}body .container{margin:0 auto;max-width:var(--container-width);padding:0 var(--spacing-md);width:100%}body main.container{min-height:calc(100vh - 200px);padding-bottom:var(--spacing-xl);padding-top:var(--spacing-lg)}body .index>div{margin-bottom:var(--spacing-xl)}body .posts{display:grid;gap:var(--spacing-lg);grid-template-columns:1fr}@media(min-width:768px){body .posts{grid-template-columns:repeat(2,1fr)}}body .posts .post{background-color:var(--card-background);border-radius:var(--border-radius);box-shadow:0 4px 6px var(--shadow-color);display:flex;flex-direction:column;height:100%;padding:var(--spacing-lg);transition:box-shadow var(--transition-speed),-webkit-transform var(--transition-speed);transition:transform var(--transition-speed),box-shadow var(--transition-speed);transition:transform var(--transition-speed),box-shadow var(--transition-speed),-webkit-transform var(--transition-speed)}body .posts .post:hover{box-shadow:0 10px 15px var(--shadow-color);-webkit-transform:translateY(-5px);transform:translateY(-5px)}body .posts .post h2{font-size:1.5rem;margin-bottom:var(--spacing-sm);margin-top:0}body .posts .post p{margin:var(--spacing-xs) 0}body .posts .post .date,body .posts .post .reading-time{color:var(--text-light);font-size:.9rem;margin-bottom:var(--spacing-sm)}body .posts .post .excerpt{flex-grow:1;margin-bottom:var(--spacing-md)}body .posts .post a.read-more{display:inline-block;font-weight:600;padding:var(--spacing-xs) 0;position:relative}body .posts .post a.read-more:after{content:"â†’";margin-left:var(--spacing-xs);transition:-webkit-transform var(--transition-speed);transition:transform var(--transition-speed);transition:transform var(--transition-speed),-webkit-transform var(--transition-speed)}body .posts .post a.read-more:hover:after{-webkit-transform:translateX(4px);transform:translateX(4px)}body footer{border-top:1px solid var(--border-color);color:var(--text-light);font-size:.9rem;padding:var(--spacing-lg) 0;text-align:center}code[class*=language-],pre[class*=language-]{border-radius:var(--border-radius);font-family:Source Code Pro,monospace!important;font-size:.9rem!important;font-style:normal!important;font-weight:400!important;margin:var(--spacing-lg) 0}pre[class*=language-]{box-shadow:0 2px 4px var(--shadow-color);padding:var(--spacing-md)!important}body.dark{@import"https://fonts.googleapis.com/css2?family=Fira+Code&display=swap";--primary-color:#64b5f6;--primary-light:#2c3e50;--primary-dark:#1e88e5;--secondary-color:#ff7043;--text-color:#fff;--text-light:#ccc;--background-color:#121212;--card-background:#1e1e1e;--border-color:#333;--shadow-color:rgba(0,0,0,.2);--code-background:#2d2d2d}body.dark code[class*=language-],body.dark pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body.dark code[class*=language-] ::selection,body.dark code[class*=language-]::selection,body.dark pre[class*=language-] ::selection,body.dark pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}body.dark pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body.dark :not(pre)>code[class*=language-],body.dark pre[class*=language-]{background:#2b2b2b}body.dark :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}body.dark .token.cdata,body.dark .token.comment,body.dark .token.prolog{color:gray}body.dark .token.atrule,body.dark .token.boolean,body.dark .token.delimiter,body.dark .token.important,body.dark .token.keyword,body.dark .token.selector{color:#cc7832}body.dark .token.attr-name,body.dark .token.operator,body.dark .token.punctuation{color:#a9b7c6}body.dark .token.builtin,body.dark .token.doctype,body.dark .token.tag,body.dark .token.tag .punctuation{color:#e8bf6a}body.dark .token.entity,body.dark .token.number,body.dark .token.symbol{color:#6897bb}body.dark .token.constant,body.dark .token.property,body.dark .token.variable{color:#9876aa}body.dark .token.char,body.dark .token.string{color:#6a8759}body.dark .token.attr-value,body.dark .token.attr-value .punctuation{color:#a5c261}body.dark .token.attr-value .punctuation:first-child{color:#a9b7c6}body.dark .token.url{color:#287bde;text-decoration:underline}body.dark .token.function{color:#ffc66d}body.dark .token.regex{background:#364135}body.dark .token.bold{font-weight:700}body.dark .token.italic{font-style:italic}body.dark .token.inserted{background:#294436}body.dark .token.deleted{background:#484a4a}body.dark code.language-css .token.property,body.dark code.language-css .token.property+.token.punctuation{color:#a9b7c6}body.dark code.language-css .token.id,body.dark code.language-css .token.selector>.token.attribute,body.dark code.language-css .token.selector>.token.class,body.dark code.language-css .token.selector>.token.pseudo-class,body.dark code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body.dark blockquote{background-color:var(--primary-light);color:var(--text-color)}body.dark a{color:var(--primary-color)}body.dark a:hover{color:var(--primary-light)}body.dark .post{background-color:var(--card-background)}</style><meta name="generator" content="Gatsby 3.14.6"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="avwie&#x27;s programming blog" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-f31b4437165dabf76ed3.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-4e8c86bd5f82e31157fb.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-ef6357f687c91485d3ff.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-f4ba9efc66bcb0af9218.js"/><link as="fetch" rel="preload" href="/page-data/compositional-patterns-in-kotlin-part-1-delegation/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav><div class="container"><a href="/">@avwie&#x27;s programming blog</a><div class="social"><a title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a><a class="dark-mode"><img alt="dark-mode" width="24" height="24" src="/layout/dark-mode-48.png"/></a></div></div></nav><main class="container"><h1>Compositional Patterns in Kotlin Part 1 - Delegation</h1><h4>27 Feb, 2021</h4><div><p>Roughly speaking there are two ways to obtain polymorphic behavior in OOP languages, 'classical' inheritance and composition. There are clear benefits in either approach depending on the domain one is trying to model. So this post is not a rant about the drawbacks of inheritance, but more an evaluation of the benefits of composition in some domains. A lot has been written about both approaches, and their intended uses, but when speaking for myself I see clear benefit of inheritance when the domain is clearly described by a hierarchical tree, or the hierarchies are not very deep and diverse and there are not a lot of cross-cutting concerns. Animals are a typical example of a hierarchy that models pretty well into the inheritance paradigm. A typical drawback of deep inheritance hierarchies can be that they can be a little reluctant to change.</p>
<p>However, composition is beneficial when there is not a clear hierarchy and there are a lot of cross-cutting concerns. Think of game engines and all the elements there. A player has health, some sprite and some positional information associated with it, just like an enemy. However, a plant or a cloud are maybe just graphics and a position. Then an enemy and a player both can have some sort of weapon or attack method. However, a venomous plant on the other hand also should have some attack method. When trying to model this in a classical inheritance tree one gets stuck pretty fast.</p>
<p>Whereas inheritance is typically supported by the language in its syntax (think of <code class="language-text">class</code>, <code class="language-text">interface</code>, <code class="language-text">extends</code> <code class="language-text">implements</code> keywords in typical languages), and as such was a go-to method of modelling until a few years ago, not a lot of languages support composition natively as a language feature with keywords. Nevertheless, there is some change in that respect in recent years in languages to provide constructs for composition. Scala and Rust provide a trait system, C# has default interface implementation, Java has project Lombok which aims to provide a delegation system.</p>
<p>This post aims to show a few different methods of obtaining composition in <strong>Kotlin</strong>.</p>
<h2 id="the-delegation-pattern">The delegation pattern</h2>
<p>Kotlin has language support for the <a href="https://kotlinlang.org/docs/delegation.html">delegation pattern</a>. In short, it means that interfaces that a class wants to implement are actually implemented by an instance of another class that is part of the main class and the methods are <em>delegated</em> to this other class. For the outsider it looks as if the class implements the interface like it should, however under the hood all calls are delegated to another. </p>
<p>An important aspect to note here is is that the composition all takes place during the definition of the classes. In other words, it is static, or compile-time, composition and as such it is not possible to compose entities during runtime. However, this will come in the next post.</p>
<p>I think it is best shown via some code examples. Let's stay in the theme of the game example above.</p>
<h2 id="defining-the-components">Defining the components</h2>
<p>First we need to describe the components we want to have, lets model these as <code class="language-text">interfaces</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Health <span class="token punctuation">{</span>
    <span class="token keyword">val</span> health<span class="token operator">:</span> Int
    <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean

    <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Sprite <span class="token punctuation">{</span>
    <span class="token keyword">val</span> spriteData<span class="token operator">:</span> ByteArray
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Position <span class="token punctuation">{</span>
    <span class="token keyword">val</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Dynamics <span class="token operator">:</span> Position <span class="token punctuation">{</span>
    <span class="token keyword">val</span> mass<span class="token operator">:</span> Double
    <span class="token keyword">val</span> velocity<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span>
    <span class="token keyword">val</span> acceleration<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span>

    <span class="token keyword">fun</span> <span class="token function">applyForce</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">updateDynamics</span><span class="token punctuation">(</span>dt<span class="token operator">:</span> Double<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Drawable <span class="token operator">:</span> Sprite<span class="token punctuation">,</span> Position

<span class="token keyword">interface</span> Dangerous <span class="token punctuation">{</span>
    <span class="token keyword">val</span> damage<span class="token operator">:</span> Int

    <span class="token keyword">fun</span> <span class="token function">attack</span><span class="token punctuation">(</span>other<span class="token operator">:</span> Health<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>These interfaces clearly communicate their intent. In the <code class="language-text">Dangerous</code> interface the attack references some other entity which should have a <code class="language-text">Health</code> interface. We also combine interfaces to, <code class="language-text">Drawable</code> in this case, to show that if two interfaces are combined this can lead to new behavior.</p>
<p>I could have chosen to have the state variables be <code class="language-text">var</code>s and have reference implementations of the functions in the interfaces themselves, but I chose not to. The reason is that I only want to have the state variables be mutated by the methods inside the interfaces, to keep things tidy and controlled. However, you could go the other way, which would require less code in the long run with the cost of loosing track how state variables are mutated. This would result in a rewritten <code class="language-text">Health</code> interface like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Health <span class="token punctuation">{</span>
    <span class="token keyword">var</span> health<span class="token operator">:</span> Int
    <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> health <span class="token operator">&lt;=</span> <span class="token number">0</span>
    
    <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">-=</span> amount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="creating-the-default-implementations">Creating the default implementations</h2>
<p>We can now define default implementations for the interfaces, to be used later for the composition:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">HealthImpl</span><span class="token punctuation">(</span>initialHealth<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Health <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">var</span> health<span class="token operator">:</span> Int <span class="token operator">=</span> initialHealth
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> health <span class="token operator">&lt;=</span> <span class="token number">0</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">-=</span> amount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> spriteData<span class="token operator">:</span> ByteArray<span class="token punctuation">)</span><span class="token operator">:</span> Sprite

<span class="token keyword">class</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Position

<span class="token keyword">class</span> <span class="token function">DynamicsImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> mass<span class="token operator">:</span> Double<span class="token punctuation">,</span> initialPosition<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Dynamics <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">var</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span> <span class="token operator">=</span> initialPosition
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">var</span> velocity<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span> <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">var</span> acceleration<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span> <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">applyForce</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">)</span> <span class="token operator">=</span> amount
        acceleration <span class="token operator">=</span> ax <span class="token operator">+</span> fx <span class="token operator">/</span> mass <span class="token keyword">to</span> ay <span class="token operator">+</span> fy <span class="token operator">/</span> mass
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">updateDynamics</span><span class="token punctuation">(</span>dt<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>vx<span class="token punctuation">,</span> vy<span class="token punctuation">)</span> <span class="token operator">=</span> velocity
        <span class="token keyword">val</span> <span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span> <span class="token operator">=</span> position
        
        <span class="token comment">// this is clearly naive, since this is not deterministic, however... it serves the purpose for this post</span>
        velocity <span class="token operator">=</span> vx <span class="token operator">+</span> ax <span class="token operator">*</span> dt <span class="token keyword">to</span> vy <span class="token operator">+</span> ay <span class="token operator">*</span> dt
        position <span class="token operator">=</span> sx <span class="token operator">+</span> vx <span class="token operator">*</span> dt <span class="token keyword">to</span> sy <span class="token operator">+</span> vy <span class="token operator">*</span> dt
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Dangerous <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">attack</span><span class="token punctuation">(</span>other<span class="token operator">:</span> Health<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        other<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>What is clearly seen here is that the reference implementations contain all the code related to their respective domain. This makes it extremely easy to test them since they are simple. Setting up unit tests for them is a breeze and that also means that you can be very certain that any class that uses any of the well-tested reference implementations will behave as it should.</p>
<h2 id="composing-classes">Composing classes</h2>
<p>Using the reference implementations we can now construct our classes using the delegation pattern. What we immediately notice is that the constructor becomes quite big. However, we can mitigate this by just defining methods on the <code class="language-text">companion object</code> which makes the construction of a class easier, by using the reference implementations.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Player</span><span class="token punctuation">(</span> <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> healthImpl<span class="token operator">:</span> Health<span class="token punctuation">,</span> spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> dynamicsImpl<span class="token operator">:</span> Dynamics<span class="token punctuation">,</span> dangerousImpl<span class="token operator">:</span> Dangerous<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Health <span class="token keyword">by</span> healthImpl<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Dynamics <span class="token keyword">by</span> dynamicsImpl<span class="token punctuation">,</span> Dangerous <span class="token keyword">by</span> dangerousImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// just for mocking purposes</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> health<span class="token operator">:</span> Int<span class="token punctuation">,</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">,</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Player <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Player</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">HealthImpl</span><span class="token punctuation">(</span>health<span class="token punctuation">)</span><span class="token punctuation">,</span> sprite<span class="token punctuation">,</span> <span class="token function">DynamicsImpl</span><span class="token punctuation">(</span><span class="token number">74.0</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Orc</span><span class="token punctuation">(</span>healthImpl<span class="token operator">:</span> Health<span class="token punctuation">,</span> spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> dynamicsImpl<span class="token operator">:</span> Dynamics<span class="token punctuation">,</span> dangerousImpl<span class="token operator">:</span> Dangerous<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Health <span class="token keyword">by</span> healthImpl<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Dynamics <span class="token keyword">by</span> dynamicsImpl<span class="token punctuation">,</span> Dangerous <span class="token keyword">by</span> dangerousImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// just for mocking purposes</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">,</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Orc <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Orc</span><span class="token punctuation">(</span><span class="token function">HealthImpl</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sprite<span class="token punctuation">,</span> <span class="token function">DynamicsImpl</span><span class="token punctuation">(</span><span class="token number">120.0</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Tree</span><span class="token punctuation">(</span>spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> positionImpl<span class="token operator">:</span> PositionImpl<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Position <span class="token keyword">by</span> positionImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// just for mocking purposes</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Tree <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Tree</span><span class="token punctuation">(</span>sprite<span class="token punctuation">,</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">VenomousPlant</span><span class="token punctuation">(</span>spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> positionImpl<span class="token operator">:</span> PositionImpl<span class="token punctuation">,</span> dangerousImpl<span class="token operator">:</span> Dangerous<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Position <span class="token keyword">by</span> positionImpl<span class="token punctuation">,</span> Dangerous <span class="token keyword">by</span> dangerousImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">,</span> damage<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> VenomousPlant <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">VenomousPlant</span><span class="token punctuation">(</span>sprite<span class="token punctuation">,</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Okay, that was quite some code, but the implications are clear. We are constructing classes by combining reference implementations for the interfaces we want to implement by leveraging the Kotlin-specific <code class="language-text">[interface] by [implementation]</code> keyword. Whats even more interesting is that we implement <code class="language-text">Drawable</code> by specifying implementations for the <code class="language-text">Sprite</code> and <code class="language-text">Position</code> interfaces, even though <code class="language-text">Orc</code> and <code class="language-text">Player</code> both implement the <code class="language-text">Position</code> interface again via the <code class="language-text">Dynamics</code> interface.  </p>
<h2 id="constructing-instances">Constructing instances</h2>
<p>It is now quite a breeze to instantiate classes:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// constructing instances</span>
<span class="token keyword">val</span> player <span class="token operator">=</span> Player<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Frodo"</span></span><span class="token punctuation">,</span> health <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> position <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span> damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> orc <span class="token operator">=</span> Orc<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> tree <span class="token operator">=</span> Tree<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">15.0</span> <span class="token keyword">to</span> <span class="token number">25.0</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> poisonIvy <span class="token operator">=</span> VenomousPlant<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">8.0</span> <span class="token keyword">to</span> <span class="token number">11.0</span><span class="token punctuation">,</span> damage <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> entities <span class="token operator">:</span> List<span class="token operator">&lt;</span>Any<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> orc<span class="token punctuation">,</span> tree<span class="token punctuation">,</span> poisonIvy<span class="token punctuation">)</span>

<span class="token comment">// have them interact</span>
player<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span>orc<span class="token punctuation">)</span>
orc<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span>
poisonIvy<span class="token punctuation">.</span><span class="token function">attack</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span>
<span class="token comment">// player.attack(tree) &lt;- does not compile, since tree does not have a Health component</span>

<span class="token function">println</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token comment">// prints Pair(15.0, 25.0)</span>

<span class="token comment">// update all dynamics</span>
entities<span class="token punctuation">.</span>filterIsInstance<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> dynamics <span class="token operator">-></span> dynamics<span class="token punctuation">.</span><span class="token function">updateDynamics</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token comment">// draw them</span>
entities<span class="token punctuation">.</span>filterIsInstance<span class="token operator">&lt;</span>Drawable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foreach</span> <span class="token punctuation">{</span> drawable <span class="token operator">-></span>
    screen<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>drawable<span class="token punctuation">.</span>position<span class="token punctuation">,</span> drawable<span class="token punctuation">.</span>spriteData<span class="token punctuation">)</span> 
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen the actual code becomes quite clear, <em>and</em>, the invariants are enforced by the compiler. It is impossible to have a <code class="language-text">Player</code> attack a <code class="language-text">Tree</code>. We can easily iterate over the cross-cutting concerns and process, which is shown in the cases of <code class="language-text">Dynamics</code> and <code class="language-text">Drawable</code>.</p>
<h2 id="extending-the-model">Extending the model</h2>
<p>One of the clear benefits of the compositional model is that it is pretty easy to extend it. Imagine there are some entities in the world that are edible and by eating you gain health. In the traditional inheritance tree one would add interface <code class="language-text">Edible</code> at all the places this is required and implement those. However, we can easily extend it by creating a new <code class="language-text">Interface</code>, building a reference implementation <em>and</em> adding the reference implementation to the concrete classes which require those.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Edible <span class="token punctuation">{</span>
    <span class="token keyword">val</span> nutritionalValue<span class="token operator">:</span> Int
<span class="token punctuation">}</span>

<span class="token comment">// and we modify Health</span>
<span class="token keyword">interface</span> Health <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">fun</span> <span class="token function">eat</span><span class="token punctuation">(</span>edible<span class="token operator">:</span> Edible<span class="token punctuation">)</span> <span class="token comment">// this one is added</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">EdibleImpl</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> nutritionalValue<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Edible

<span class="token keyword">class</span> <span class="token function">HealthImpl</span><span class="token punctuation">(</span>initialHealth<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Health <span class="token punctuation">{</span>
    <span class="token comment">// ... </span>
    <span class="token comment">// the eat function is implemented</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">eat</span><span class="token punctuation">(</span>edible<span class="token operator">:</span> Edible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">+=</span> edible<span class="token punctuation">.</span>nutritionalValue
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Potato</span><span class="token punctuation">(</span>spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span> positionImpl<span class="token operator">:</span> Position<span class="token punctuation">,</span> edibleImpl<span class="token operator">:</span> EdibleImpl<span class="token punctuation">)</span><span class="token operator">:</span>
    Drawable<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Position <span class="token keyword">by</span> positionImpl<span class="token punctuation">,</span> Edible <span class="token keyword">by</span> edibleImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">fun</span> <span class="token function">new</span><span class="token punctuation">(</span>nutritionalValue<span class="token operator">:</span> Int<span class="token punctuation">,</span> position<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Potato <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Potato</span><span class="token punctuation">(</span>sprite<span class="token punctuation">,</span> <span class="token function">PositionImpl</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">EdibleImpl</span><span class="token punctuation">(</span>nutritionalValue<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// and using it is easy</span>
<span class="token keyword">val</span> food <span class="token operator">=</span> Potato<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">3.0</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span>food<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2 id="fun-with-extensions">Fun with extensions</h2>
<p>One of the cool features of Kotlin is the ability to add <a href="https://kotlinlang.org/docs/extensions.html">extensions</a>. This is a way to extend the behavior of certain types with extra functions or values without modifying the original code. </p>
<p>Imagine we want to have a Berserk function. When  <code class="language-text">health &lt;= 10</code> any player can go berserk and do double damage. This requires a class to implement both <code class="language-text">Health</code> and <code class="language-text">Dangerous</code>. To do this with extensions one can follow this approach.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// Can be in any file. Typically I place it in a subpackage called 'extensions' to keep it clean.</span>
<span class="token keyword">val</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T<span class="token punctuation">.</span>isBerserk <span class="token operator">:</span> Boolean <span class="token keyword">where</span> T <span class="token operator">:</span> Health<span class="token punctuation">,</span> T <span class="token operator">:</span> Dangerous <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isDead
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T<span class="token punctuation">.</span><span class="token function">berserkAttack</span><span class="token punctuation">(</span>enemy<span class="token operator">:</span> Health<span class="token punctuation">)</span> <span class="token keyword">where</span> T <span class="token operator">:</span> Health<span class="token punctuation">,</span> T <span class="token operator">:</span> Dangerous <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isBerserk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        enemy<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>damage <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        enemy<span class="token punctuation">.</span><span class="token function">damage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>damage<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// and in your game code:</span>
<span class="token keyword">val</span> berserkPlayer <span class="token operator">=</span> Player<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Almost dead"</span></span><span class="token punctuation">,</span> health <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> position <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span> damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> unfortunateOrc <span class="token operator">=</span> Orc<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>position <span class="token operator">=</span> <span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  damage <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>

<span class="token function">println</span><span class="token punctuation">(</span>unfortunateOrc<span class="token punctuation">.</span>health<span class="token punctuation">)</span> <span class="token comment">// prints 150</span>
berserkPlayer<span class="token punctuation">.</span><span class="token function">berserkAttack</span><span class="token punctuation">(</span>unfortunateOrc<span class="token punctuation">)</span>
<span class="token function">println</span><span class="token punctuation">(</span>unfortunateOrc<span class="token punctuation">.</span>health<span class="token punctuation">)</span> <span class="token comment">// prints 90</span></code></pre></div>
<p>By leveraging the granularity of the interfaces we have defined we have the ability to add very specific behavior based on combinations of these interfaces. This is exactly something you would expect from a system with a high degree of composability.</p>
<h2 id="constructing-instances-with-the-builder-pattern">Constructing instances with the builder pattern</h2>
<p>We used a companion object to create new instances. This works pretty well, but when the entities will have a lot of components these companion functions will become pretty large. Therefore, an alternative is to go to a builder pattern and have a separate class manage for us the building of the instance. Kotlin assists here as well in creating a nice API by providing us with the language feature: <a href="https://kotlinlang.org/docs/lambdas.html#function-literals-with-receiver">Function literals with a receiver</a>. Using this feature we can pass a <code class="language-text">lambda</code> function which specifies what the <code class="language-text">this</code> should be in scope of that function. </p>
<p>Let me elaborate by first defining some helper class and interface;</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Builder<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> T
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> BuilderProvider<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> B <span class="token operator">:</span> Builder<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> B
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token punctuation">,</span> B <span class="token operator">:</span> Builder<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span> <span class="token function">build</span><span class="token punctuation">(</span>provider<span class="token operator">:</span> BuilderProvider<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> B<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> B<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token punctuation">{</span>
    <span class="token keyword">val</span> builder <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">block</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Well, this certainly looks convoluted. Bear with me when I show you the implementation for <code class="language-text">Player</code> and I hope it becomes a little more clear:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Player</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    healthImpl<span class="token operator">:</span> Health<span class="token punctuation">,</span>
    spriteImpl<span class="token operator">:</span> Sprite<span class="token punctuation">,</span>
    dynamicsImpl<span class="token operator">:</span> Dynamics<span class="token punctuation">,</span>
    dangerousImpl<span class="token operator">:</span> Dangerous
<span class="token punctuation">)</span> <span class="token operator">:</span> Drawable<span class="token punctuation">,</span> Health <span class="token keyword">by</span> healthImpl<span class="token punctuation">,</span> Sprite <span class="token keyword">by</span> spriteImpl<span class="token punctuation">,</span> Dynamics <span class="token keyword">by</span> dynamicsImpl<span class="token punctuation">,</span> Dangerous <span class="token keyword">by</span> dangerousImpl <span class="token punctuation">{</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token operator">:</span> BuilderProvider<span class="token operator">&lt;</span>Player<span class="token punctuation">,</span> PlayerBuilder<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PlayerBuilder <span class="token operator">=</span> <span class="token function">PlayerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> PlayerBuilder <span class="token operator">:</span> EntityBuilder<span class="token operator">&lt;</span>Player<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sprite <span class="token operator">=</span> <span class="token function">SpriteImpl</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">""</span></span>
    <span class="token keyword">var</span> health <span class="token operator">=</span> <span class="token number">100</span>
    <span class="token keyword">var</span> damage <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">var</span> mass <span class="token operator">=</span> <span class="token number">80.0</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Player <span class="token operator">=</span>
        <span class="token function">Player</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">HealthImpl</span><span class="token punctuation">(</span>health<span class="token punctuation">)</span><span class="token punctuation">,</span> sprite<span class="token punctuation">,</span> <span class="token function">DynamicsImpl</span><span class="token punctuation">(</span>mass<span class="token punctuation">,</span> x <span class="token keyword">to</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DangerousImpl</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We now have a companion object on <code class="language-text">Player</code> that implements <code class="language-text">EntityBuilderProvider</code> and giving us a <code class="language-text">PlayerBuilder</code> (which implements <code class="language-text">Builder&lt;Player></code>) back. With the help of the <code class="language-text">build()</code> helper function above it is now possible to create a type-safe instantiation of the class in an easier API.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">build</span><span class="token punctuation">(</span>Player<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// [this] is of type PlayerBuilder</span>
    name <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"Beeblebrox"</span></span>
    health <span class="token operator">=</span> <span class="token number">120</span>

    x <span class="token operator">=</span> <span class="token number">3.0</span>
    y <span class="token operator">=</span> <span class="token number">4.0</span>
<span class="token punctuation">}</span></code></pre></div>
<p>So what is exactly happening? The Kotlin type-inference does a lot of work for us to make the API nice to work with. But let's go through it step by step:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">build</span><span class="token punctuation">(</span>Player<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//.... }</span>

<span class="token comment">// this can be rewritten as</span>
<span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">build</span><span class="token punctuation">(</span>Player<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// .... })</span>

<span class="token comment">// so that means that:</span>
Player <span class="token operator">=</span> EntityBuilderProvider
block <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">// ... })</span>

<span class="token comment">// and in `build` the following happens</span>
<span class="token keyword">val</span> builder <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// which is an instance of PlayerBuilder</span>
<span class="token function">block</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span> <span class="token comment">// the block is run, with PlayerBuilder as the receiver, meaning that, inside the block-scope, `this` refers to the instance of PlayerBuilder</span>
<span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// the PlayerBuilder.build() method returns a Player and the builder is complete</span></code></pre></div>
<p>This looks quite convoluted in order to create a simple instance of a class. However, when entities become more and more complicated or accumulate more components which might even be optional, then the builder patterns takes care of the construction of the entity whilst the entity itself is more concerned with the entity itself.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This concludes Part 1 on Compositional Patterns in Kotlin. This is a compositional pattern that allows for compile-time, typesafe, composition of classes. In <a href="/compositional-patterns-in-kotlin-part-2-component-model">Part 2</a> will focus on <em>runtime</em> composition, while still keeping type-safety <em>and</em> without reflection. One of the ways to obtain that is to go to a <em>component-based architecture</em>. This is a first step to a different way of handling your domain model. As I said before, this is not always the best way, just like inheritance trees aren't, but it is <em>a</em> way. Experiment and try and see where it fits your needs.</p>
<p>This was my <em>first ever</em> blog post I have written, and I thoroughly enjoyed it. However, by learning and making mistakes you improve. I am very interested in your critique, or questions. So contact me via <a href="mailto:info@avwie.nl">e-mail</a>, Twitter <a href="https://twitter.com/avwie">@avwie</a>, or at <a href="https://github.com/avwie/kotlin-blog">my repository of the coding examples</a>.</p></div></main><footer class="container"><p>Build <!-- -->565bf29<!-- --> - <!-- -->2025-05-10T12:38:42.000Z</p></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YZ9NCTW594"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YZ9NCTW594', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/compositional-patterns-in-kotlin-part-1-delegation";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-4e8c86bd5f82e31157fb.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-f2b90683571a7299fa82.js"],"component---src-templates-post-js":["/component---src-templates-post-js-f4ba9efc66bcb0af9218.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-f4ba9efc66bcb0af9218.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-ef6357f687c91485d3ff.js" async=""></script><script src="/app-4e8c86bd5f82e31157fb.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-f31b4437165dabf76ed3.js" async=""></script></body></html>