<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"/><title>avwie&#x27;s programming blog</title><style data-href="/styles.f842382f92405a0f4c11.css" id="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;700&display=swap);code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}body{font-family:Source Sans Pro,sans-serif}.markdown h1,.markdown h2{text-decoration:underline}.markdown h1,.markdown h2,.markdown h3,.markdown h4,.markdown h5,.markdown h6{margin-top:1em}.markdown strong{text-decoration:underline}.markdown code,.markdown pre{font-size:.9em!important}</style><meta name="generator" content="Gatsby 2.32.4"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link as="script" rel="preload" href="/webpack-runtime-5791cf65c24e8dd043fa.js"/><link as="script" rel="preload" href="/framework-3e6dec6139dadaa7d0c7.js"/><link as="script" rel="preload" href="/styles-9411612e31e4f14527d1.js"/><link as="script" rel="preload" href="/app-f6430cfe525eeb8f856c.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-80248c76230bced4d529.js"/><link as="fetch" rel="preload" href="/page-data/compositional-patterns-in-kotlin-part-2-component-model/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="navbar navbar-dark bg-dark"><div class="container-lg d-flex"><span class="navbar-brand mt-2 mb-2 h1"><a class="text-decoration-none text-white" href="/">@avwie&#x27;s programming blog</a></span><div class="text-light mx-3"><a class="px-2" title="Github" href="https://github.com/avwie" target="_blank" rel="noopener"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a class="px-2" title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noopener"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a class="px-2" title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noopener"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a></div></div></nav><div class="container-lg mt-4"><h1 class="text-decoration-underline fs-1 py-2">Compositional Patterns in Kotlin Part 2 - Component Model</h1><h4>06 Mar, 2021</h4><div class="markdown mb-4 fs-6 col-lg-9"><p>This is the second part of the post on compositional patterns in Kotlin and will focus on a dynamic, or runtime, composition. There are a few ways to obtain dynamic composition, all with their own advantages and drawbacks.</p>
<h2 id="component-model">Component Model</h2>
<p>It is very difficult to find a formal definition on the component model we use. If you search for Component Based Architecture, Component Architecture, Component Design, Entity Components, etc, you get a wide range of subjects, which all overlap. The one I am writing about here is very simple. It resembled the Entity Component Model, known in Unity, best. Please note that this means that it is just a 'small step' towards an Entity Component System, which is similar, but is a completely different way of looking at entities and components.</p>
<p>Roughly speaking, the Component Model is a model in which it is possible to add Components to an existing instance of a class during runtime.</p>
<p>Let's elaborate with an example.</p>
<h2 id="components-using-reflection">Components using Reflection</h2>
<p>One of the possibilities of the JVM, and therefore Kotlin as well, when compiled to the JVM, is that it is possible to use reflection. Using reflection it is quite trivial to implement a dynamic component system. Let us first define some component:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Component

<span class="token keyword">class</span> <span class="token function">Health</span><span class="token punctuation">(</span>initialAmount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">var</span> currentHealth <span class="token operator">=</span> initialAmount
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> currentHealth <span class="token operator">&lt;=</span> <span class="token number">0</span>

    <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentHealth <span class="token operator">-=</span> amount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> mass<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    sx0<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    sy0<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    vx0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    vy0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    ax0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    ay0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">var</span> position <span class="token operator">=</span> sx0 <span class="token keyword">to</span> sy0
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">var</span> velocity <span class="token operator">=</span> vx0 <span class="token keyword">to</span> vy0
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">var</span> acceleration <span class="token operator">=</span> ax0 <span class="token keyword">to</span> ay0
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">fun</span> <span class="token function">applyForce</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">)</span> <span class="token operator">=</span> amount
        acceleration <span class="token operator">=</span> ax <span class="token operator">+</span> fx <span class="token operator">/</span> mass <span class="token keyword">to</span> ay <span class="token operator">+</span> fy <span class="token operator">/</span> mass
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">updateDynamics</span><span class="token punctuation">(</span>dt<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>vx<span class="token punctuation">,</span> vy<span class="token punctuation">)</span> <span class="token operator">=</span> velocity
        <span class="token keyword">val</span> <span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span> <span class="token operator">=</span> position

        <span class="token comment">// this is clearly naive, since this is not deterministic, however... it serves the purpose for this post</span>
        velocity <span class="token operator">=</span> vx <span class="token operator">+</span> ax <span class="token operator">*</span> dt <span class="token keyword">to</span> vy <span class="token operator">+</span> ay <span class="token operator">*</span> dt
        position <span class="token operator">=</span> sx <span class="token operator">+</span> vx <span class="token operator">*</span> dt <span class="token keyword">to</span> sy <span class="token operator">+</span> vy <span class="token operator">*</span> dt
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The components are almost identical to the ones in Part 1, with the exception that they all extend the <code class="language-text">Component</code> interface.</p>
<p>It is now possible to define an interface for the way we want to set and retrieve components at runtime.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C <span class="token operator">:</span> Component<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>type<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span>
<span class="token punctuation">}</span></code></pre></div>
<p>What this interface gives us is a very simple way to set and retrieve a component. For the <code class="language-text">getComponent</code> function we fetch the component by getting the <code class="language-text">KClass</code> of the component type and enforcing that this can only be a <code class="language-text">KClass</code> of type <code class="language-text">C</code> which must implement <code class="language-text">Component</code> via the typebound <code class="language-text">C: Component</code>.</p>
<p>We can now have every class implement this interface when we require dynamic component behavior, but maybe it is better to once more use delegation again to define a reference implementation and delegate this behavior to that reference implementation.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> MapComponentHolder <span class="token operator">:</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> components <span class="token operator">=</span> mutableMapOf<span class="token operator">&lt;</span>KClass<span class="token operator">&lt;</span><span class="token keyword">out</span> Component<span class="token operator">></span><span class="token punctuation">,</span> Component<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        components<span class="token punctuation">[</span>component<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">]</span> <span class="token operator">=</span> component
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C <span class="token operator">:</span> Component<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>type<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> components<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> C
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token keyword">val</span> id<span class="token operator">:</span> Long<span class="token punctuation">,</span> <span class="token keyword">private</span> <span class="token keyword">val</span> components<span class="token operator">:</span> ComponentHolder <span class="token operator">=</span> <span class="token function">MapComponentHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    ComponentHolder <span class="token keyword">by</span> components</code></pre></div>
<p>We create a <code class="language-text">MapComponentHolder</code> which implements the <code class="language-text">ComponentHolder</code> interface by storing the <code class="language-text">KClass</code> of any component we save using <code class="language-text">setComponent</code>, using the <code class="language-text">::class</code> notation, in a map. In the retrieval phase you see that we can easily retrieve this component <em>and</em> cast it to the right type <code class="language-text">C</code>. Please note that we had to add the annotation <code class="language-text">@Suppress(&quot;UNCHECKED_CAST&quot;)</code> to the function because the Kotlin compiler is unsure if the result from fetching the <code class="language-text">KClass&lt;C&gt;</code> from the map is actually castable to <code class="language-text">C</code>, since the only thing the compiler knows about it is that it will return a value of type <code class="language-text">Component</code>, and not <code class="language-text">C</code>. However, we can be pretty sure that it is <code class="language-text">C</code> and therefore can cast it using the <code class="language-text">as?</code> keyword. This means it will return <code class="language-text">null</code> when it is not castable and <code class="language-text">C</code> when succesful.</p>
<p>Now we can use the delegation pattern again and mixin this implementation in an already existing class. I have a class called <code class="language-text">Entity</code> with only 1 parameter, <code class="language-text">id</code>, as an illustration purpose.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token keyword">val</span> id<span class="token operator">:</span> Long<span class="token punctuation">,</span> <span class="token keyword">private</span> <span class="token keyword">val</span> components<span class="token operator">:</span> ComponentHolder <span class="token operator">=</span> <span class="token function">MapComponentHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    ComponentHolder <span class="token keyword">by</span> components
    
<span class="token comment">// test code</span>
<span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Health<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>currentHealth<span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">2.0</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Dynamics<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span></code></pre></div>
<p>And as can be seen, we have dynamic, typesafe, compositional behavior. However, personally I don't really like the way I have to sprinkle <code class="language-text">::class</code> through my code (but that is purely personal), so we can improve it, a tiny bit, by creating an extension function:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span><span class="token keyword">reified</span> C <span class="token operator">:</span> Component<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>C<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// test code</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span>getComponent<span class="token operator">&lt;</span>Health<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>currentHealth<span class="token punctuation">)</span></code></pre></div>
<p>We use the fact that we can 'reify' type parameters in Kotlin in inline functions. Due to type erasure in the JVM this is normally not possible, however using <code class="language-text">reified</code> we basically let the compiler generate special inline functions for every type parameter we pass in this function.  </p>
<p>And voila, we have a very simple component model that can be mixed in for different classes and if needed a different implementation can be created that suits your needs. Using extension methods this can be improved upon to add extra behavior, e.g. a way of querying a class for multiple components and invoking a block on those when they are both not null. The latter can be done like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// more if you need them... however, 3 typically suits my needs</span>
<span class="token keyword">fun</span> <span class="token operator">&lt;</span>C1<span class="token punctuation">,</span> R<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>t1<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C1<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token punctuation">(</span>C1<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R<span class="token operator">?</span> <span class="token keyword">where</span> C1 <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">val</span> c1 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token function">block</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> R<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>t1<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C1<span class="token operator">></span><span class="token punctuation">,</span> t2<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C2<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token punctuation">(</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R<span class="token operator">?</span> 
<span class="token keyword">where</span> C1 <span class="token operator">:</span> Component<span class="token punctuation">,</span> C2 <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">val</span> c1 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> c2 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token function">block</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> R<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>t1<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C1<span class="token operator">></span><span class="token punctuation">,</span> t2<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C2<span class="token operator">></span><span class="token punctuation">,</span> t3<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C3<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token punctuation">(</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R<span class="token operator">?</span> 
<span class="token keyword">where</span> C1 <span class="token operator">:</span> Component<span class="token punctuation">,</span> C2 <span class="token operator">:</span> Component<span class="token punctuation">,</span> C3 <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">val</span> c1 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> c2 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> c3 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token function">block</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// test code</span>
<span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> monster <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">150.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> background <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> entities <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> monster<span class="token punctuation">,</span> background<span class="token punctuation">)</span>

<span class="token comment">// draw all entities</span>
entities<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> entity <span class="token operator">-></span>
    entity<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>Dynamics<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> Sprite<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> dynamics<span class="token punctuation">,</span> sprite <span class="token operator">-></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Drawing entity <span class="token interpolation"><span class="token delimiter variable">${</span>entity<span class="token punctuation">.</span>id<span class="token delimiter variable">}</span></span> on position x=<span class="token interpolation"><span class="token delimiter variable">${</span>dynamics<span class="token punctuation">.</span>position<span class="token punctuation">.</span>first<span class="token delimiter variable">}</span></span>, y=<span class="token interpolation"><span class="token delimiter variable">${</span>dynamics<span class="token punctuation">.</span>position<span class="token punctuation">.</span>second<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token operator">?:</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Entity <span class="token interpolation"><span class="token delimiter variable">${</span>entity<span class="token punctuation">.</span>id<span class="token delimiter variable">}</span></span> doesn't have the required components"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/*  Result:
    Drawing entity 1 on position x=5.0, y=2.0
    Drawing entity 2 on position x=10.0, y=-4.0
    Entity 3 doesn't have the required components
*/</span> </code></pre></div>
<h2 id="components-without-reflection">Components without reflection</h2>
<p>It isn't always possible to use reflection on the target platform, especially when working with Kotlin Multiplatform. Luckily Kotlin has a good typesystem and type-inference system which makes transforming the code above to a non-reflection variant pretty easy. It is clear we need some sort of typesafe key to store and retrieve our components. Let us define those as follows, including the rewritten <code class="language-text">ComponentHolder</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Key<span class="token operator">&lt;</span>C<span class="token operator">></span>

<span class="token keyword">interface</span> HasKey<span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>C<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> HasKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> MapComponentHolder <span class="token operator">:</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> components <span class="token operator">=</span> mutableMapOf<span class="token operator">&lt;</span>Key<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> Any<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> HasKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        components<span class="token punctuation">[</span>component<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> component
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> C
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen, they are nearly identical, except for the <code class="language-text">Key&lt;C&gt;</code> and <code class="language-text">HasKey&lt;C&gt;</code> construct. We only need to define the keys for the components like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">/* We keep Keys and Components in separate objects to avoid nameclashes */</span>
<span class="token keyword">object</span> Keys <span class="token punctuation">{</span>
    <span class="token keyword">object</span> Health <span class="token operator">:</span> Key<span class="token operator">&lt;</span>Components<span class="token punctuation">.</span>Health<span class="token operator">></span>
    <span class="token keyword">object</span> Sprite <span class="token operator">:</span> Key<span class="token operator">&lt;</span>Components<span class="token punctuation">.</span>Sprite<span class="token operator">></span>
    <span class="token keyword">object</span> Dynamics <span class="token operator">:</span> Key<span class="token operator">&lt;</span>Components<span class="token punctuation">.</span>Dynamics<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Components <span class="token punctuation">{</span>

    <span class="token keyword">class</span> <span class="token function">Health</span><span class="token punctuation">(</span>initialAmount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> HasKey<span class="token operator">&lt;</span>Health<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>Health<span class="token operator">></span> <span class="token operator">=</span> Keys<span class="token punctuation">.</span>Health
        <span class="token comment">/* rest is omitted, because it is identical */</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token keyword">val</span> spriteData<span class="token operator">:</span> ByteArray<span class="token punctuation">)</span> <span class="token operator">:</span> HasKey<span class="token operator">&lt;</span>Sprite<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>Sprite<span class="token operator">></span> <span class="token operator">=</span> Keys<span class="token punctuation">.</span>Sprite
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>
        <span class="token keyword">val</span> mass<span class="token operator">:</span> Double<span class="token punctuation">,</span>
        <span class="token comment">/* rest is omitted, because it is identical */</span>
    <span class="token punctuation">)</span> <span class="token operator">:</span> HasKey<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span> <span class="token operator">=</span> Keys<span class="token punctuation">.</span>Dynamics
        <span class="token comment">/* rest is omitted, because it is identical */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And also here, it is nearly identical. As you can expect, the resulting code to actually use it is also nearly identical:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>Components<span class="token punctuation">.</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>Components<span class="token punctuation">.</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Keys<span class="token punctuation">.</span>Health<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>currentHealth<span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">2.0</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Keys<span class="token punctuation">.</span>Dynamics<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span></code></pre></div>
<p>One of the big benefits of this approach is that you aren't tied to <code class="language-text">objects</code> as keys. Why not use a class and have multiple components for the same component-type, but a different key? For example, a <code class="language-text">Sprite</code> could be in the foreground, or in the background, but they can both be added to an <code class="language-text">Entity</code>. One could solve that by having 2 types of sprites, or some sort of <code class="language-text">SpriteSet</code> component. Those are all valid approaches, but below is another one:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">enum</span> <span class="token keyword">class</span> SpriteTypeEnum <span class="token punctuation">{</span>
    Background<span class="token punctuation">,</span>
    Foreground
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Keys <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// be sure to make Sprite a data class for automatic hashCode and equals implementations, needed for the map</span>
    <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token keyword">val</span> type<span class="token operator">:</span> SpriteTypeEnum<span class="token punctuation">)</span> <span class="token operator">:</span> Key<span class="token operator">&lt;</span>Components<span class="token punctuation">.</span>Sprite<span class="token operator">></span> 
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Components <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">class</span> <span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token keyword">val</span> spriteData<span class="token operator">:</span> ByteArray<span class="token punctuation">,</span> <span class="token keyword">val</span> type<span class="token operator">:</span> SpriteTypeEnum<span class="token punctuation">)</span> <span class="token operator">:</span> HasKey<span class="token operator">&lt;</span>Sprite<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key<span class="token operator">&lt;</span>Sprite<span class="token operator">></span> <span class="token operator">=</span> Keys<span class="token punctuation">.</span><span class="token function">Sprite</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// test code</span>
<span class="token keyword">val</span> world <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
world<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>Components<span class="token punctuation">.</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token string">"Foreground"</span><span class="token punctuation">.</span><span class="token function">encodeToByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SpriteTypeEnum<span class="token punctuation">.</span>Foreground<span class="token punctuation">)</span><span class="token punctuation">)</span>
world<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>Components<span class="token punctuation">.</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token string">"Background"</span><span class="token punctuation">.</span><span class="token function">encodeToByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SpriteTypeEnum<span class="token punctuation">.</span>Background<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"Foreground"</span><span class="token punctuation">,</span> world<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Keys<span class="token punctuation">.</span><span class="token function">Sprite</span><span class="token punctuation">(</span>SpriteTypeEnum<span class="token punctuation">.</span>Foreground<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>spriteData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">decodeToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"Background"</span><span class="token punctuation">,</span> world<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Keys<span class="token punctuation">.</span><span class="token function">Sprite</span><span class="token punctuation">(</span>SpriteTypeEnum<span class="token punctuation">.</span>Background<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>spriteData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">decodeToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>This concludes Part 2 on Compositional Patterns in Kotlin where we looked into a method with reflection, and a method without. Personally I'd favor the non-reflection version, since I'd like to keep my code as portable as possible without fixing myself to an underlying runtime, especially when a portable version is just as easy.</p>
<p>This was my second blog post I have written, and I thoroughly enjoyed it. However, by learning and making mistakes you improve. I am very interested in your critique, or questions. So contact me via <a href="mailto:info@avwie.nl">e-mail</a>, Twitter <a href="https://twitter.com/avwie">@avwie</a>, or at <a href="https://github.com/avwie/kotlin-blog">my repository of the coding examples</a>.</p></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/compositional-patterns-in-kotlin-part-2-component-model";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-38cce18603b1d20cac17.js"],"app":["/app-f6430cfe525eeb8f856c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-af84eba3d2a2bbe6e79c.js"],"component---src-pages-index-js":["/component---src-pages-index-js-1f0bf91de6534c5d4985.js"],"component---src-templates-post-js":["/component---src-templates-post-js-80248c76230bced4d529.js"]};/*]]>*/</script><script src="/polyfill-38cce18603b1d20cac17.js" nomodule=""></script><script src="/component---src-templates-post-js-80248c76230bced4d529.js" async=""></script><script src="/app-f6430cfe525eeb8f856c.js" async=""></script><script src="/styles-9411612e31e4f14527d1.js" async=""></script><script src="/framework-3e6dec6139dadaa7d0c7.js" async=""></script><script src="/webpack-runtime-5791cf65c24e8dd043fa.js" async=""></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script></body></html>