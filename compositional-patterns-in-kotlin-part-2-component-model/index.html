<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><title>avwie&#x27;s programming blog</title><style data-href="/styles.e5d39825b48065011f83.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap);:root{--primary-color:#3a6ea5;--primary-light:#c6d8eb;--primary-dark:#004e98;--secondary-color:#ff6b6b;--text-color:#222;--text-light:#555;--background-color:#f9f9f9;--card-background:#fff;--border-color:#e0e0e0;--shadow-color:rgba(0,0,0,.05);--code-background:#f5f7f9;--transition-speed:0.3s;--container-width:800px;--spacing-xs:0.25rem;--spacing-sm:0.5rem;--spacing-md:1rem;--spacing-lg:2rem;--spacing-xl:3rem;--border-radius:8px}*{box-sizing:border-box}body{background-color:var(--background-color);color:var(--text-color);font-family:Open Sans,sans-serif;font-size:16px;font-weight:300;line-height:1.8;margin:0;transition:background-color var(--transition-speed),color var(--transition-speed)}body code[class*=language-],body pre[class*=language-]{word-wrap:normal;background:none;color:#111b27;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body code[class*=language-] ::selection,body code[class*=language-]::selection,body pre[class*=language-] ::selection,body pre[class*=language-]::selection{background:#8da1b9}body pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body :not(pre)>code[class*=language-],body pre[class*=language-]{background:#e3eaf2}body :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em .3em;white-space:normal}body .token.cdata,body .token.comment,body .token.doctype,body .token.prolog{color:#3c526d}body .token.punctuation{color:#111b27}body .token.delimiter.important,body .token.selector .parent,body .token.tag,body .token.tag .token.punctuation{color:#006d6d}body .token.attr-name,body .token.boolean,body .token.boolean.important,body .token.constant,body .token.number,body .token.selector .token.attribute{color:#755f00}body .token.class-name,body .token.key,body .token.parameter,body .token.property,body .token.property-access,body .token.variable{color:#005a8e}body .token.attr-value,body .token.color,body .token.inserted,body .token.selector .token.value,body .token.string,body .token.string .token.url-link{color:#116b00}body .token.builtin,body .token.keyword-array,body .token.package,body .token.regex{color:#af00af}body .token.function,body .token.selector .token.class,body .token.selector .token.id{color:#7c00aa}body .token.atrule .token.rule,body .token.combinator,body .token.keyword,body .token.operator,body .token.pseudo-class,body .token.pseudo-element,body .token.selector,body .token.unit{color:#a04900}body .token.deleted,body .token.important{color:#c22f2e}body .token.keyword-this,body .token.this{color:#005a8e}body .token.bold,body .token.important,body .token.keyword-this,body .token.this{font-weight:700}body .token.delimiter.important{font-weight:inherit}body .token.italic{font-style:italic}body .token.entity{cursor:help}body .language-markdown .token.title,body .language-markdown .token.title .token.punctuation{color:#005a8e;font-weight:700}body .language-markdown .token.blockquote.punctuation{color:#af00af}body .language-markdown .token.code{color:#006d6d}body .language-markdown .token.hr.punctuation{color:#005a8e}body .language-markdown .token.url>.token.content{color:#116b00}body .language-markdown .token.url-link{color:#755f00}body .language-markdown .token.list.punctuation{color:#af00af}body .language-json .token.operator,body .language-markdown .token.table-header{color:#111b27}body .language-scss .token.variable{color:#006d6d}body .token.cr:before,body .token.lf:before,body .token.space:before,body .token.tab:not(:empty):before{color:#3c526d}body div.code-toolbar>.toolbar a,body div.code-toolbar>.toolbar button{background:#005a8e;color:#e3eaf2}body div.code-toolbar>.toolbar a:focus,body div.code-toolbar>.toolbar a:hover,body div.code-toolbar>.toolbar button:focus,body div.code-toolbar>.toolbar button:hover{background:rgba(0,90,142,.855);color:#e3eaf2;text-decoration:none}body div.code-toolbar>.toolbar span,body div.code-toolbar>.toolbar span:focus,body div.code-toolbar>.toolbar span:hover{background:#3c526d;color:#e3eaf2}body .line-highlight{background:rgba(141,161,185,.184);background:linear-gradient(90deg,rgba(141,161,185,.184) 70%,rgba(141,161,185,.145))}body .line-highlight:before,body .line-highlight[data-end]:after{background-color:#3c526d;box-shadow:0 1px #8da1b9;color:#e3eaf2}body pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(60,82,109,.122)}body .line-numbers .line-numbers-rows{background:rgba(208,218,231,.478);border-right:1px solid rgba(141,161,185,.478)}body .line-numbers-rows>span:before{color:rgba(60,82,109,.855)}body .rainbow-braces .token.punctuation.brace-level-1,body .rainbow-braces .token.punctuation.brace-level-5,body .rainbow-braces .token.punctuation.brace-level-9{color:#755f00}body .rainbow-braces .token.punctuation.brace-level-10,body .rainbow-braces .token.punctuation.brace-level-2,body .rainbow-braces .token.punctuation.brace-level-6{color:#af00af}body .rainbow-braces .token.punctuation.brace-level-11,body .rainbow-braces .token.punctuation.brace-level-3,body .rainbow-braces .token.punctuation.brace-level-7{color:#005a8e}body .rainbow-braces .token.punctuation.brace-level-12,body .rainbow-braces .token.punctuation.brace-level-4,body .rainbow-braces .token.punctuation.brace-level-8{color:#7c00aa}body pre.diff-highlight>code .token.deleted:not(.prefix),body pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(194,47,46,.122)}body pre.diff-highlight>code .token.inserted:not(.prefix),body pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(17,107,0,.122)}body .command-line-prompt{border-right:1px solid rgba(141,161,185,.478)}body .command-line-prompt>span:before{color:rgba(60,82,109,.855)}body h1,body h2,body h3,body h4,body h5,body h6{color:var(--primary-dark);font-family:Lora,serif;font-weight:500;line-height:1.3;margin-bottom:var(--spacing-md);margin-top:var(--spacing-lg)}body h1{font-size:2.5rem;margin-top:var(--spacing-xl)}body h2{font-size:2rem}body h3{font-size:1.5rem}body p{margin-bottom:var(--spacing-md)}body a{color:var(--primary-color);text-decoration:none;transition:color var(--transition-speed)}body a:hover{color:var(--primary-dark);text-decoration:underline}body blockquote{background-color:var(--primary-light);border-left:4px solid var(--primary-color);border-radius:0 var(--border-radius) var(--border-radius) 0;color:var(--text-color);font-style:italic;margin:var(--spacing-lg) 0;padding:var(--spacing-md) var(--spacing-lg)}body blockquote p{margin:0}body nav{background-color:var(--primary-dark);box-shadow:0 2px 4px var(--shadow-color);padding:var(--spacing-md) 0;position:-webkit-sticky;position:sticky;top:0;width:100%;z-index:1000}body nav *{color:#fff}body nav>.container{align-items:center;display:flex;flex-direction:row;justify-content:space-between}body nav a{font-size:1.2rem;font-weight:600}body nav a:hover{opacity:.9;text-decoration:none}body nav .social{display:flex;flex-direction:row;gap:var(--spacing-md)}body nav .social a{align-items:center;display:flex;justify-content:center;transition:-webkit-transform var(--transition-speed);transition:transform var(--transition-speed);transition:transform var(--transition-speed),-webkit-transform var(--transition-speed)}body nav .social a:hover{-webkit-transform:scale(1.1);transform:scale(1.1)}body nav .social a.dark-mode{cursor:pointer}body nav .social img{height:24px;width:24px}body .container{margin:0 auto;max-width:var(--container-width);padding:0 var(--spacing-md);width:100%}body main.container{min-height:calc(100vh - 200px);padding-bottom:var(--spacing-xl);padding-top:var(--spacing-lg)}body .index>div{margin-bottom:var(--spacing-xl)}body .posts{display:grid;gap:var(--spacing-lg);grid-template-columns:1fr}@media(min-width:768px){body .posts{grid-template-columns:repeat(2,1fr)}}body .posts .post{background-color:var(--card-background);border-radius:var(--border-radius);box-shadow:0 4px 6px var(--shadow-color);display:flex;flex-direction:column;height:100%;padding:var(--spacing-lg);transition:box-shadow var(--transition-speed),-webkit-transform var(--transition-speed);transition:transform var(--transition-speed),box-shadow var(--transition-speed);transition:transform var(--transition-speed),box-shadow var(--transition-speed),-webkit-transform var(--transition-speed)}body .posts .post:hover{box-shadow:0 10px 15px var(--shadow-color);-webkit-transform:translateY(-5px);transform:translateY(-5px)}body .posts .post h2{font-size:1.5rem;margin-bottom:var(--spacing-sm);margin-top:0}body .posts .post p{margin:var(--spacing-xs) 0}body .posts .post .date,body .posts .post .reading-time{color:var(--text-light);font-size:.9rem;margin-bottom:var(--spacing-sm)}body .posts .post .excerpt{flex-grow:1;margin-bottom:var(--spacing-md)}body .posts .post a.read-more{display:inline-block;font-weight:600;padding:var(--spacing-xs) 0;position:relative}body .posts .post a.read-more:after{content:"â†’";margin-left:var(--spacing-xs);transition:-webkit-transform var(--transition-speed);transition:transform var(--transition-speed);transition:transform var(--transition-speed),-webkit-transform var(--transition-speed)}body .posts .post a.read-more:hover:after{-webkit-transform:translateX(4px);transform:translateX(4px)}body footer{border-top:1px solid var(--border-color);color:var(--text-light);font-size:.9rem;padding:var(--spacing-lg) 0;text-align:center}code[class*=language-],pre[class*=language-]{border-radius:var(--border-radius);font-family:Source Code Pro,monospace!important;font-size:.9rem!important;font-style:normal!important;font-weight:400!important;margin:var(--spacing-lg) 0}pre[class*=language-]{box-shadow:0 2px 4px var(--shadow-color);padding:var(--spacing-md)!important}body.dark{@import"https://fonts.googleapis.com/css2?family=Fira+Code&display=swap";--primary-color:#64b5f6;--primary-light:#2c3e50;--primary-dark:#1e88e5;--secondary-color:#ff7043;--text-color:#fff;--text-light:#ccc;--background-color:#121212;--card-background:#1e1e1e;--border-color:#333;--shadow-color:rgba(0,0,0,.2);--code-background:#2d2d2d}body.dark code[class*=language-],body.dark pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body.dark code[class*=language-] ::selection,body.dark code[class*=language-]::selection,body.dark pre[class*=language-] ::selection,body.dark pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}body.dark pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body.dark :not(pre)>code[class*=language-],body.dark pre[class*=language-]{background:#2b2b2b}body.dark :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}body.dark .token.cdata,body.dark .token.comment,body.dark .token.prolog{color:gray}body.dark .token.atrule,body.dark .token.boolean,body.dark .token.delimiter,body.dark .token.important,body.dark .token.keyword,body.dark .token.selector{color:#cc7832}body.dark .token.attr-name,body.dark .token.operator,body.dark .token.punctuation{color:#a9b7c6}body.dark .token.builtin,body.dark .token.doctype,body.dark .token.tag,body.dark .token.tag .punctuation{color:#e8bf6a}body.dark .token.entity,body.dark .token.number,body.dark .token.symbol{color:#6897bb}body.dark .token.constant,body.dark .token.property,body.dark .token.variable{color:#9876aa}body.dark .token.char,body.dark .token.string{color:#6a8759}body.dark .token.attr-value,body.dark .token.attr-value .punctuation{color:#a5c261}body.dark .token.attr-value .punctuation:first-child{color:#a9b7c6}body.dark .token.url{color:#287bde;text-decoration:underline}body.dark .token.function{color:#ffc66d}body.dark .token.regex{background:#364135}body.dark .token.bold{font-weight:700}body.dark .token.italic{font-style:italic}body.dark .token.inserted{background:#294436}body.dark .token.deleted{background:#484a4a}body.dark code.language-css .token.property,body.dark code.language-css .token.property+.token.punctuation{color:#a9b7c6}body.dark code.language-css .token.id,body.dark code.language-css .token.selector>.token.attribute,body.dark code.language-css .token.selector>.token.class,body.dark code.language-css .token.selector>.token.pseudo-class,body.dark code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body.dark blockquote{background-color:var(--primary-light);color:var(--text-color)}body.dark a{color:var(--primary-color)}body.dark a:hover{color:var(--primary-light)}body.dark .post{background-color:var(--card-background)}</style><meta name="generator" content="Gatsby 3.14.6"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="avwie&#x27;s programming blog" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-b6d1bec96c52ba5be7bf.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-aa24829beabd43055df8.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-ef6357f687c91485d3ff.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-650a5f25cc8126c645de.js"/><link as="fetch" rel="preload" href="/page-data/compositional-patterns-in-kotlin-part-2-component-model/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav><div class="container"><a href="/">@avwie&#x27;s programming blog</a><div class="social"><a title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a><a class="dark-mode"><img alt="dark-mode" width="24" height="24" src="/layout/dark-mode-48.png"/></a></div></div></nav><main class="container"><h1>Compositional Patterns in Kotlin Part 2 - Component Model</h1><h4>07 Mar, 2021</h4><div><p>This is the second part of the post on compositional patterns in Kotlin and will focus on a dynamic, or runtime, composition. In <a href="/compositional-patterns-in-kotlin-part-1-delegation">Part 1</a> we focussed on static, or compile-time, composition. There are a few ways to obtain dynamic composition, all with their own advantages and drawbacks.</p>
<h2 id="component-model">Component Model</h2>
<p>It is very difficult to find a formal definition on the component model we use. If you search for Component Based Architecture, Component Architecture, Component Design, Entity Components, etc, you get a wide range of subjects, which all overlap. The one I am writing about here is very simple. It resembled the Entity Component Model, known in Unity, best. Please note that this means that it is just a 'small step' towards an Entity Component System, which is similar, but is a completely different way of looking at entities and components.</p>
<p>Roughly speaking, the Component Model is a model in which it is possible to add Components to an existing instance of a class during runtime.</p>
<p>Let's elaborate with an example.</p>
<h2 id="components-using-reflection">Components using Reflection</h2>
<p>One of the possibilities of the JVM, and therefore Kotlin as well, when compiled to the JVM, is that it is possible to use reflection. Using reflection it is quite trivial to implement a dynamic component system. Let us first define some component:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Component

<span class="token keyword">class</span> <span class="token function">Health</span><span class="token punctuation">(</span>initialAmount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">var</span> currentHealth <span class="token operator">=</span> initialAmount
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">val</span> isDead<span class="token operator">:</span> Boolean <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> currentHealth <span class="token operator">&lt;=</span> <span class="token number">0</span>

    <span class="token keyword">fun</span> <span class="token function">damage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentHealth <span class="token operator">-=</span> amount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> mass<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    sx0<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    sy0<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    vx0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    vy0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    ax0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    ay0<span class="token operator">:</span> Double <span class="token operator">=</span> <span class="token number">0.0</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">var</span> position <span class="token operator">=</span> sx0 <span class="token keyword">to</span> sy0
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">var</span> velocity <span class="token operator">=</span> vx0 <span class="token keyword">to</span> vy0
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">var</span> acceleration <span class="token operator">=</span> ax0 <span class="token keyword">to</span> ay0
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">fun</span> <span class="token function">applyForce</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>fx<span class="token punctuation">,</span> fy<span class="token punctuation">)</span> <span class="token operator">=</span> amount
        acceleration <span class="token operator">=</span> ax <span class="token operator">+</span> fx <span class="token operator">/</span> mass <span class="token keyword">to</span> ay <span class="token operator">+</span> fy <span class="token operator">/</span> mass
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">updateDynamics</span><span class="token punctuation">(</span>dt<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">)</span> <span class="token operator">=</span> acceleration
        <span class="token keyword">val</span> <span class="token punctuation">(</span>vx<span class="token punctuation">,</span> vy<span class="token punctuation">)</span> <span class="token operator">=</span> velocity
        <span class="token keyword">val</span> <span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span> <span class="token operator">=</span> position

        <span class="token comment">// this is clearly naive, since this is not deterministic, however... it serves the purpose for this post</span>
        velocity <span class="token operator">=</span> vx <span class="token operator">+</span> ax <span class="token operator">*</span> dt <span class="token keyword">to</span> vy <span class="token operator">+</span> ay <span class="token operator">*</span> dt
        position <span class="token operator">=</span> sx <span class="token operator">+</span> vx <span class="token operator">*</span> dt <span class="token keyword">to</span> sy <span class="token operator">+</span> vy <span class="token operator">*</span> dt
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The components are almost identical to the ones in <a href="/compositional-patterns-in-kotlin-part-1-delegation">Part 1</a>, with the exception that they all extend the <code class="language-text">Component</code> interface.</p>
<p>It is now possible to define an interface for the way we want to set and retrieve components at runtime.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C <span class="token operator">:</span> Component<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>type<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span>
<span class="token punctuation">}</span></code></pre></div>
<p>What this interface gives us is a very simple way to set and retrieve a component. For the <code class="language-text">getComponent</code> function we fetch the component by getting the <code class="language-text">KClass</code> of the component type and enforcing that this can only be a <code class="language-text">KClass</code> of type <code class="language-text">C</code> which must implement <code class="language-text">Component</code> via the typebound <code class="language-text">C: Component</code>.</p>
<p>We can now have every class implement this interface when we require dynamic component behavior, but maybe it is better to once more use delegation again to define a reference implementation and delegate this behavior to that reference implementation.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> MapComponentHolder <span class="token operator">:</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> components <span class="token operator">=</span> mutableMapOf<span class="token operator">&lt;</span>KClass<span class="token operator">&lt;</span><span class="token keyword">out</span> Component<span class="token operator">></span><span class="token punctuation">,</span> Component<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        components<span class="token punctuation">[</span>component<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">]</span> <span class="token operator">=</span> component
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"UNCHECKED_CAST"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C <span class="token operator">:</span> Component<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>type<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> components<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> C
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We create a <code class="language-text">MapComponentHolder</code> which implements the <code class="language-text">ComponentHolder</code> interface by storing the <code class="language-text">KClass</code> of any component we save using <code class="language-text">setComponent</code>, using the <code class="language-text">::class</code> notation, in a map. In the retrieval phase you see that we can easily retrieve this component <em>and</em> cast it to the right type <code class="language-text">C</code>. Please note that we had to add the annotation <code class="language-text">@Suppress("UNCHECKED_CAST")</code> to the function because the Kotlin compiler is unsure if the result from fetching the <code class="language-text">KClass&lt;C></code> from the map is actually castable to <code class="language-text">C</code>, since the only thing the compiler knows about it is that it will return a value of type <code class="language-text">Component</code>, and not <code class="language-text">C</code>. However, we can be pretty sure that it is <code class="language-text">C</code> and therefore can cast it using the <code class="language-text">as?</code> keyword. This means it will return <code class="language-text">null</code> when it is not castable and <code class="language-text">C</code> when succesful.</p>
<p>Now we can use the delegation pattern again and mixin this implementation in an already existing class. I have a class called <code class="language-text">Entity</code> with only 1 parameter, <code class="language-text">id</code>, as an illustration purpose.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token keyword">val</span> id<span class="token operator">:</span> Long<span class="token punctuation">,</span> <span class="token keyword">private</span> <span class="token keyword">val</span> components<span class="token operator">:</span> ComponentHolder <span class="token operator">=</span> <span class="token function">MapComponentHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    ComponentHolder <span class="token keyword">by</span> components
    
<span class="token comment">// test code</span>
<span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Health<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>currentHealth<span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">2.0</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Dynamics<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span></code></pre></div>
<p>And as can be seen, we have dynamic, typesafe, compositional behavior. However, personally I don't really like the way I have to sprinkle <code class="language-text">::class</code> through my code (but that is purely personal), so we can improve it, a tiny bit, by creating an extension function:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span><span class="token keyword">reified</span> C <span class="token operator">:</span> Component<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>C<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// test code</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span>getComponent<span class="token operator">&lt;</span>Health<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>currentHealth<span class="token punctuation">)</span></code></pre></div>
<p>We use the fact that we can 'reify' type parameters in Kotlin in inline functions. Due to type erasure in the JVM this is normally not possible, however using <code class="language-text">reified</code> we basically let the compiler generate special inline functions for every type parameter we pass in this function.  </p>
<p>And voila, we have a very simple component model that can be mixed in for different classes and if needed a different implementation can be created that suits your needs. Using extension methods this can be improved upon to add extra behavior, e.g. a way of querying a class for multiple components and invoking a block on those when they are both not null. The latter can be done like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// more if you need them... however, 3 typically suits my needs</span>
<span class="token keyword">fun</span> <span class="token operator">&lt;</span>C1<span class="token punctuation">,</span> R<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>t1<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C1<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token punctuation">(</span>C1<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R<span class="token operator">?</span> <span class="token keyword">where</span> C1 <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">val</span> c1 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token function">block</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> R<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>t1<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C1<span class="token operator">></span><span class="token punctuation">,</span> t2<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C2<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token punctuation">(</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R<span class="token operator">?</span> 
<span class="token keyword">where</span> C1 <span class="token operator">:</span> Component<span class="token punctuation">,</span> C2 <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">val</span> c1 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> c2 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token function">block</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">,</span> R<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>t1<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C1<span class="token operator">></span><span class="token punctuation">,</span> t2<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C2<span class="token operator">></span><span class="token punctuation">,</span> t3<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>C3<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token punctuation">(</span>C1<span class="token punctuation">,</span> C2<span class="token punctuation">,</span> C3<span class="token punctuation">)</span> <span class="token operator">-></span> R<span class="token punctuation">)</span><span class="token operator">:</span> R<span class="token operator">?</span> 
<span class="token keyword">where</span> C1 <span class="token operator">:</span> Component<span class="token punctuation">,</span> C2 <span class="token operator">:</span> Component<span class="token punctuation">,</span> C3 <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">val</span> c1 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> c2 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> c3 <span class="token operator">=</span> <span class="token function">getComponent</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token function">block</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// test code</span>
<span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> monster <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">150.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> background <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
monster<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> entities <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> monster<span class="token punctuation">,</span> background<span class="token punctuation">)</span>

<span class="token comment">// draw all entities</span>
entities<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> entity <span class="token operator">-></span>
    entity<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>Dynamics<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> Sprite<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> dynamics<span class="token punctuation">,</span> sprite <span class="token operator">-></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Drawing entity </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">entity<span class="token punctuation">.</span>id</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> on position x=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">dynamics<span class="token punctuation">.</span>position<span class="token punctuation">.</span>first</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, y=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">dynamics<span class="token punctuation">.</span>position<span class="token punctuation">.</span>second</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token operator">?:</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Entity </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">entity<span class="token punctuation">.</span>id</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> doesn't have the required components"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/*  Result:
    Drawing entity 1 on position x=5.0, y=2.0
    Drawing entity 2 on position x=10.0, y=-4.0
    Entity 3 doesn't have the required components
*/</span> </code></pre></div>
<h2 id="components-without-reflection">Components without reflection</h2>
<p>It isn't always possible to use reflection on the target platform, especially when working with Kotlin Multiplatform. Luckily Kotlin has a good typesystem and type-inference system which makes transforming the code above to a non-reflection variant pretty easy. It is clear we need some sort of typesafe key to store and retrieve our components. Let us define those as follows, including the rewritten <code class="language-text">ComponentHolder</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span>

<span class="token keyword">interface</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">val</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> MapComponentHolder <span class="token operator">:</span> ComponentHolder <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> components <span class="token operator">=</span> mutableMapOf<span class="token operator">&lt;</span>ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> Any<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        components<span class="token punctuation">[</span>component<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> component
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"UNCHECKED_CAST"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token function">getComponent</span><span class="token punctuation">(</span>key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">as</span><span class="token operator">?</span> C
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen, they are nearly identical, except for the <code class="language-text">ComponentKey&lt;C></code> and the fact that <code class="language-text">Component</code> now has a <code class="language-text">val key : ComponentKey&lt;*></code>. We only need to define the keys for the components like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Health</span><span class="token punctuation">(</span>initialAmount<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key <span class="token operator">=</span> Key
    
    <span class="token comment">// ... identical</span>

    <span class="token keyword">object</span> Key <span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>Health<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>
    <span class="token comment">// ... identical</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key <span class="token operator">=</span> Key

    <span class="token comment">// ... identical</span>
    
    <span class="token keyword">object</span> Key <span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span>
<span class="token punctuation">}</span></code></pre></div>
<p>And also here, it is nearly identical. As you can expect, the resulting code to actually use it is also nearly identical:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Health<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>currentHealth<span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">5.0</span> <span class="token keyword">to</span> <span class="token number">2.0</span><span class="token punctuation">,</span> player<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Dynamics<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span></code></pre></div>
<p>One of the big benefits of this approach is that you aren't tied to <code class="language-text">objects</code> as keys. Why not use a class and have multiple components for the same component-type, but a different key? For example, a <code class="language-text">Sprite</code> could be in the foreground, or in the background, but they can both be added to an <code class="language-text">Entity</code>. One could solve that by having 2 types of sprites, or some sort of <code class="language-text">SpriteSet</code> component. Those are all valid approaches, but below is another one:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// make sure to make this a data-class for automatic generation of equals / hashCode for the map later</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> ParameterizedComponentKey<span class="token operator">&lt;</span>P<span class="token punctuation">,</span> C<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">val</span> parameter<span class="token operator">:</span> P<span class="token punctuation">)</span><span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span>

<span class="token keyword">enum</span> <span class="token keyword">class</span> SpriteTypeEnum <span class="token punctuation">{</span>
    Foreground<span class="token punctuation">,</span>
    Background<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token keyword">val</span> spriteData<span class="token operator">:</span> ByteArray<span class="token punctuation">,</span> <span class="token keyword">val</span> type<span class="token operator">:</span> SpriteTypeEnum<span class="token punctuation">)</span> <span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key <span class="token operator">=</span> Key<span class="token punctuation">[</span>type<span class="token punctuation">]</span>

    <span class="token keyword">object</span> Key <span class="token punctuation">{</span>
        <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token keyword">get</span><span class="token punctuation">(</span>type<span class="token operator">:</span> SpriteTypeEnum<span class="token punctuation">)</span><span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>Sprite<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">ParameterizedComponentKey</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// test code</span>
<span class="token keyword">val</span> world <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
world<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Foreground"</span></span><span class="token punctuation">.</span><span class="token function">encodeToByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SpriteTypeEnum<span class="token punctuation">.</span>Foreground<span class="token punctuation">)</span><span class="token punctuation">)</span>
world<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Background"</span></span><span class="token punctuation">.</span><span class="token function">encodeToByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SpriteTypeEnum<span class="token punctuation">.</span>Background<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Foreground"</span></span><span class="token punctuation">,</span> world<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Sprite<span class="token punctuation">.</span>Key<span class="token punctuation">[</span>SpriteTypeEnum<span class="token punctuation">.</span>Foreground<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>spriteData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">decodeToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Background"</span></span><span class="token punctuation">,</span> world<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Sprite<span class="token punctuation">.</span>Key<span class="token punctuation">[</span>SpriteTypeEnum<span class="token punctuation">.</span>Background<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>spriteData<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">decodeToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>We generate a new kind of <code class="language-text">ComponentKey</code> here which takes a parameter to distinguish it. Using an operator function on the <code class="language-text">Key</code> object we are able to generate <code class="language-text">ComponentKey&lt;Sprite></code>'s on demand, based on the <code class="language-text">SpriteTypeEnum</code>. So now we have a parameterized, typesafe method of dynamically adding components to an existing object.</p>
<h2 id="improving-the-api-by-using-extension-methods">Improving the API by using extension methods</h2>
<p>Since we've defined our Component API using the interface <code class="language-text">ComponentHolder</code>, it is very trivial to improve the API of <em>any</em> instance of <code class="language-text">ComponentHolder</code> by creating some convenient extension functions. They will work regardless of the implementation (<code class="language-text">MapComponentHolder</code> in this case):</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> ComponentHolder<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">,</span> block<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> C<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">operator</span> <span class="token keyword">fun</span> ComponentHolder<span class="token punctuation">.</span><span class="token function">plusAssign</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span></code></pre></div>
<p>What this does is making the setting and getting of components a tiny bit less verbose:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> player <span class="token operator">=</span> <span class="token function">Entity</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
player <span class="token operator">+=</span> <span class="token function">Health</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
player <span class="token operator">+=</span> <span class="token function">Sprite</span><span class="token punctuation">(</span><span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SpriteTypeEnum<span class="token punctuation">.</span>Foreground<span class="token punctuation">)</span>

<span class="token keyword">val</span> position <span class="token operator">=</span> player<span class="token punctuation">.</span><span class="token function">getOrElse</span><span class="token punctuation">(</span>Dynamics<span class="token punctuation">.</span>Key<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> player<span class="token punctuation">[</span>Health<span class="token punctuation">.</span>Key<span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">.</span>currentHealth<span class="token punctuation">)</span>
<span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> position<span class="token punctuation">.</span>position<span class="token punctuation">.</span>first<span class="token punctuation">)</span></code></pre></div>
<p>Hopefully this tiny example shows that if you set up your code using interfaces you can improve upon your API with extensions, without modifying any of the underlying interfaces or implementations.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This concludes Part 2 on Compositional Patterns in Kotlin where we looked into a method with reflection, and a method without. Personally I'd favor the non-reflection version, since I'd like to keep my code as portable as possible without fixing myself to an underlying runtime, especially when a portable version is just as easy.</p>
<p>This was my second blog post I have written, and I thoroughly enjoyed it. However, by learning and making mistakes you improve. I am very interested in your critique, or questions. So contact me via <a href="mailto:info@avwie.nl">e-mail</a>, Twitter <a href="https://twitter.com/avwie">@avwie</a>, or at <a href="https://github.com/avwie/kotlin-blog">my repository of the coding examples</a>.</p></div></main><footer class="container"><p>Build <!-- -->9b748ff<!-- --> - <!-- -->2025-05-21T07:00:47.000Z</p></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/compositional-patterns-in-kotlin-part-2-component-model";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-aa24829beabd43055df8.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-f2b90683571a7299fa82.js"],"component---src-templates-post-js":["/component---src-templates-post-js-650a5f25cc8126c645de.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-650a5f25cc8126c645de.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-ef6357f687c91485d3ff.js" async=""></script><script src="/app-aa24829beabd43055df8.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-b6d1bec96c52ba5be7bf.js" async=""></script><script data-goatcounter="https://avwie.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script></body></html>