<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"/><title>avwie&#x27;s programming blog</title><style data-href="/styles.ad85a6d865fc877d8276.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&display=swap);@import url(https://fonts.googleapis.com/css2?family=Fira+Code&display=swap);code[class*=language-],pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2b2b2b}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.prolog{color:gray}.token.atrule,.token.boolean,.token.delimiter,.token.important,.token.keyword,.token.selector{color:#cc7832}.token.attr-name,.token.operator,.token.punctuation{color:#a9b7c6}.token.builtin,.token.doctype,.token.tag,.token.tag .punctuation{color:#e8bf6a}.token.entity,.token.number,.token.symbol{color:#6897bb}.token.constant,.token.property,.token.variable{color:#9876aa}.token.char,.token.string{color:#6a8759}.token.attr-value,.token.attr-value .punctuation{color:#a5c261}.token.attr-value .punctuation:first-child{color:#a9b7c6}.token.url{color:#287bde;text-decoration:underline}.token.function{color:#ffc66d}.token.regex{background:#364135}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.inserted{background:#294436}.token.deleted{background:#484a4a}code.language-css .token.property,code.language-css .token.property+.token.punctuation{color:#a9b7c6}code.language-css .token.id,code.language-css .token.selector>.token.attribute,code.language-css .token.selector>.token.class,code.language-css .token.selector>.token.pseudo-class,code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body{font-family:"Noto Serif",serif;font-size:11pt}.markdown h1,.markdown h2{text-decoration:underline}.markdown h1,.markdown h2,.markdown h3,.markdown h4,.markdown h5,.markdown h6{margin-top:1em}.markdown strong{text-decoration:underline}.markdown code{font-size:.9em!important}.markdown pre[class*=language-]{border-radius:.5em}.markdown ol code,.markdown p code,.markdown ul code{background-color:revert;color:revert;text-shadow:revert}</style><meta name="generator" content="Gatsby 3.14.6"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="avwie&#x27;s programming blog" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-445b5b1c96b330a20bcd.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-9887230afd096a67a0dc.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-c84cd9785c086ddb17fc.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-881b6afcff1906b380f8.js"/><link as="fetch" rel="preload" href="/page-data/building-an-ecs-in-kotlin-mpp/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="navbar navbar-dark bg-dark"><div class="container-lg d-flex"><span class="navbar-brand mt-2 mb-2 h1"><a class="text-decoration-none text-white" href="/">@avwie&#x27;s programming blog</a></span><div class="text-light mx-3"><a class="px-2" title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a class="px-2" title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a class="px-2" title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a></div></div></nav><div class="container-lg mt-4"><h1 class="text-decoration-underline fs-1 py-2">Building an ECS-architecture using Kotlin MPP</h1><h4>26 Mar, 2021</h4><div class="markdown mb-4 fs-6 col-lg-9"><p>In this post we are going to build an Entity-Component-System architecture from scratch using Kotlin Multiplatform Programming and create a simpel Kotlin/JS simulation with it. Entity-Component-System (ECS) is an architectural pattern that is mostly used in game development and is a compositional design pattern, similar to the ones I describe in my <a href="/compositional-patterns-in-kotlin-part-1-delegation">previous</a> <a href="/compositional-patterns-in-kotlin-part-2-component-model">posts</a>. </p>
<p>An ECS-architecture consists of 3 distinct elements: Entities, Components and Systems.</p>
<p>Hence the name, Entity-Component-System. This also shows that Systems are a part of the architecture and ECS does not mean an Entity-Component <em>System</em> (it being a system of entities and components), but Entity-Component-System <em>architecture</em>.</p>
<p>The 3 elements of ECS are shortly described as follows:</p>
<ul>
<li>Entities: Unique identifiers of <em>some</em> identifiable elements in your program</li>
<li>Components: Data objects that describe certain traits and are assignable to an entity</li>
<li>Systems: Routines that iterate over a subset of all entities which have some combination of components and perform some operation over them.</li>
</ul>
<p>Well, this is still a bit vague of course. But when we refer to my previous post about the <a href="/compositional-patterns-in-kotlin-part-2-component-model">component model</a> we already had something that resembled ECS. We have Entities that can have behavior dynamically assigned to them. The big difference now is that we move the logic our of the components into systems and we move the storage of components out of the entity. This results in an entity being very very simple. Actually, it is typically just an identifier. An your architecture is actually the method you'll be using for managing the entities, assigning and retrieving the components to them and running the systems. </p>
<p>As an example, you can imagine that you have some monsters, that are just entities, that contain <code class="language-text">Position</code> and <code class="language-text">Sprite</code> components. A <code class="language-text">DrawingSystem</code> might iterate over all entities that have this combination and draw them on screen, every frame. Do you want some other entities, that are not monsters, to be drawn? Just give them <code class="language-text">Position</code> and <code class="language-text">Sprite</code> components and they should automatically be drawn. The system doesn't care. Then we also have a <code class="language-text">GravitySystem</code> that iterates on all entities that have <code class="language-text">Position</code> and <code class="language-text">Mass</code> components and updates their position based on the gravity. Or, you have an auxiliary system, called <code class="language-text">LookupSystem</code>, which iterates over all <code class="language-text">Position</code> components and puts them in a <code class="language-text">QuadTree</code> for efficient collision detection in other systems.</p>
<p>So what is the benefit of this?</p>
<p>Well, there are a few:</p>
<ul>
<li>Highly dynamic composition behavior possible</li>
<li>Components are very simple data objects, without any logic, making them dead-easy to understand</li>
<li>All logic is moved to the systems resulting in a very clear responsibility and makes it easier to reason about</li>
<li>New behavior is just a new system</li>
<li>Architecture can be optimized for very fast lookup of certain combinations of components</li>
</ul>
<h2 id="defining-the-architecture">Defining the architecture</h2>
<p>We first start by defining our interface for the ECS architecture. We will keep it as generic as possible, since we don't yet know of want to decide about how we uniquely identify an entity and which components we are going to use. We do, however, want to describe some methods on how we interact with the architecture. This result in the following interface definitions:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span>

<span class="token keyword">interface</span> Component<span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Backend<span class="token operator">&lt;</span>Id<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">create</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> Id
    <span class="token keyword">fun</span> <span class="token function">exists</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">)</span><span class="token operator">:</span> Boolean
    <span class="token keyword">fun</span> <span class="token function">destroy</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">)</span><span class="token operator">:</span> Id
    <span class="token keyword">fun</span> <span class="token function">entities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Sequence<span class="token operator">&lt;</span>Id<span class="token operator">></span>

    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C <span class="token operator">:</span> Component<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token operator">></span> <span class="token keyword">set</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> component<span class="token operator">:</span> C<span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span>
    <span class="token keyword">fun</span> <span class="token function">has</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token keyword">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token function">unset</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> System<span class="token operator">&lt;</span>Id<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> keys <span class="token operator">:</span> Set<span class="token operator">&lt;</span>ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">></span>
    <span class="token keyword">var</span> backend<span class="token operator">:</span> Backend<span class="token operator">&lt;</span>Id<span class="token operator">></span>

    <span class="token keyword">fun</span> <span class="token function">beforeInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>entity<span class="token operator">:</span> Id<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">afterInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <code class="language-text">Component</code> and <code class="language-text">ComponentKey&lt;C></code> patterns are copied from <a href="/compositional-patterns-in-kotlin-part-2-component-model">my previous</a> posts, which results in a type-safe storage of components. Furthermore we have a <code class="language-text">Backend</code> which is the main workhorse, that handles the storage and retrieval of components of entities. Lastly we have the <code class="language-text">System</code> interface which we will use to run our systems over the entitites. There are multiple ways to define systems and how to traverse all entities and this is just <em>a</em> method, and not necessarily the best method. However, is pretty general and serves the purpose of this blog post. The <code class="language-text">System</code> interface will be used by a <code class="language-text">SystemsRunner</code> class in order to execute multiple systems:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> SystemsRunner<span class="token operator">&lt;</span>Id<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">val</span> backend<span class="token operator">:</span> Backend<span class="token operator">&lt;</span>Id<span class="token operator">></span><span class="token punctuation">,</span> <span class="token keyword">vararg</span> <span class="token keyword">val</span> systems<span class="token operator">:</span> System<span class="token operator">&lt;</span>Id<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">init</span> <span class="token punctuation">{</span>
        systems<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> system <span class="token operator">-></span>
            system<span class="token punctuation">.</span>backend <span class="token operator">=</span> backend
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        systems<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> system <span class="token operator">-></span>
            system<span class="token punctuation">.</span><span class="token function">beforeInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            backend<span class="token punctuation">.</span><span class="token function">entities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> entity <span class="token operator">-></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>system<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">all</span> <span class="token punctuation">{</span> key <span class="token operator">-></span> backend<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">system</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            system<span class="token punctuation">.</span><span class="token function">afterInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen, for every entity it checks for that system if the required <code class="language-text">keys</code> are set. If that is the case, the system is executed for that entity. </p>
<p>Now, we now run all our systems sequentially and this doesn't always make sense. It only makes sense if there is a dependency of one system to the other. For instance, some dynamics need to be updated before everything is drawn. However, it might be the case that some systems are not dependent on each other. In that case one could create a <code class="language-text">ParallelSystem</code> that handles some subsystems in parallel. Nevertheless, premature optimization is never good, so let us first see how everything goes with this setup.</p>
<h2 id="naive-hashmap-backend">Naive hashmap backend</h2>
<p>As a first version, because it is simple to implement, we are going to use a simple hashmap as a backend;</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> HashMapBackend<span class="token operator">&lt;</span>Id<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">val</span> idGenerator<span class="token operator">:</span> Generator<span class="token operator">&lt;</span>Id<span class="token operator">></span><span class="token punctuation">,</span> <span class="token keyword">val</span> strict<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">:</span> Backend<span class="token operator">&lt;</span>Id<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> components <span class="token operator">=</span> mutableMapOf<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> MutableMap<span class="token operator">&lt;</span>ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> Component<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">create</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Id <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">?:</span> idGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">exists</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">"Entity </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">it</span></span><span class="token string"> already exists!"</span></span> <span class="token punctuation">}</span>
        components<span class="token punctuation">[</span>it<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mutableMapOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">exists</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> components<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">destroy</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">)</span><span class="token operator">:</span> Id <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span>
        <span class="token function">requireExists</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
        components<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">entities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Sequence<span class="token operator">&lt;</span>Id<span class="token operator">></span> <span class="token operator">=</span> components<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">asSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C <span class="token operator">:</span> Component<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token operator">></span> <span class="token keyword">set</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> component<span class="token operator">:</span> C<span class="token punctuation">)</span><span class="token operator">:</span> C<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token function">requireExists</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">val</span> previous <span class="token operator">=</span> components<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>key<span class="token punctuation">,</span> component<span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token keyword">return</span> <span class="token function">requireComponentIsType</span><span class="token punctuation">(</span>previous<span class="token punctuation">,</span> component<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">has</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token function">requireExists</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> components<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token keyword">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C <span class="token punctuation">{</span>
        <span class="token function">requireHas</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">requireComponentIsType</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token function">unset</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C <span class="token punctuation">{</span>
        <span class="token function">requireHas</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">requireComponentIsType</span><span class="token punctuation">(</span>components<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requireExists</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strict<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">exists</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">"Entity </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">id</span></span><span class="token string"> does not exist!"</span></span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requireHas</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Id<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strict<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token function">requireExists</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">"Entity </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">id</span></span><span class="token string"> does not have a component with key </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">key</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"UNCHECKED_CAST"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token function">requireComponentIsType</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C <span class="token punctuation">{</span>
        <span class="token keyword">val</span> casted <span class="token operator">=</span> component <span class="token keyword">as</span><span class="token operator">?</span> C
        <span class="token function">require</span><span class="token punctuation">(</span>casted <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">"Component </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">component</span></span><span class="token string"> is not of type expected by </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">key</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> casted
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>I added a <code class="language-text">strict</code> mode to check if entities exist or components are available. However, I found out this affects the performance, of this implementation, quite a lot. This makes sense of course, because of all the extra lookups that need to be performed. Nevertheless, it is a good starting point.</p>
<h2 id="bouncing-balls-in-kotlinjs">Bouncing balls in Kotlin/JS</h2>
<p>We're going to make a very simple Canvas2D web application with a lot of bouncing balls. The final code can be found on <a href="https://github.com/avwie/kotlin-blog/tree/ecs">my Github</a>, so I only focus on the most important aspects. I use a very basic Kotlin MPP project setup for this.</p>
<h3 id="components">Components</h3>
<p>We begin by defining our components. Since we are talking about bouncing balls, I will use only 2 components: <code class="language-text">Color</code> and <code class="language-text">Dynamics</code>.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> mass<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    initialPosition<span class="token operator">:</span> Vector2D<span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token operator">=</span> vec2D<span class="token punctuation">.</span>zero<span class="token punctuation">,</span>
    initialVelocity<span class="token operator">:</span> Vector2D<span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token operator">=</span> vec2D<span class="token punctuation">.</span>zero<span class="token punctuation">,</span>
    initialAcceleration<span class="token operator">:</span> Vector2D<span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token operator">=</span> vec2D<span class="token punctuation">.</span>zero
<span class="token punctuation">)</span><span class="token operator">:</span> Component<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>Dynamics<span class="token operator">></span> <span class="token operator">=</span> Dynamics

    <span class="token keyword">var</span> position <span class="token operator">=</span> initialPosition
    <span class="token keyword">var</span> velocity <span class="token operator">=</span> initialVelocity
    <span class="token keyword">var</span> acceleration <span class="token operator">=</span> initialAcceleration

    <span class="token keyword">fun</span> <span class="token function">applyForce</span><span class="token punctuation">(</span>force<span class="token operator">:</span> Vector2D<span class="token operator">&lt;</span>Double<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        acceleration <span class="token operator">+=</span> force <span class="token operator">/</span> mass
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">update</span><span class="token punctuation">(</span>dt<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        velocity <span class="token operator">+=</span> acceleration <span class="token operator">*</span> dt
        position <span class="token operator">+=</span> velocity <span class="token operator">*</span> dt
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Color</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> red<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword">val</span> green<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword">val</span> blue<span class="token operator">:</span> Int
<span class="token punctuation">)</span><span class="token operator">:</span> Component<span class="token operator">&lt;</span>Color<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>Color<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">fun</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Color <span class="token operator">=</span> <span class="token function">Color</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>Color<span class="token operator">></span> <span class="token operator">=</span> Color

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string-literal singleline"><span class="token string">"#"</span></span> <span class="token operator">+</span> <span class="token function">listOf</span><span class="token punctuation">(</span>red<span class="token punctuation">,</span> green<span class="token punctuation">,</span> blue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinToString</span><span class="token punctuation">(</span>separator <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">""</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">coerceIn</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>These are pretty simple components. As can be seen I added two methods in <code class="language-text">Dynamics</code> to aid with the calculation of forces and the updating of the states. These will only be called from systems but one could opt to move these methods to systems to keep everything more pure. </p>
<h3 id="systems">Systems</h3>
<p>I use a total of 5 systems for this demo:</p>
<ul>
<li><strong>SpawnAndDestroySystem</strong>: This manages the creation of entities and destroying them when they move out of the screen.</li>
<li><strong>GravitySystem</strong>: This applies gravity to the entities</li>
<li><strong>FloorSystem</strong>: Makes the bottom of the screen behave like a floor so the balls bounce up</li>
<li><strong>DynamicsSystem</strong>: Updates the dynamics of the entities</li>
<li><strong>DrawingSystem</strong>: Handles the drawing of the entities</li>
</ul>
<p>We are not going in detail through the systems. They can be viewed in the <a href="https://github.com/avwie/kotlin-blog/tree/ecs">repository</a>. Let's take a look at the <code class="language-text">GravitySystem</code> for starters:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">GravitySystem</span><span class="token punctuation">(</span><span class="token keyword">val</span> g<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">AbstractSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> keys<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">setOf</span><span class="token punctuation">(</span>Dynamics<span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>entity<span class="token operator">:</span> UUID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        backend<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> Dynamics<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> dynamics <span class="token operator">-></span>
            dynamics<span class="token punctuation">.</span>acceleration <span class="token operator">=</span> vec2D<span class="token punctuation">.</span>zero
            dynamics<span class="token punctuation">.</span><span class="token function">applyForce</span><span class="token punctuation">(</span><span class="token function">vec2D</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> g <span class="token operator">*</span> dynamics<span class="token punctuation">.</span>mass<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This is pretty simple. It requires an entity with <code class="language-text">Dynamics</code> and applies a vertical gravitational force.</p>
<p>More interesting is the <code class="language-text">SpawnAndDestroySystem</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">SpawnAndDestroySystem</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> bounds<span class="token operator">:</span> Rectangle<span class="token operator">&lt;</span>Double<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">val</span> spawnTotal<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword">val</span> spawnVelocity<span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span>
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">AbstractSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> keys<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">setOf</span><span class="token punctuation">(</span>Dynamics<span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> totalEntities<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> entitiesToDestroy <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>UUID<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">beforeInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        totalEntities <span class="token operator">=</span> <span class="token number">0</span>
        entitiesToDestroy<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>entity<span class="token operator">:</span> UUID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        backend<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> Dynamics<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> dynamics <span class="token operator">-></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bounds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>dynamics<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                totalEntities <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                entitiesToDestroy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">afterInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        entitiesToDestroy<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> id <span class="token operator">-></span>
            backend<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">val</span> entitiesToSpawn <span class="token operator">=</span> spawnTotal <span class="token operator">-</span> <span class="token function">totalEntities</span>
        <span class="token punctuation">(</span><span class="token number">0</span> until entitiesToSpawn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> _ <span class="token operator">-></span>
            backend<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> id <span class="token operator">-></span>
                <span class="token keyword">val</span> ltr <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> dynamics <span class="token operator">=</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>
                    mass <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                    initialPosition <span class="token operator">=</span> <span class="token function">vec2D</span><span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ltr<span class="token punctuation">)</span> bounds<span class="token punctuation">.</span>x0 <span class="token keyword">else</span> bounds<span class="token punctuation">.</span>x1<span class="token punctuation">,</span> Random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span>bounds<span class="token punctuation">.</span>y0<span class="token punctuation">,</span> bounds<span class="token punctuation">.</span>y1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    initialVelocity <span class="token operator">=</span> <span class="token function">vec2D</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span>spawnVelocity<span class="token punctuation">.</span>first<span class="token punctuation">,</span> spawnVelocity<span class="token punctuation">.</span>second<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ltr<span class="token punctuation">)</span> <span class="token number">1.0</span> <span class="token keyword">else</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    initialAcceleration <span class="token operator">=</span> vec2D<span class="token punctuation">.</span>zero
                <span class="token punctuation">)</span>
                backend<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> dynamics<span class="token punctuation">)</span>
                backend<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> Color<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This is more complicated. We require a <code class="language-text">bounds</code> variable, that defines when an entity is destroyed and a <code class="language-text">spawnTotal</code> which describes the total of entities we always require. Lastly we have a <code class="language-text">spanVelocity</code> that is an upper bound for the <code class="language-text">x</code> and <code class="language-text">y</code> velocities. During every run it looks for every entity that is outside of the bounds and in the <code class="language-text">afterInvoke</code> it removes them and replaces them with fresh new ones, on the boundary of the bounds.</p>
<p>The last interesting one is the <code class="language-text">DrawingSystem</code>. Please note that all the other ones were just very simple systems written in common Kotlin code. Never was there any dependency on JS or the JVM. This last system, however, is specifically made for the JS environment:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">DrawingSystem</span><span class="token punctuation">(</span><span class="token keyword">val</span> radius<span class="token operator">:</span> Double<span class="token punctuation">,</span> <span class="token keyword">val</span> ctx<span class="token operator">:</span> CanvasRenderingContext2D<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">AbstractSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> keys<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ComponentKey<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">setOf</span><span class="token punctuation">(</span>Color<span class="token punctuation">,</span> Dynamics<span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">beforeInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>entity<span class="token operator">:</span> UUID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        backend<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> Dynamics<span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token punctuation">{</span> dynamics<span class="token punctuation">,</span> color <span class="token operator">-></span>
            ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>dynamics<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">,</span> dynamics<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> PI<span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Also this one is very straightforward and uses a <code class="language-text">CanvasRenderingContext2D</code> to fill a simple circle with the color at the position of a ball.</p>
<h2 id="tying-it-all-together">Tying it all together</h2>
<p>We make a very simple Kotlin/JS app with the following contents:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"canvas"</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">?</span> HTMLCanvasElement
    <span class="token keyword">val</span> ctx <span class="token operator">=</span> canvas<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"2d"</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">?</span> CanvasRenderingContext2D

    ctx<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> app <span class="token operator">=</span> <span class="token function">BouncingBalls</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">BouncingBalls</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> CanvasRenderingContext2D<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> backend <span class="token operator">=</span> <span class="token function">HashMapBackend</span><span class="token punctuation">(</span>UUIDGenerator<span class="token punctuation">)</span>
    <span class="token keyword">val</span> dynamicsSystem <span class="token operator">=</span> <span class="token function">DynamicsSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> gravitySystem <span class="token operator">=</span> <span class="token function">GravitySystem</span><span class="token punctuation">(</span><span class="token number">300.0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> floorSystem <span class="token operator">=</span> <span class="token function">FloorSystem</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spawnerAndDestroySystem <span class="token operator">=</span> <span class="token function">SpawnAndDestroySystem</span><span class="token punctuation">(</span>
        bounds <span class="token operator">=</span> <span class="token function">rect2D</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        spawnTotal <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>
        spawnVelocity <span class="token operator">=</span> <span class="token number">100.0</span> <span class="token keyword">to</span> <span class="token number">300.0</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">val</span> drawingSystem <span class="token operator">=</span> <span class="token function">DrawingSystem</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
    <span class="token keyword">val</span> runner <span class="token operator">=</span> <span class="token function">SystemsRunner</span><span class="token punctuation">(</span>backend<span class="token punctuation">,</span> spawnerAndDestroySystem<span class="token punctuation">,</span> gravitySystem<span class="token punctuation">,</span> dynamicsSystem<span class="token punctuation">,</span> floorSystem<span class="token punctuation">,</span> drawingSystem<span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> lastTimeStamp <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> dt <span class="token operator">=</span> <span class="token number">0.0</span>

    <span class="token keyword">fun</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lastTimeStamp <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token operator">::</span>loop<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">loop</span><span class="token punctuation">(</span>timestamp<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dt <span class="token operator">=</span> <span class="token punctuation">(</span>timestamp <span class="token operator">-</span> lastTimeStamp<span class="token punctuation">)</span>
        lastTimeStamp <span class="token operator">=</span> timestamp
        dynamicsSystem<span class="token punctuation">.</span><span class="token function">setElapsedTime</span><span class="token punctuation">(</span>dt <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">)</span>
        runner<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token operator">::</span>loop<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We use the <code class="language-text">Window.requestAnimationFrame</code> to create a rendering loop. During the loop, the <code class="language-text">DynamicsSystem</code> will get updated with the latest <code class="language-text">dt</code> value and afterwards the <code class="language-text">SystemsRunner</code> will run.</p>
<p>When we run the application using the <code class="language-text">jsBrowserDevelopmentRun</code>-task we get something like below:
<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; '>
      <a class='gatsby-resp-image-link' href='/static/db9493e287f1c5133b28f6b71fcdbaf7/0931d/initial.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 70.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADYklEQVQ4y32RO28cVQBG5y+4cAAJkZiHUCqnjVAaaBAlokOCaRBFtoEfwJ8BVhTESSwZbxIlxN54g9/xbvbtmd157LzfM3ced+7cD5m0wCcdne40n/DR9c++vHnji/7mB18/v/neV93r65933732SXd9bbN7be3Wf7K+dqv71tpmd+Pt290b73y69+HGndP3N27/JPz28/aP2zt/orP7Ep2dAzzq7GH7wRNs/b7779zbxf2tDrbudfDwwSM83tnDk84Rnj3rYXvn8X3BNry7eLMCAMubhl35/6g5+8cNIYzXJQPjVUwj0CL/RTjpyS11HKMgDU0iH/PZHCVjCHwfJGeIcoqaUtCKISkjxAmBsXKQxDFcy4XlZ1CWETMtF4HjtQVj5bRCM0dVZTTNQqCsUUUUknwGXhVgnCPLgLoE6qZBZukgeYCcEaRFgTSv4SQh45wjTdO24Pluq6ENsiKnDDVIQeBMF7ACF7bnISU1dMWGE9qoSQVDM0BjD7QpoWgGXE8DzSvWsPpN0LLMVl7nKBtGORrkeQq/IrDiAEvPgZFWKEgCxZHgWhZiw4RqKsgJAThHGaZIKGFN08D33LZg2Warbih4zemVWZMjZTUSz0UY24gzH7bioNc7xGLlIVN1DBUVNK+RhDaiPEJUxqwkDEHotQXf91ukKJAnhGp6BS3wMVFVyLqHmWQiIVcHeDg9fw1fSlFmFZyJAk01YUgz+KkLAsKCNMXSVNvCUrVaflijSWMaWyX0WYwiynAx6WMmm4hiF1ZqgLIKTVGiaCjUlYnaJUi0EEmSwNEjFkQuSJ61BdletDJCoGUBlZcGH54cc3sx44Hnc10xuDLSuB2kfGmn3J0oPJQsfjq84Kqx4itV5aQpeJrmrChqOHbcFob66G5JK9gsLhdziU3PJNafS8zRLaYbMTtczJl0pLGyApvMJbaSxmzR32OqI7HAKpgeJUyNnCrJCkwn9q+C5Vo/kIBAfaXBXIQ42R/jfDjDcfcUmiRjqUzx+niGMCwwWthYjAcwDB2qu8RgMIV0aeJyOoRmKFCW4ZYwmkw/ViX5+4Ot599c9GaiPD0TXxycig8PhuIfL4/F8V99sX/eF8eXY/HFq4GoLRVx/3AkDoZD8azbFfefHouzp0ffGtPL72RFvvM3PzfABGwRUbsAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='Initial bouncing balls' title='Initial bouncing balls' src='/static/db9493e287f1c5133b28f6b71fcdbaf7/1cfc2/initial.png' srcset='/static/db9493e287f1c5133b28f6b71fcdbaf7/3684f/initial.png 225w,
/static/db9493e287f1c5133b28f6b71fcdbaf7/fc2a6/initial.png 450w,
/static/db9493e287f1c5133b28f6b71fcdbaf7/1cfc2/initial.png 900w,
/static/db9493e287f1c5133b28f6b71fcdbaf7/21482/initial.png 1350w,
/static/db9493e287f1c5133b28f6b71fcdbaf7/0931d/initial.png 1373w' sizes='(max-width: 900px) 100vw, 900px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span></p>
<h2 id="improving-performance">Improving performance</h2>
<p>One thing I immediately notice is that the performance, with 500 balls, is not very good. We made a lot of assumptions ofcourse and used a very easy backend to built our ECS architecture. Upon inspecting the performance with the built-in Developer Tools of the browser, the following image arises of a single frame:</p>
<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; '>
      <a class='gatsby-resp-image-link' href='/static/04ba332aff89b9c7c6dd17d387cde709/45662/debug1.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 66.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADDklEQVQ4y4XMS28bZRQG4Fmy4U+wwt2yqBH/ICtWDQuk1mTFNlERpQvCjh8AQmwJFxV1orRQSEpiLNFiN3ESe2zPeMYz9sx4rp7vm6sdh4zneytbCBaV0iM9ehfvOYfr/nn4lj1WHxAa7UYkfhiFCU9JzLsu5UOS8L4b8KZh8frI5AOf8tPsgs+SGZ+l/3k4TWfLu0dKX7nJHR1W31NVEbouYjQSYejSKiW5DU0ToKptjEY9GKYE0+zDthXY1v+sJXsAXZdQrR58yO3vH900BuKlKTUX1qB1pY+F3BgJuT3o5PagnY+Vdm70W6tckdv5yOjl2riXK7qQ65qQe2r7n7F8jur+41vct199WT472snV+gMYJz+zILCZovTY8R8/MrG+x+TGHhPru6zf2PvXIyY2HzPx9Bc2sAkTzuts8GynME73UHvywzr3zdfflZ89Pcq79ReQmy2WJBdwHYJG9Tm6L1qQT0WIp10IjTak49ZyB1KjiUGzhdlFjl5XZX8f/lX0TgQ8/fVgndv96ftyoHfz2JIRuRqbzubI0ikSzwBxFASjDqLAAXVVhLoAMuog0NoIbQnZfIHAdxkZd4pl32k2lg93yr6p5XHgIgoJS9MpprNLxMRBkhBEvo40oUhCD7E3REIcxIGNNPIxnS9Aw5Al1CrSJITUa69zv//2pGxZdm7aHnTDYK7rgRCCKAwRxTEopaCEglAKQgIQShCQAJSQVTcJCJsEQTHxfTQa9XXuef2k7Dpm7jtDWLbDbEOEovQxthzYjrM6yrIMaZq+IktT2B5l2nhSiEMPB7Xjda7bFcuUkqs0HDNK3CLylcJxrCJO0mI+vywWRVEAuBYDFkG6wIkwuMV1Ot13kyTBxTREmsbIIhOUBojiFHmeY7EowBjD62Z+xdCRtA+4Wq32jqZpnqEPqaYqZCifE1mWiW6YxLYd4roemUwmhFJ6nYAQkp2dnb3Pra2tvVGpVN6+c6dy4/btSqmy8XFpe3u79MX256X79z8r3bv3aemTu3dLm5ub19ra2rrx0cbGmy8B/JttTH3OF6AAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='Single initial frame' title='Single initial frame' src='/static/04ba332aff89b9c7c6dd17d387cde709/1cfc2/debug1.png' srcset='/static/04ba332aff89b9c7c6dd17d387cde709/3684f/debug1.png 225w,
/static/04ba332aff89b9c7c6dd17d387cde709/fc2a6/debug1.png 450w,
/static/04ba332aff89b9c7c6dd17d387cde709/1cfc2/debug1.png 900w,
/static/04ba332aff89b9c7c6dd17d387cde709/21482/debug1.png 1350w,
/static/04ba332aff89b9c7c6dd17d387cde709/45662/debug1.png 1410w' sizes='(max-width: 900px) 100vw, 900px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span></p>
<p>And upon inspecting the calltree:
<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 651px; '>
      <a class='gatsby-resp-image-link' href='/static/6c9290a0ae4c6c1ac8975a0d9ba31261/1ac66/calltree.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 16%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApElEQVQI1z2O7QqCMBhGvf/bCyKylqVLc9rW1sdemTuRgQ+cf4fDU6RosEYRxoqX75gkYoYR1x+IoeO3OQne7DjXmrrR3HqzoK8tKaXFyTkvFMzCYFrcvecZHDEK+npj6DXvYP4y8LEHVLlhs92z25ccVcXxVPHwnjnnNVrAjL2PBO94PT0isjy01vJ5hzUooaFtSkp1QZ0qLnWDbjusc8g0rcEvaSrkiFBib80AAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='Initial call tree' title='Initial call tree' src='/static/6c9290a0ae4c6c1ac8975a0d9ba31261/1ac66/calltree.png' srcset='/static/6c9290a0ae4c6c1ac8975a0d9ba31261/3684f/calltree.png 225w,
/static/6c9290a0ae4c6c1ac8975a0d9ba31261/fc2a6/calltree.png 450w,
/static/6c9290a0ae4c6c1ac8975a0d9ba31261/1ac66/calltree.png 651w' sizes='(max-width: 651px) 100vw, 651px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span></p>
<p>A few improvements are possible:</p>
<ul>
<li>I used GUIDs as an entity ID, however in combination with a hashmap the GUIDs' hashcodes are calculated a lot. By moving to an Integer based system this should be faster.</li>
<li><em>HashMapBackend</em> is set to strict which causes a lot of checks of the <em>has</em> method. By switching of <em>strict</em> this should improve.</li>
<li>The type of components we use is known, so we can easily switch to a specialized backend which supports Integers and only the components we need.</li>
</ul>
<p>A new backend is created which is Array based, entities are integers (indices of the array), a fixed type of components and a limited number of entities. When an entity is destroyed, its id  is freed up and can be reused. An excerpt is shown below:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">ArrayBackend</span><span class="token punctuation">(</span><span class="token keyword">val</span> capacity<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Backend<span class="token operator">&lt;</span>Int<span class="token operator">></span> <span class="token punctuation">{</span>
    
    <span class="token comment">// .... omitted</span>
    
    <span class="token keyword">private</span> <span class="token keyword">val</span> exists <span class="token operator">=</span> <span class="token function">BooleanArray</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> colors <span class="token operator">=</span> Array<span class="token operator">&lt;</span>Color<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> dynamics <span class="token operator">=</span> Array<span class="token operator">&lt;</span>Dynamics<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">create</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">val</span> idx <span class="token operator">=</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        exists<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">return</span> idx
    <span class="token punctuation">}</span>

    <span class="token comment">// ... a variable index that reuses freed up indices</span>
    
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>freedUpIndices<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> freedUpIndices<span class="token punctuation">.</span><span class="token function">popFront</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentIndex <span class="token operator">>=</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Amount of entities exceed capacity"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        currentIndex <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> currentIndex
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...omitted</span>
    
    <span class="token comment">// the method below is one of the Backend methods. Here we clearly see how we identify which array to check</span>

    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"UNCHECKED_CAST"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>C<span class="token operator">></span> <span class="token keyword">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> Int<span class="token punctuation">,</span> key<span class="token operator">:</span> ComponentKey<span class="token operator">&lt;</span>C<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> C <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">is</span> Color<span class="token punctuation">.</span>Companion <span class="token operator">-></span> colors<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
            <span class="token keyword">is</span> Dynamics<span class="token punctuation">.</span>Companion <span class="token operator">-></span> dynamics<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
            <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token keyword">throw</span> <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Invalid component type"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">as</span> C
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The good thing is, we only needed to update the backend and everything is kept the same. This results in the following performance:
<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; '>
      <a class='gatsby-resp-image-link' href='/static/1371c9048ebf943d443a38124eec3195/45662/debug2.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACiElEQVQoz53JS2/cVAAFYO+64VcgobBn0UEs2CC2LBATVUQs2gWbJD+HJftINSoI2kZp2kLbRQTqKGReTsa+Hj/Gj2tfP66vPfade0/V9g8UjvTpHOkY02fnH4fezQnN8l8YZfdZzsyMMjOKsnftrX3TJWuTOK4ZeKFZV43JK25WJTfrkr/d998q8uJXa2ndNp6cnX2xcq6x9h24vgMvICCeg+XNAja5xspZgrjX8AIbXuAgjFwEGw9JFiBKAwSbNcLYh7u28fTZkwPj8cPHt93VYus7i51nXQ2ha8nIsWS8tmREljJ2lnKztuRmNZMbspThzVRuiCVpcCMT15IhsWRkLwbfXuDs9OHY+OP87xGlpQxmr1AXjU7JTJeRr3lZ6cT6R3ftTgdXz7WouE7sqU5CoilNdOpc65Z3Ol5e6L4dVELmOD35ad949OfrUcF7SecU7QCd2jnKWKCqesTTBK0C/AsPjdghXqYokxZl2SGZphCDxuYy0q2Eim2K059/3zcePX89Kuqt5EWLrocuWY1WSPBmQJ1zdANQ0ArdVqMuBFqxA296cNag7TUq1ujtAMXyCi/OX+wbD85ejVjdSb7twRqhueiRNw0qsUUpWhRNi6YbkPEajDdgQqAWPcr2/VeJTheiVRXvMLn8d984+e3ByPU3Q5Jn2ontHeeN8rK1KnmpaEVVxCLVdVtlJysVs0j5ma+44CotExUXkSrqQvm5txOixWw+GxuXV9bnnSiAXQWtgbLI8X/jEnLH+OvlxWfEXkQBmeR+ENL5fE7TNKWMMZrn+YdKsyyrJ5PJN8bXX315a3znh0/G3//46fi7b/fu3b27d3x8vHd4ePifHB0d7R0cHHz0Bi1k6zEL2kS0AAAAAElFTkSuQmCC'); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='Single upgraded frame' title='Single upgraded frame' src='/static/1371c9048ebf943d443a38124eec3195/1cfc2/debug2.png' srcset='/static/1371c9048ebf943d443a38124eec3195/3684f/debug2.png 225w,
/static/1371c9048ebf943d443a38124eec3195/fc2a6/debug2.png 450w,
/static/1371c9048ebf943d443a38124eec3195/1cfc2/debug2.png 900w,
/static/1371c9048ebf943d443a38124eec3195/21482/debug2.png 1350w,
/static/1371c9048ebf943d443a38124eec3195/45662/debug2.png 1410w' sizes='(max-width: 900px) 100vw, 900px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span>. </p>
<p>A single frame now takes ~6ms to render, which is quite an improvement. The simulation now runs at a smooth 60fps.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This concludes this post on a simple ECS architecture in Kotlin MPP with a Kotlin/JS application to testdrive it. What is clear to me is that this architecture is very versatile, and I think it extends well beyond games. I'll exploring this area in the future as well. Since the data is so clearly decoupled from the behavior it is very easy to persist or serialize the data which lends itself again for some interesting other ideas, like multi-user of networked behavior of an ECS. </p>
<p>I hope you've enjoyed this blog, but as always I am very interested in your critique, or questions. So contact me via <a href="mailto:info@avwie.nl">e-mail</a>, Twitter <a href="https://twitter.com/avwie">@avwie</a>, or at <a href="https://github.com/avwie/kotlin-blog">my repository of the coding examples</a>.</p></div></div><div class="border-top border-light py-2"><div class="container-lg text-muted fw-light text-center" style="font-size:0.8em"><small>Build <!-- -->909899a<!-- --> - <!-- -->2022-04-27T10:21:41.000Z</small></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YZ9NCTW594"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YZ9NCTW594', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/building-an-ecs-in-kotlin-mpp";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-9887230afd096a67a0dc.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-19c651befc200e8a6535.js"],"component---src-templates-post-js":["/component---src-templates-post-js-881b6afcff1906b380f8.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-881b6afcff1906b380f8.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-c84cd9785c086ddb17fc.js" async=""></script><script src="/app-9887230afd096a67a0dc.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-445b5b1c96b330a20bcd.js" async=""></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script></body></html>