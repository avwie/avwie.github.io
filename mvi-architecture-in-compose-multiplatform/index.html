<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><title>avwie&#x27;s programming blog</title><style data-href="/styles.7475f729b3dc85f53ec4.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap);@import url(https://fontlibrary.org//face/go-mono);body{background-color:#f3f3f3;font-family:Crimson Text,serif;font-size:14pt;margin:0}body code[class*=language-],body pre[class*=language-]{word-wrap:normal;background:none;color:#111b27;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body code[class*=language-] ::selection,body code[class*=language-]::selection,body pre[class*=language-] ::selection,body pre[class*=language-]::selection{background:#8da1b9}body pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body :not(pre)>code[class*=language-],body pre[class*=language-]{background:#e3eaf2}body :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em .3em;white-space:normal}body .token.cdata,body .token.comment,body .token.doctype,body .token.prolog{color:#3c526d}body .token.punctuation{color:#111b27}body .token.delimiter.important,body .token.selector .parent,body .token.tag,body .token.tag .token.punctuation{color:#006d6d}body .token.attr-name,body .token.boolean,body .token.boolean.important,body .token.constant,body .token.number,body .token.selector .token.attribute{color:#755f00}body .token.class-name,body .token.key,body .token.parameter,body .token.property,body .token.property-access,body .token.variable{color:#005a8e}body .token.attr-value,body .token.color,body .token.inserted,body .token.selector .token.value,body .token.string,body .token.string .token.url-link{color:#116b00}body .token.builtin,body .token.keyword-array,body .token.package,body .token.regex{color:#af00af}body .token.function,body .token.selector .token.class,body .token.selector .token.id{color:#7c00aa}body .token.atrule .token.rule,body .token.combinator,body .token.keyword,body .token.operator,body .token.pseudo-class,body .token.pseudo-element,body .token.selector,body .token.unit{color:#a04900}body .token.deleted,body .token.important{color:#c22f2e}body .token.keyword-this,body .token.this{color:#005a8e}body .token.bold,body .token.important,body .token.keyword-this,body .token.this{font-weight:700}body .token.delimiter.important{font-weight:inherit}body .token.italic{font-style:italic}body .token.entity{cursor:help}body .language-markdown .token.title,body .language-markdown .token.title .token.punctuation{color:#005a8e;font-weight:700}body .language-markdown .token.blockquote.punctuation{color:#af00af}body .language-markdown .token.code{color:#006d6d}body .language-markdown .token.hr.punctuation{color:#005a8e}body .language-markdown .token.url>.token.content{color:#116b00}body .language-markdown .token.url-link{color:#755f00}body .language-markdown .token.list.punctuation{color:#af00af}body .language-json .token.operator,body .language-markdown .token.table-header{color:#111b27}body .language-scss .token.variable{color:#006d6d}body .token.cr:before,body .token.lf:before,body .token.space:before,body .token.tab:not(:empty):before{color:#3c526d}body div.code-toolbar>.toolbar a,body div.code-toolbar>.toolbar button{background:#005a8e;color:#e3eaf2}body div.code-toolbar>.toolbar a:focus,body div.code-toolbar>.toolbar a:hover,body div.code-toolbar>.toolbar button:focus,body div.code-toolbar>.toolbar button:hover{background:rgba(0,90,142,.855);color:#e3eaf2;text-decoration:none}body div.code-toolbar>.toolbar span,body div.code-toolbar>.toolbar span:focus,body div.code-toolbar>.toolbar span:hover{background:#3c526d;color:#e3eaf2}body .line-highlight{background:rgba(141,161,185,.184);background:linear-gradient(90deg,rgba(141,161,185,.184) 70%,rgba(141,161,185,.145))}body .line-highlight:before,body .line-highlight[data-end]:after{background-color:#3c526d;box-shadow:0 1px #8da1b9;color:#e3eaf2}body pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(60,82,109,.122)}body .line-numbers .line-numbers-rows{background:rgba(208,218,231,.478);border-right:1px solid rgba(141,161,185,.478)}body .line-numbers-rows>span:before{color:rgba(60,82,109,.855)}body .rainbow-braces .token.punctuation.brace-level-1,body .rainbow-braces .token.punctuation.brace-level-5,body .rainbow-braces .token.punctuation.brace-level-9{color:#755f00}body .rainbow-braces .token.punctuation.brace-level-10,body .rainbow-braces .token.punctuation.brace-level-2,body .rainbow-braces .token.punctuation.brace-level-6{color:#af00af}body .rainbow-braces .token.punctuation.brace-level-11,body .rainbow-braces .token.punctuation.brace-level-3,body .rainbow-braces .token.punctuation.brace-level-7{color:#005a8e}body .rainbow-braces .token.punctuation.brace-level-12,body .rainbow-braces .token.punctuation.brace-level-4,body .rainbow-braces .token.punctuation.brace-level-8{color:#7c00aa}body pre.diff-highlight>code .token.deleted:not(.prefix),body pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(194,47,46,.122)}body pre.diff-highlight>code .token.inserted:not(.prefix),body pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(17,107,0,.122)}body .command-line-prompt{border-right:1px solid rgba(141,161,185,.478)}body .command-line-prompt>span:before{color:rgba(60,82,109,.855)}body a{color:#686868}body blockquote{background-color:#eee;color:#555;padding:1em}body blockquote p{margin:0}body nav{background-color:#000;padding:.5em 0;width:100vw}body nav *{color:#fff}body nav .social,body nav>.container{display:flex;flex-direction:row;justify-content:space-between}body nav .social{width:150px}body nav .social a{align-items:center;display:flex;justify-content:center}body nav .social a.dark-mode{cursor:pointer}body nav .social img{height:24px;width:24px}body .container{margin:0 1em}@media(min-width:900px){body .container{margin:0 auto;padding:0 1em;width:900px}}body .posts .post{background-color:#eee;margin-bottom:2em;padding:.5em}body .posts .post h2{margin:0}body .posts .post p{margin:.5em 0}body .posts .post .date,body .posts .post .reading-time{color:#333;font-size:.8em}body .posts .post a{font-weight:700}body footer{font-size:.8rem}code[class*=language-],pre[class*=language-]{border-radius:.5em;font-family:GoMonoRegular!important;font-size:.85rem!important;font-style:normal!important;font-weight:400!important}body.dark{@import"https://fonts.googleapis.com/css2?family=Fira+Code&display=swap";background-color:#1b1e23!important;color:#ccc}body.dark code[class*=language-],body.dark pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body.dark code[class*=language-] ::selection,body.dark code[class*=language-]::selection,body.dark pre[class*=language-] ::selection,body.dark pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}body.dark pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body.dark :not(pre)>code[class*=language-],body.dark pre[class*=language-]{background:#2b2b2b}body.dark :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}body.dark .token.cdata,body.dark .token.comment,body.dark .token.prolog{color:gray}body.dark .token.atrule,body.dark .token.boolean,body.dark .token.delimiter,body.dark .token.important,body.dark .token.keyword,body.dark .token.selector{color:#cc7832}body.dark .token.attr-name,body.dark .token.operator,body.dark .token.punctuation{color:#a9b7c6}body.dark .token.builtin,body.dark .token.doctype,body.dark .token.tag,body.dark .token.tag .punctuation{color:#e8bf6a}body.dark .token.entity,body.dark .token.number,body.dark .token.symbol{color:#6897bb}body.dark .token.constant,body.dark .token.property,body.dark .token.variable{color:#9876aa}body.dark .token.char,body.dark .token.string{color:#6a8759}body.dark .token.attr-value,body.dark .token.attr-value .punctuation{color:#a5c261}body.dark .token.attr-value .punctuation:first-child{color:#a9b7c6}body.dark .token.url{color:#287bde;text-decoration:underline}body.dark .token.function{color:#ffc66d}body.dark .token.regex{background:#364135}body.dark .token.bold{font-weight:700}body.dark .token.italic{font-style:italic}body.dark .token.inserted{background:#294436}body.dark .token.deleted{background:#484a4a}body.dark code.language-css .token.property,body.dark code.language-css .token.property+.token.punctuation{color:#a9b7c6}body.dark code.language-css .token.id,body.dark code.language-css .token.selector>.token.attribute,body.dark code.language-css .token.selector>.token.class,body.dark code.language-css .token.selector>.token.pseudo-class,body.dark code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body.dark blockquote{background-color:#333440;color:#aaa}body.dark .date,body.dark .reading-time{color:#bbb!important}body.dark a{color:#ccc!important;font-weight:700}body.dark .post{background-color:#333440}</style><meta name="generator" content="Gatsby 3.14.6"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="avwie&#x27;s programming blog" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-6eddbd64c4246bd21a97.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-4e8c86bd5f82e31157fb.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-e3e290561e79912dfd37.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-8030923d6a02a65604f1.js"/><link as="fetch" rel="preload" href="/page-data/mvi-architecture-in-compose-multiplatform/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav><div class="container"><a href="/">@avwie&#x27;s programming blog</a><div class="social"><a title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a><a class="dark-mode"><img alt="dark-mode" width="24" height="24" src="/layout/dark-mode-48.png"/></a></div></div></nav><main class="container"><h1>Creating an MVI architecture in Compose Multiplatform</h1><h4>30 May, 2022</h4><div><p>Recently I've gotten very interested in Jetpack Compose. I mistakenly thought it was <em>just</em> a way of declaratively building a UI and having it automatically updated in some clever way. Much like <a href="/virtual-dom-in-kotlin">my own virtual DOM implementation</a> but more sophisticated. However, I couldn't have been more wrong. It is an extremely advanced reactive and declarative tree-management runtime which takes full advantage of coroutines and other advanced Kotlin features. It is an extremely ambitious project by the Google and Kotlin teams. The Snapshot system is very intriguing way to solve state and I can highly recommend reading <a href="https://dev.to/zachklipp/series/12895">this series on how Compose handles state</a>, an amazing high quality set of blog posts.</p>
<p>There are a multitude of ways of handling your state in a UI built with Compose and <a href="https://developer.android.com/jetpack/compose/state">the documentation is pretty clear about it</a>. However, lately I am also very interested in a Model-View-Intent (or Model-View-Update for Elm people, please correct me if I am wrong) architecture. And this blog post serves as a way of describing how I built something simple like this in Kotlin Multiplatform with Jetpack Compose. People who know Redux-like systems will notice some obvious similarities.</p>
<h2 id="model-view-intent">Model-View-Intent</h2>
<p>Well, as usual, the definitions differ if you look on the web. But the most common description is as follows:</p>
<ul>
<li>There is a <code class="language-text">Model</code> which represents the state of your application</li>
<li>There is a <code class="language-text">View</code> which renders the <code class="language-text">Model</code> to the user</li>
<li>There is an <code class="language-text">Intent</code> which can be initiated by the user by engaging with the <code class="language-text">View</code></li>
<li>The <code class="language-text">Intent</code> triggers an update of the <code class="language-text">Model</code></li>
<li>Ideally everything is functional, and without side-effects</li>
</ul>
<p>So, schematically it is something like this (schematics courtesy of the amazing <a href="https://excalidraw.com/">Excalidraw</a>):</p>
<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 302px; '>
      <a class='gatsby-resp-image-link' href='/static/d344e1b7fe074774218a9115dcb1d99e/5f1d2/mvi.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 158.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAYAAAASYli2AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEeUlEQVRIx3WWWXPaSBSF9fen5h8kVfMwD5mpSaUq+3ji2MZsthGLjdk3IQmxg0ESEGzQN9WSteCQLrq66eXo3HNv920JxwHxcxy3ij9hHyxziaHUGaotBm5tMug26Xcb7nivXaPXqaM1y+5ayYPAAyIEcvZ7tx3qHczyGevaBataDLv8Hbt6jlU+xSqfYZW/s6qeM8l/ZaQ2kAIAxzmofnkYGTjqNfSyoN3ApAh9GUYFGOS8sUEBu3zK3Oh4gFEAvyyXS8qVKtl0nL1yhdO9Ai1D6fQvBtkvVM/+phH7B0eTQc+wuPuXqdENGVqWxXg8xjAMNE1DURROvp3y5f1b0GUPUM9y/eEPEu9e8/71b2Q+/wk9GdQr7GqMSU9BEmACaDgcst1uA5N3u52nYU/lSblyQQVDxkUY3nrtoABCDl1m10kz0VtI6/XaBXtZfOZqq8qq/I1dO8lj85JtK8m2ccm2EWNbP3f7j604q9J/6K0K0mw2w7Ztd/N+v//JMYvZBL10xaCWpV+V3dor37hjWukGpZimc5uimU8wHhhI/X6fY+VXzhLlx+MT0/ni6Jw0Go0CDReLBfP53PVwFHS/3wVVHATLMtE1zV2z2z2x3+28ut8jCbC7uzsuLi749OkTJycn7n9fgmOl3W6TSqWOM+z1eoFHjzlFtA+LByaTCePJCNNacl8qEk9cst7YjMZDd1y0y+UCSZi6Wq1+eVqEw/L1GPfqBUXlgpIap2JcUh8mKekx7pRz7rsx5PpXrm/PkIReIph9QN/TvrmmZdIeyYwe7+ivCxjrPP0febffX+cZbG4Z/rhDMVMUagkvsIUm0+n0qCYiTpuDG3RbRl2KmqHYPac1SaMuZDQzh2bKtGYJspULD1CwEcet2+26bIUM48nYBRNe9wHFRm2Z5e3XV7x68zvJ248YqzyqeU1rFidXvQzPshcCO1fPzWbjggk5xEcqeoreKotu5tHNHLqVQ5ll6C4yqOYNqpmhPU9zW0t6DKOavSzi0ihrcfqbArqVRbWu6Vk5NDuDZt247IxVgdY8Sa4SQ/Jv61952TRN5NI5950E+eZ3ip04ZTVBRU9SVC7d8WI7zk3lhFJDDgGd51TgpYCXsejp7Fth2xaz2fRZJm/c2Xtrpeet7i4n6B+yfhnsjUaDeDx+dN5zStTMIFF5hI/JII5rrVbzYQ7mJcdPTr5tEXODpPWCrbiIHx4eDmV5XivhEJoY6BnK8JKFH+z+pfxS/8DkKFhobmh2lI1t2WiafnAjBSZHiThhdg5YBswjOdte22i6+py/I7lceNnxM73PjsjrITQ42DQdT6llm1ydZdAUPRIkzjNgCOF7I3DI4RMFJqMpqjxg04BtE4zchL42OG6yEwmXgFrE5D17jMYQJWUQf3dF6kOGdqJHJ6+7c/7HpQPvRt84EdN9DfV6HzU1JP1R5uTNGd3UAOVWx4kCcvBQipyaIOBD785ncxpphUVpg119op7sMOyPDuJWCuKDMKhDJ/187MRF3C4r1AoNhv2fY/F/TcaDVdS8e2gAAAAASUVORK5CYII='); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='Model-View-Intent' title='Model-View-Intent' src='/static/d344e1b7fe074774218a9115dcb1d99e/5f1d2/mvi.png' srcset='/static/d344e1b7fe074774218a9115dcb1d99e/3684f/mvi.png 225w,
/static/d344e1b7fe074774218a9115dcb1d99e/5f1d2/mvi.png 302w' sizes='(max-width: 302px) 100vw, 302px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span></p>
<p>But what is an <code class="language-text">Intent</code>? It is an <em>intent to change the model</em>. But an <em>intent to change</em> can be immediate (e.g. updating the model following a button press) or delayed (e.g. doing a request to a server and based on that update the model again). Based on this distinction, and what I've seen in other architectures, I have decided to go for a different naming scheme and some other tweaks to the definitions:</p>
<ul>
<li>A <code class="language-text">Store</code> contains the current <code class="language-text">State</code>. This is the original <code class="language-text">Model</code></li>
<li>The <code class="language-text">View</code> is still the same and models a UI based on the <code class="language-text">State</code> received from the <code class="language-text">Store</code></li>
<li>The <code class="language-text">View</code> can <code class="language-text">dispatch</code> an <code class="language-text">Intent</code> on the <code class="language-text">Store</code> but the <code class="language-text">Intent</code> is now either an <code class="language-text">Action</code> or an <code class="language-text">Effect</code></li>
<li>An <code class="language-text">Action</code> will result in a new <code class="language-text">State</code> the <code class="language-text">Store</code> using an <code class="language-text">ActionReducer</code></li>
<li>An <code class="language-text">Effect</code> will result in a separate routine to be launched which executes the <code class="language-text">Effect</code> and based on that optionally dispatch some other <code class="language-text">Action</code> or <code class="language-text">Effect</code></li>
</ul>
<p>So, the schematic is now updated like this:</p>
<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 730px; '>
      <a class='gatsby-resp-image-link' href='/static/06e402f1aa48b5c1fccf71f85a8eae99/e9beb/architecture.png' style='display: block' target='_blank' rel='noopener'>
    <span class='gatsby-resp-image-background-image' style="padding-bottom: 93.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACpElEQVQ4y3WU227bRhCG9f4P0ZsCvSxaFAnQXrROACFpDm4Q25Jsq9SRpCiel7s8SeJX7FKkJMsdYMnh7My/88/OcNAATaOfUKiSdJOR+YrITajL2ti7/VaHXKbkYkOdB8jYpq6K3m9AA82hDRCe4stvdwx//sz6k0/sJxRl0YMFvs9iuWazHPH06Sdub34gmL6llMEJUD86wMQVfH1zx9e335l/dAi9iLVtU9c7RJZxf3+PVCVZtMQZ/cLd8Eec0a+U0n8BeKRUFhVpkLGybAOmxXHWZCJFSkEchca2r0vs+ZjQmyNTj7ouLymf1ymKI/zAR+XK1Gu+3LDZJmx9gbdN0GTKqmI6tUiFPKttG9/WUGfJKdM4jkmSmLXjczvKGX7Z8vku5fZB4mxCZrN/qaqqBToc+rhjhs2FQUu92xEEPo/PC74/H/hzaHPz0TW6tunDtBwOhz6ujT2r4flqs4xw3C1PluDREkwXEmuV47pbkiTpKnUVO+AVybIMpfL+e7ercJ01i8XMUN3v96Ysr8nAcRz0CsMQ27ZRSiGEuKCU5zmTyYTReExRFP2h2k9KafZ11lofaCWKIgOk9bquzftckligsmPGR64axPM8ZrMZrutiWZZJ6FXK2lmIDCEjltsHs1b+iHUwYbevKIvS+LxK+f8upchLFs4z8/QD3+Z/MN78xeP2HVHik6vT7B6ObdO9DSAvwJqmrZ0XrbDiIWP3hif/PRPvHYkIr263/+bYh5imvnbKC0UoXBx/jhssCBKH3f7yD9QBdUkNToZjxV80uZY0EchM9b+vy0Ew0XRMB80Jo3XmenJkJsmVus6sOSXSHTToe+Fsni8uRxV8+/2B2T+rnsnF7HcM6UbvxSxydklmrqua579nbKb+1dxypnc4/wEP5L1rP5J9IAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"></span>
  <img class='gatsby-resp-image-image' alt='Architecture' title='Architecture' src='/static/06e402f1aa48b5c1fccf71f85a8eae99/e9beb/architecture.png' srcset='/static/06e402f1aa48b5c1fccf71f85a8eae99/3684f/architecture.png 225w,
/static/06e402f1aa48b5c1fccf71f85a8eae99/fc2a6/architecture.png 450w,
/static/06e402f1aa48b5c1fccf71f85a8eae99/e9beb/architecture.png 730w' sizes='(max-width: 730px) 100vw, 730px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>
  </a>
    </span></p>
<h3 id="coding-it-up">Coding it up</h3>
<p>To code this up I don't want to be limited to any platform-specifics, so as always I try to keep it as platform agnostic as possible and will work in some common code first. First let's layout the contracts:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> ActionDispatcher<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span>action<span class="token operator">:</span> A<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> EffectDispatcher<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">dispatchEffect</span><span class="token punctuation">(</span>effect<span class="token operator">:</span> E<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> Dispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token operator">:</span> ActionDispatcher<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">,</span> EffectDispatcher<span class="token operator">&lt;</span>E<span class="token operator">></span></code></pre></div>
<p>However, I was talking about the <code class="language-text">Effect</code> being handled in a separate routine. This sounds like a job for coroutines, so I'll add another interface to handle this case. The non-suspending one will come handy later.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> SuspendingEffectDispatcher<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">dispatchEffect</span><span class="token punctuation">(</span>effect<span class="token operator">:</span> E<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> SuspendingDispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token operator">:</span> ActionDispatcher<span class="token operator">&lt;</span>A<span class="token operator">></span><span class="token punctuation">,</span> SuspendingEffectDispatcher<span class="token operator">&lt;</span>E<span class="token operator">></span>

<span class="token keyword">interface</span> Store<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token operator">:</span> SuspendingDispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> state<span class="token operator">:</span> StateFlow<span class="token operator">&lt;</span>S<span class="token operator">></span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen we are using the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow/">StateFlow</a> here to represent <code class="language-text">State</code>. It plays very well with Compose and is a good way to represent changing state.</p>
<p>And finally we also need to define the action reducer and effect handler:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token keyword">interface</span> ActionReducer<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">handleAction</span><span class="token punctuation">(</span>state<span class="token operator">:</span> S<span class="token punctuation">,</span> action<span class="token operator">:</span> A<span class="token punctuation">)</span><span class="token operator">:</span> S
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token keyword">interface</span> EffectHandler<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">handleEffect</span><span class="token punctuation">(</span>
        state<span class="token operator">:</span> StateFlow<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">,</span>
        effect<span class="token operator">:</span> E<span class="token punctuation">,</span>
        suspendingDispatcher<span class="token operator">:</span> SuspendingDispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen, the <code class="language-text">EffectHandler</code> gets a reference to the <code class="language-text">StateFlow</code>. This makes sure it only reads the state at the moment it requires it and not the state it was provided with.</p>
<p>Wiring up everything in an implementation of <code class="language-text">Store</code> is now trivially simple:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> StoreImpl<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span><span class="token punctuation">(</span>
    initialState<span class="token operator">:</span> S<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> actionReducer<span class="token operator">:</span> ActionReducer<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> effectHandler<span class="token operator">:</span> EffectHandler<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Store<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> _state <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> state <span class="token operator">=</span> _state<span class="token punctuation">.</span><span class="token function">asStateFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span>action<span class="token operator">:</span> A<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _state<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">{</span> state <span class="token operator">-></span> actionReducer<span class="token punctuation">.</span><span class="token function">handleAction</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">dispatchEffect</span><span class="token punctuation">(</span>effect<span class="token operator">:</span> E<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effectHandler<span class="token punctuation">.</span><span class="token function">handleEffect</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token label symbol">@StoreImpl</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// and to construct it from a Store:</span>
<span class="token keyword">interface</span> Store<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token operator">:</span> SuspendingDispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> state<span class="token operator">:</span> StateFlow<span class="token operator">&lt;</span>S<span class="token operator">></span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token function">invoke</span><span class="token punctuation">(</span>
            initialState<span class="token operator">:</span> S<span class="token punctuation">,</span>
            actionReducer<span class="token operator">:</span> ActionReducer<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token operator">></span><span class="token punctuation">,</span>
            effectHandler<span class="token operator">:</span> EffectHandler<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>S<span class="token punctuation">,</span> A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">StoreImpl</span><span class="token punctuation">(</span>initialState<span class="token punctuation">,</span> actionReducer<span class="token punctuation">,</span> effectHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="testing-it">Testing it</h3>
<p>This was pretty simple to program, so it is important to test it as well. To do this we create a <code class="language-text">common</code> test and we will be using the <code class="language-text">runTest</code> facility provided by the <code class="language-text">org.jetbrains.kotlinx:kotlinx-coroutines-test</code> module.</p>
<p>First we define our actions and effects as algebraic data types:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">sealed</span> <span class="token keyword">interface</span> Action <span class="token punctuation">{</span>
    <span class="token keyword">object</span> Uppercase <span class="token operator">:</span> Action
    <span class="token keyword">object</span> Lowercase<span class="token operator">:</span> Action
    <span class="token keyword">object</span> Reverse<span class="token operator">:</span> Action
<span class="token punctuation">}</span>

<span class="token keyword">sealed</span> <span class="token keyword">interface</span> Effect <span class="token punctuation">{</span>
    <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">DelayedAction</span><span class="token punctuation">(</span><span class="token keyword">val</span> delay<span class="token operator">:</span> Long<span class="token punctuation">,</span> <span class="token keyword">val</span> action<span class="token operator">:</span> Action<span class="token punctuation">)</span> <span class="token operator">:</span> Effect
<span class="token punctuation">}</span></code></pre></div>
<p>Then we define our reducer and our handler</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">val</span> actionReducer <span class="token operator">=</span> ActionReducer<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Action<span class="token operator">></span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> action <span class="token operator">-></span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Action<span class="token punctuation">.</span>Uppercase <span class="token operator">-></span> state<span class="token punctuation">.</span><span class="token function">uppercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Action<span class="token punctuation">.</span>Lowercase <span class="token operator">-></span> state<span class="token punctuation">.</span><span class="token function">lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        Action<span class="token punctuation">.</span>Reverse <span class="token operator">-></span> state<span class="token punctuation">.</span><span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">val</span> effectHandler <span class="token operator">=</span> EffectHandler<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Action<span class="token punctuation">,</span> Effect<span class="token operator">></span> <span class="token punctuation">{</span> _<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> dispatcher <span class="token operator">-></span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">is</span> Effect<span class="token punctuation">.</span>DelayedAction <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token function">delay</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>delay<span class="token punctuation">)</span> <span class="token comment">// we are in a suspend function so we can use delay</span>
            dispatcher<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>action<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Finally we test everything with the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-test/kotlinx.coroutines.test/run-test.html"><code class="language-text">runTest</code></a> function. This takes care of the heavy lifting and does some fancy pantsy things with delays. It is important to read the documentation about it.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Test</span>
<span class="token keyword">fun</span> <span class="token function">testActionsAndEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runTest <span class="token punctuation">{</span>
    <span class="token keyword">val</span> store <span class="token operator">=</span> <span class="token function">Store</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> actionReducer<span class="token punctuation">,</span> effectHandler<span class="token punctuation">)</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    store<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">.</span>Uppercase<span class="token punctuation">)</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"FOO"</span></span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    store<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">.</span>Lowercase<span class="token punctuation">)</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    store<span class="token punctuation">.</span><span class="token function">dispatchEffect</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">DelayedAction</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> Action<span class="token punctuation">.</span>Reverse<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"oof"</span></span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>However, to be extra extra sure the effect actually fires in a separate coroutine, lets write another test to show that it actually delays:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Test</span>
<span class="token keyword">fun</span> <span class="token function">testLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runTest <span class="token punctuation">{</span>
    <span class="token keyword">val</span> store <span class="token operator">=</span> <span class="token function">Store</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> actionReducer<span class="token punctuation">,</span> effectHandler<span class="token punctuation">)</span>

    launch <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span><span class="token function">dispatchEffect</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">DelayedAction</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> Action<span class="token punctuation">.</span>Reverse<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"oof"</span></span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// this is in same coroutine as the effect, so this will run after 2000ms</span>
    <span class="token punctuation">}</span>
    <span class="token function">assertNotEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"oof"</span></span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// this runs directly after launching the coroutine, so it will still be "foo"</span>
    <span class="token function">advanceUntilIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// a convenience function that waits until all tasks are completed</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"oof"</span></span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// all tasks in the coroutine are completed and the value is reversed</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And this works as expected!</p>
<h2 id="creating-an-xkcd-comic-browser-in-compose-for-web">Creating an XKCD comic browser in Compose for Web</h2>
<p>So now it is time to create a very simple web application using this architecture. I have chosen to go for a simple web application that shows XKCD comics via <a href="https://xkcd.vercel.app/">this API</a>.</p>
<p>I want to be able to do the following:</p>
<ul>
<li>Get the latest comic</li>
<li>Get the next one</li>
<li>Get the previous one</li>
<li>Get a random one</li>
</ul>
<h3 id="creating-the-store">Creating the Store</h3>
<p>So we need to have some sort of state like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">State</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> comicCount<span class="token operator">:</span> Int<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token keyword">val</span> currentComic<span class="token operator">:</span> Comic<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Comic</span><span class="token punctuation">(</span><span class="token keyword">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">val</span> title<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> img<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> alt<span class="token operator">:</span> String<span class="token punctuation">)</span></code></pre></div>
<p>Based on how we want the UI to change we can define our <code class="language-text">Actions</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">sealed</span> <span class="token keyword">interface</span> Action <span class="token punctuation">{</span>
    <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">SetComicCount</span><span class="token punctuation">(</span><span class="token keyword">val</span> count<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Action
    <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">SetComic</span><span class="token punctuation">(</span><span class="token keyword">val</span> comic<span class="token operator">:</span> Comic<span class="token punctuation">)</span> <span class="token operator">:</span> Action
<span class="token punctuation">}</span></code></pre></div>
<p>And since we have side-effects (loading data) we can define our <code class="language-text">Effects</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">sealed</span> <span class="token keyword">interface</span> Effect <span class="token punctuation">{</span>
    <span class="token keyword">object</span> LoadLatestComic <span class="token operator">:</span> Effect
    <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">LoadComic</span><span class="token punctuation">(</span><span class="token keyword">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> Effect
<span class="token punctuation">}</span></code></pre></div>
<p>Our <code class="language-text">ActionReducer</code> is pretty straightforward, as it should be:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> actionReducer <span class="token operator">=</span> ActionReducer<span class="token operator">&lt;</span>State<span class="token punctuation">,</span> Action<span class="token operator">></span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> action <span class="token operator">-></span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">is</span> Action<span class="token punctuation">.</span>SetComicCount <span class="token operator">-></span> state<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>comicCount <span class="token operator">=</span> action<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
        <span class="token keyword">is</span> Action<span class="token punctuation">.</span>SetComic <span class="token operator">-></span> state<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>currentComic <span class="token operator">=</span> action<span class="token punctuation">.</span>comic<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Our <code class="language-text">EffectHandler</code> is a little bit more complicated but still very easy:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> effectHandler <span class="token operator">=</span> EffectHandler<span class="token operator">&lt;</span>State<span class="token punctuation">,</span> Action<span class="token punctuation">,</span> Effect<span class="token operator">></span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> dispatcher <span class="token operator">-></span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Effect<span class="token punctuation">.</span>LoadLatestComic <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> latestComic <span class="token operator">=</span> <span class="token function">makeXKCDRequest</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"latest"</span></span><span class="token punctuation">)</span>
            dispatcher<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">.</span><span class="token function">SetComicCount</span><span class="token punctuation">(</span>latestComic<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
            dispatcher<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">.</span><span class="token function">SetComic</span><span class="token punctuation">(</span>latestComic<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">is</span> Effect<span class="token punctuation">.</span>LoadComic <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> comic <span class="token operator">=</span> <span class="token function">makeXKCDRequest</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            dispatcher<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span>Action<span class="token punctuation">.</span><span class="token function">SetComic</span><span class="token punctuation">(</span>comic<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">expect</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">makeXKCDRequest</span><span class="token punctuation">(</span>id<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Comic <span class="token comment">// we are still in common code</span></code></pre></div>
<p>The most important aspect here is that we <code class="language-text">expect</code> platform-specific code to provide an <code class="language-text">makeKXCDRequest</code> function which returns a <code class="language-text">Comic</code> based on a string (<code class="language-text">id</code> can be a number or <code class="language-text">latest</code>).</p>
<p>And finally, the <code class="language-text">Store</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> store <span class="token operator">=</span> <span class="token function">Store</span><span class="token punctuation">(</span><span class="token function">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actionReducer<span class="token punctuation">,</span> effectHandler<span class="token punctuation">)</span></code></pre></div>
<h3 id="building-the-ui-in-compose-for-web">Building the UI in Compose for Web</h3>
<p>I am going to use Compose for Web for this, for reasons that it is easy to set up and I have little Android experience. Compose plays very well with Coroutines and <code class="language-text">StateFlow</code> so it is actually a breeze to setup:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">renderComposable</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"root"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                              <span class="token comment">// 1.</span>
        <span class="token keyword">val</span> state <span class="token keyword">by</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collectAsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">// 2.</span>
        <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>                              <span class="token comment">// 3.</span>
            store<span class="token punctuation">.</span><span class="token function">dispatchEffect</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span>LoadLatestComic<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ... actual building of UI</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Some imporant things happening here:</p>
<ol>
<li>This is the main function that builds the composable UI. It mounts the UI to an element in your DOM with the ID you pass it. So that's <code class="language-text">root</code> here.</li>
<li>We create a <code class="language-text">State&lt;T></code> (not to be confused with our own <code class="language-text">State</code>, but the one from Compose Runtime) by using the <code class="language-text">StateFlow&lt;State>.collectAsState()</code> method. This will subscribe to the <code class="language-text">StateFlow</code> and expose it as a reactive <code class="language-text">State</code> object. This is amazing how easy it is.</li>
<li>We immediately launch a composable effect, with a dependency on <code class="language-text">Unit</code> so it will only run on startup, where we dispatch to the store that we want to load the latest comic.</li>
</ol>
<h4 id="side-note-dispatching-from-within-elements">Side note: Dispatching from within elements</h4>
<p>When we want to dispatch an effect from within an element, we need to have a reference to some CoroutineScope and launch it, since <code class="language-text">dispatchEffect</code> is suspending. So that becomes something like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// ... within renderComposable</span>
<span class="token keyword">val</span> scope <span class="token operator">=</span> <span class="token function">rememberCoroutineScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">Button</span><span class="token punctuation">(</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span>
    onClick <span class="token punctuation">{</span> 
        scope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
           store<span class="token punctuation">.</span><span class="token function">dispatchEffect</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">LoadComic</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>comicCount<span class="token operator">!!</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Random"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This doesn't make me happy, so I decided to code something up to make it a little bit more composable. We will be creating a <code class="language-text">ScopedDispatcher</code>, so not a suspending one like before, which has a <code class="language-text">SuspendingDispatcher</code> to delegate to. The <code class="language-text">ScopedDispatcher</code> has its own coroutine scope. We will be using this one to do all our dispatching to.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> ScopedDispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> suspendingDispatcher<span class="token operator">:</span> SuspendingDispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> coroutineContext<span class="token operator">:</span> CoroutineContext
<span class="token punctuation">)</span> <span class="token operator">:</span> CoroutineScope<span class="token punctuation">,</span> Dispatcher<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span>action<span class="token operator">:</span> A<span class="token punctuation">)</span> <span class="token operator">=</span> suspendingDispatcher<span class="token punctuation">.</span><span class="token function">dispatchAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">dispatchEffect</span><span class="token punctuation">(</span>effect<span class="token operator">:</span> E<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        launch <span class="token punctuation">{</span>
            suspendingDispatcher<span class="token punctuation">.</span><span class="token function">dispatchEffect</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation builtin">@JvmName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"invokeAction"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>action<span class="token operator">:</span> A<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>

    <span class="token annotation builtin">@JvmName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"invokeEffect"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token function">invoke</span><span class="token punctuation">(</span>effect<span class="token operator">:</span> E<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">dispatchEffect</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">val</span> LocalSuspendingDispatcher <span class="token operator">=</span> compositionLocalOf<span class="token operator">&lt;</span>SuspendingDispatcher<span class="token operator">&lt;</span>Action<span class="token punctuation">,</span> Effect<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span> store <span class="token punctuation">}</span> <span class="token comment">// store provided earlier</span>

<span class="token annotation builtin">@Composable</span>
<span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token function">rememberDispatcher</span><span class="token punctuation">(</span>
    getContext<span class="token operator">:</span> <span class="token annotation builtin">@DisallowComposableCalls</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> CoroutineContext <span class="token operator">=</span> <span class="token punctuation">{</span> Dispatchers<span class="token punctuation">.</span>Main <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ScopedDispatcher<span class="token operator">&lt;</span>Action<span class="token punctuation">,</span> Effect<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> scope <span class="token operator">=</span> <span class="token function">rememberCoroutineScope</span><span class="token punctuation">(</span>getContext<span class="token punctuation">)</span>
    <span class="token keyword">val</span> dispatcher <span class="token operator">=</span> LocalSuspendingDispatcher<span class="token punctuation">.</span>current
    <span class="token keyword">return</span> <span class="token function">ScopedDispatcher</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">,</span> scope<span class="token punctuation">.</span>coroutineContext<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And now we can write the earlier snippet like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// ... within renderComposable</span>
<span class="token keyword">val</span> dispatch <span class="token operator">=</span> <span class="token function">rememberDispatcher</span><span class="token punctuation">(</span> <span class="token comment">// ... one can provide a context if needed ) </span>

<span class="token function">Button</span><span class="token punctuation">(</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span>
    onClick <span class="token punctuation">{</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">LoadComic</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>comicCount<span class="token operator">!!</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Random"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This makes it much cleaner, <em>and</em> <code class="language-text">rememberDispatcher</code> can be called everywhere thanks to the <code class="language-text">CompositionLocal</code> provider.</p>
<h3 id="the-final-ui">The final UI</h3>
<p>The final JS file looks like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">actual</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">makeXKCDRequest</span><span class="token punctuation">(</span>id<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Comic <span class="token operator">=</span> <span class="token function">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{</span> client <span class="token operator">-></span>
    <span class="token keyword">val</span> response<span class="token operator">:</span> String <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"https://xkcd.vercel.app/?comic=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">id</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> json <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parse<span class="token operator">&lt;</span><span class="token keyword">dynamic</span><span class="token operator">></span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token function">Comic</span><span class="token punctuation">(</span>id <span class="token operator">=</span> json<span class="token punctuation">.</span>num <span class="token keyword">as</span> Int<span class="token punctuation">,</span> title <span class="token operator">=</span> json<span class="token punctuation">.</span>title <span class="token keyword">as</span> String<span class="token punctuation">,</span> img <span class="token operator">=</span> json<span class="token punctuation">.</span>img <span class="token keyword">as</span> String<span class="token punctuation">,</span> alt <span class="token operator">=</span> json<span class="token punctuation">.</span>alt <span class="token keyword">as</span> String<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">renderComposable</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"root"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> state <span class="token keyword">by</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collectAsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> dispatch <span class="token operator">=</span> <span class="token function">rememberDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dispatch</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span>LoadLatestComic<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>currentComic <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            P <span class="token punctuation">{</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Loading ...."</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> comic <span class="token operator">=</span> state<span class="token punctuation">.</span>currentComic<span class="token operator">!!</span>
            
            H1 <span class="token punctuation">{</span> <span class="token function">Text</span><span class="token punctuation">(</span>comic<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token function">Img</span><span class="token punctuation">(</span>src <span class="token operator">=</span> comic<span class="token punctuation">.</span>img<span class="token punctuation">)</span>
            P <span class="token punctuation">{</span> <span class="token function">Text</span><span class="token punctuation">(</span>comic<span class="token punctuation">.</span>alt<span class="token punctuation">)</span> <span class="token punctuation">}</span>
            
            <span class="token function">Button</span><span class="token punctuation">(</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>comic<span class="token punctuation">.</span>id <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">disabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                onClick <span class="token punctuation">{</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">LoadComic</span><span class="token punctuation">(</span>comic<span class="token punctuation">.</span>id <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Previous"</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

            <span class="token function">Button</span><span class="token punctuation">(</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span>
                onClick <span class="token punctuation">{</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">LoadComic</span><span class="token punctuation">(</span>Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>comicCount<span class="token operator">!!</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Random"</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span>

            <span class="token function">Button</span><span class="token punctuation">(</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>comic<span class="token punctuation">.</span>id <span class="token operator">==</span> state<span class="token punctuation">.</span>comicCount<span class="token punctuation">)</span> <span class="token function">disabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                onClick <span class="token punctuation">{</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">LoadComic</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>comicCount<span class="token operator">!!</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Latest"</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span>

            <span class="token function">Button</span> <span class="token punctuation">(</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>comic<span class="token punctuation">.</span>id <span class="token operator">==</span> state<span class="token punctuation">.</span>comicCount<span class="token punctuation">)</span> <span class="token function">disabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                onClick <span class="token punctuation">{</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>Effect<span class="token punctuation">.</span><span class="token function">LoadComic</span><span class="token punctuation">(</span>comic<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Text</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Next"</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen we can easily disable and enable buttons based on the state, the dispatching looks very easy and clear, and the full MVI implementation is in common code and easily testable!</p>
<p>And it works like a charm:</p>
<p><img src="/static/xkcd-55a749d4f7f4338c24d302aaa7fa62f5.gif" alt="Final UI"></p>
<h2 id="closing-remarks">Closing remarks</h2>
<p>I really enjoyed creating this architecture. I am a big fan of simple functional state updates and declarative effects.  The challenge for me is always to keep it as platform-agnostic as possible and this was very very easy. I must say I am very impressed with the ease of how Compose works. I can highly recommend you check it out!</p>
<p>If you want to ask questions, don't hesitate to contact me via Github, or look at <a href="https://github.com/avwie/scribbles/tree/d564b414139ba813bda8a7b12d779c58ff573819/kotlin/examples/mvi-demo">my repository of the coding examples</a>. </p></div></main><footer class="container"><p>Build <!-- -->8702bce<!-- --> - <!-- -->2022-08-05T08:01:04.000Z</p></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YZ9NCTW594"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YZ9NCTW594', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/mvi-architecture-in-compose-multiplatform";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-4e8c86bd5f82e31157fb.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-a877529cf1e94834f497.js"],"component---src-templates-post-js":["/component---src-templates-post-js-8030923d6a02a65604f1.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-8030923d6a02a65604f1.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-e3e290561e79912dfd37.js" async=""></script><script src="/app-4e8c86bd5f82e31157fb.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-6eddbd64c4246bd21a97.js" async=""></script></body></html>