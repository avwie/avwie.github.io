<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="This is my programming blog where I write articles about experiments that I&#x27;ve done. Some are successful, some are not, but we learn from all."/><title>avwie&#x27;s programming blog</title><style data-href="/styles.7475f729b3dc85f53ec4.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap);@import url(https://fontlibrary.org//face/go-mono);body{background-color:#f3f3f3;font-family:Crimson Text,serif;font-size:14pt;margin:0}body code[class*=language-],body pre[class*=language-]{word-wrap:normal;background:none;color:#111b27;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body code[class*=language-] ::selection,body code[class*=language-]::selection,body pre[class*=language-] ::selection,body pre[class*=language-]::selection{background:#8da1b9}body pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body :not(pre)>code[class*=language-],body pre[class*=language-]{background:#e3eaf2}body :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em .3em;white-space:normal}body .token.cdata,body .token.comment,body .token.doctype,body .token.prolog{color:#3c526d}body .token.punctuation{color:#111b27}body .token.delimiter.important,body .token.selector .parent,body .token.tag,body .token.tag .token.punctuation{color:#006d6d}body .token.attr-name,body .token.boolean,body .token.boolean.important,body .token.constant,body .token.number,body .token.selector .token.attribute{color:#755f00}body .token.class-name,body .token.key,body .token.parameter,body .token.property,body .token.property-access,body .token.variable{color:#005a8e}body .token.attr-value,body .token.color,body .token.inserted,body .token.selector .token.value,body .token.string,body .token.string .token.url-link{color:#116b00}body .token.builtin,body .token.keyword-array,body .token.package,body .token.regex{color:#af00af}body .token.function,body .token.selector .token.class,body .token.selector .token.id{color:#7c00aa}body .token.atrule .token.rule,body .token.combinator,body .token.keyword,body .token.operator,body .token.pseudo-class,body .token.pseudo-element,body .token.selector,body .token.unit{color:#a04900}body .token.deleted,body .token.important{color:#c22f2e}body .token.keyword-this,body .token.this{color:#005a8e}body .token.bold,body .token.important,body .token.keyword-this,body .token.this{font-weight:700}body .token.delimiter.important{font-weight:inherit}body .token.italic{font-style:italic}body .token.entity{cursor:help}body .language-markdown .token.title,body .language-markdown .token.title .token.punctuation{color:#005a8e;font-weight:700}body .language-markdown .token.blockquote.punctuation{color:#af00af}body .language-markdown .token.code{color:#006d6d}body .language-markdown .token.hr.punctuation{color:#005a8e}body .language-markdown .token.url>.token.content{color:#116b00}body .language-markdown .token.url-link{color:#755f00}body .language-markdown .token.list.punctuation{color:#af00af}body .language-json .token.operator,body .language-markdown .token.table-header{color:#111b27}body .language-scss .token.variable{color:#006d6d}body .token.cr:before,body .token.lf:before,body .token.space:before,body .token.tab:not(:empty):before{color:#3c526d}body div.code-toolbar>.toolbar a,body div.code-toolbar>.toolbar button{background:#005a8e;color:#e3eaf2}body div.code-toolbar>.toolbar a:focus,body div.code-toolbar>.toolbar a:hover,body div.code-toolbar>.toolbar button:focus,body div.code-toolbar>.toolbar button:hover{background:rgba(0,90,142,.855);color:#e3eaf2;text-decoration:none}body div.code-toolbar>.toolbar span,body div.code-toolbar>.toolbar span:focus,body div.code-toolbar>.toolbar span:hover{background:#3c526d;color:#e3eaf2}body .line-highlight{background:rgba(141,161,185,.184);background:linear-gradient(90deg,rgba(141,161,185,.184) 70%,rgba(141,161,185,.145))}body .line-highlight:before,body .line-highlight[data-end]:after{background-color:#3c526d;box-shadow:0 1px #8da1b9;color:#e3eaf2}body pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(60,82,109,.122)}body .line-numbers .line-numbers-rows{background:rgba(208,218,231,.478);border-right:1px solid rgba(141,161,185,.478)}body .line-numbers-rows>span:before{color:rgba(60,82,109,.855)}body .rainbow-braces .token.punctuation.brace-level-1,body .rainbow-braces .token.punctuation.brace-level-5,body .rainbow-braces .token.punctuation.brace-level-9{color:#755f00}body .rainbow-braces .token.punctuation.brace-level-10,body .rainbow-braces .token.punctuation.brace-level-2,body .rainbow-braces .token.punctuation.brace-level-6{color:#af00af}body .rainbow-braces .token.punctuation.brace-level-11,body .rainbow-braces .token.punctuation.brace-level-3,body .rainbow-braces .token.punctuation.brace-level-7{color:#005a8e}body .rainbow-braces .token.punctuation.brace-level-12,body .rainbow-braces .token.punctuation.brace-level-4,body .rainbow-braces .token.punctuation.brace-level-8{color:#7c00aa}body pre.diff-highlight>code .token.deleted:not(.prefix),body pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(194,47,46,.122)}body pre.diff-highlight>code .token.inserted:not(.prefix),body pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(17,107,0,.122)}body .command-line-prompt{border-right:1px solid rgba(141,161,185,.478)}body .command-line-prompt>span:before{color:rgba(60,82,109,.855)}body a{color:#686868}body blockquote{background-color:#eee;color:#555;padding:1em}body blockquote p{margin:0}body nav{background-color:#000;padding:.5em 0;width:100vw}body nav *{color:#fff}body nav .social,body nav>.container{display:flex;flex-direction:row;justify-content:space-between}body nav .social{width:150px}body nav .social a{align-items:center;display:flex;justify-content:center}body nav .social a.dark-mode{cursor:pointer}body nav .social img{height:24px;width:24px}body .container{margin:0 1em}@media(min-width:900px){body .container{margin:0 auto;padding:0 1em;width:900px}}body .posts .post{background-color:#eee;margin-bottom:2em;padding:.5em}body .posts .post h2{margin:0}body .posts .post p{margin:.5em 0}body .posts .post .date,body .posts .post .reading-time{color:#333;font-size:.8em}body .posts .post a{font-weight:700}body footer{font-size:.8rem}code[class*=language-],pre[class*=language-]{border-radius:.5em;font-family:GoMonoRegular!important;font-size:.85rem!important;font-style:normal!important;font-weight:400!important}body.dark{@import"https://fonts.googleapis.com/css2?family=Fira+Code&display=swap";background-color:#1b1e23!important;color:#ccc}body.dark code[class*=language-],body.dark pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body.dark code[class*=language-] ::selection,body.dark code[class*=language-]::selection,body.dark pre[class*=language-] ::selection,body.dark pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}body.dark pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body.dark :not(pre)>code[class*=language-],body.dark pre[class*=language-]{background:#2b2b2b}body.dark :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}body.dark .token.cdata,body.dark .token.comment,body.dark .token.prolog{color:gray}body.dark .token.atrule,body.dark .token.boolean,body.dark .token.delimiter,body.dark .token.important,body.dark .token.keyword,body.dark .token.selector{color:#cc7832}body.dark .token.attr-name,body.dark .token.operator,body.dark .token.punctuation{color:#a9b7c6}body.dark .token.builtin,body.dark .token.doctype,body.dark .token.tag,body.dark .token.tag .punctuation{color:#e8bf6a}body.dark .token.entity,body.dark .token.number,body.dark .token.symbol{color:#6897bb}body.dark .token.constant,body.dark .token.property,body.dark .token.variable{color:#9876aa}body.dark .token.char,body.dark .token.string{color:#6a8759}body.dark .token.attr-value,body.dark .token.attr-value .punctuation{color:#a5c261}body.dark .token.attr-value .punctuation:first-child{color:#a9b7c6}body.dark .token.url{color:#287bde;text-decoration:underline}body.dark .token.function{color:#ffc66d}body.dark .token.regex{background:#364135}body.dark .token.bold{font-weight:700}body.dark .token.italic{font-style:italic}body.dark .token.inserted{background:#294436}body.dark .token.deleted{background:#484a4a}body.dark code.language-css .token.property,body.dark code.language-css .token.property+.token.punctuation{color:#a9b7c6}body.dark code.language-css .token.id,body.dark code.language-css .token.selector>.token.attribute,body.dark code.language-css .token.selector>.token.class,body.dark code.language-css .token.selector>.token.pseudo-class,body.dark code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body.dark blockquote{background-color:#333440;color:#aaa}body.dark .date,body.dark .reading-time{color:#bbb!important}body.dark a{color:#ccc!important;font-weight:700}body.dark .post{background-color:#333440}</style><meta name="generator" content="Gatsby 3.14.6"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="avwie&#x27;s programming blog" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-6eddbd64c4246bd21a97.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-4e8c86bd5f82e31157fb.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-e3e290561e79912dfd37.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-8030923d6a02a65604f1.js"/><link as="fetch" rel="preload" href="/page-data/virtual-dom-in-kotlin/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav><div class="container"><a href="/">@avwie&#x27;s programming blog</a><div class="social"><a title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a><a class="dark-mode"><img alt="dark-mode" width="24" height="24" src="/layout/dark-mode-48.png"/></a></div></div></nav><main class="container"><h1>Building a multiplatform virtual DOM in Kotlin</h1><h4>19 Apr, 2022</h4><div><p>Based on <a href="/dom-dsl-in-kotlin">my previous blog post about a multiplatform DOM DSL</a> I got some more inspiration. I used an NPM library called <a href="https://www.npmjs.com/package/virtual-dom">virtual-dom</a> to implement a virtual DOM in the JS part. It got me thinking.... how easy would it be to do it myself? I know virtual DOM libraries are a dime a dozen, and most of them are heavily optimized. It is futile to think I could make something better than say.... React. However, how easy would it be to have something that works <em>good enough</em>? Well, as it turned out, it was pretty easy. </p>
<h2 id="what-is-a-virtual-dom-and-why-would-we-need-it">What is a virtual DOM and why would we need it?</h2>
<p>These are very good questions to ask, so it is important to answer them. To start off, it is important to establish what a DOM exactly is. It is a <a href="https://en.wikipedia.org/wiki/Document_Object_Model">Document Object Model</a> which describes in an object-oriented way how a document (XML or HTML) is structured. It models this as a tree of nodes and attributes.</p>
<p>The upside of using a DOM to render XML (and by extension HTML) documents is that it is a cross-platform method and it maps pretty easily to our mental image of this structure. Also, the methods for manipulating the DOM are more or less the same in every language. This results in the fact that the DOM is also used for rendering the browser contents. Every single HTML tag is a DOM node.</p>
<p>The downside of the DOM in the browser is that it is <em>slow</em> to construct. A single node contains a lot of information and state. It isn't just a simple tag with some attributes. It contains event-handlers, prototype information, methods and what not. Constructing them is expensive. When they are created, and thus allocated, interacting with them is actually pretty fast.</p>
<p>However, in the recent years the interest of some part of the web community has shifted to functional programming (FP). What if we could interact with web pages functionally? What if we could have a dynamic web experience, but functional? This is orthagonal to the OOP way of manipulating the webpage by the DOM methods. In the OOP approach, changes to the state of the application need to be reflected by calling the methods on the DOM elements in the browser. However, in FP we would like to have a <em>pure</em> function (which means it has no side effects) that takes a certain state and returns a result, say HTML. It has a lot of benefits over OOP for complex presentation logic, but it is a bit out of scope for this post. </p>
<p>The naive thing to do would be to just generate fresh HTML and replace everything inside the browser with the fresh HTML. Like a game would work. Every 1/60th of a second the screen is refreshed and completely redrawn. However, as we just learned, the creation of DOM nodes is slow. So this would make for a very suboptimal solution.</p>
<p>I <em>think</em> it was React (but I might be wrong) that came up with the idea of using a virtual DOM. The general idea is like this: What if we have a way of modelling the DOM using very cheap elements (cheap to allocate in both memory and time) and render that to the browser once. Then, after every application-state change, recreate the virtual DOM (cheap), and compare the new virtual DOM with the old one and only update the actual elements in the browser that are different between the old and the new virtual DOM. This process is called <a href="https://reactjs.org/docs/reconciliation.html">reconciliation by React</a>. </p>
<h2 id="creating-a-virtual-dom-representation">Creating a virtual DOM representation</h2>
<h3 id="nodes">Nodes</h3>
<p>So how are we going to do this in Kotlin Multiplatform? We start with a common module and create the basic definition of a node:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Node</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> attributes<span class="token operator">:</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">val</span> childNodes<span class="token operator">:</span> List<span class="token operator">&lt;</span>Node<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">val</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword">val</span> text<span class="token operator">:</span> String<span class="token operator">?</span>
<span class="token punctuation">)</span></code></pre></div>
<p>If you read any of my previous posts you know I like to build DSL's to make constructing things like this easy. So I've extended it a bit further with some helper class and some helper functions:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token comment">// in class Node</span>
<span class="token keyword">class</span> <span class="token function">BuilderScope</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">var</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> attributes <span class="token operator">=</span> mutableMapOf<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> children <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Node<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> text<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">fun</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token operator">=</span> <span class="token function">Node</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> children<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> text<span class="token punctuation">)</span>

    <span class="token keyword">fun</span> <span class="token function">node</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> block<span class="token operator">:</span> BuilderScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> builder <span class="token operator">=</span> <span class="token function">BuilderScope</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
        <span class="token function">block</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span>
        children<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">operator</span> <span class="token keyword">fun</span> String<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>block<span class="token operator">:</span> BuilderScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">node</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> block<span class="token punctuation">)</span>

    <span class="token keyword">infix</span> <span class="token keyword">fun</span> String<span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span>value<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attributes<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token punctuation">}</span>

    <span class="token keyword">operator</span> <span class="token keyword">fun</span> String<span class="token punctuation">.</span><span class="token function">unaryPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        text <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">node</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> block<span class="token operator">:</span> Node<span class="token punctuation">.</span>BuilderScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>
    <span class="token keyword">val</span> scope <span class="token operator">=</span> Node<span class="token punctuation">.</span><span class="token function">BuilderScope</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
    <span class="token function">block</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span>
    <span class="token keyword">return</span> scope<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">html</span><span class="token punctuation">(</span>block<span class="token operator">:</span> Node<span class="token punctuation">.</span>BuilderScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">node</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"html"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"http://www.w3.org/1999/xhtml"</span></span><span class="token punctuation">,</span> block<span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token function">svg</span><span class="token punctuation">(</span>block<span class="token operator">:</span> Node<span class="token punctuation">.</span>BuilderScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">node</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"svg"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"http://www.w3.org/2000/svg"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span><span class="token string-literal singleline"><span class="token string">"version"</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"1.1"</span></span>
    <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And this allows us to use a very fancy DSL to create our nodes:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">demo</span><span class="token punctuation">(</span>rotation<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> svg <span class="token punctuation">{</span>
    <span class="token string-literal singleline"><span class="token string">"width"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"300"</span></span>
    <span class="token string-literal singleline"><span class="token string">"height"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"200"</span></span>

    <span class="token string-literal singleline"><span class="token string">"rect"</span></span> <span class="token punctuation">{</span> <span class="token comment">// courtesy of the 'String.invoke'</span>
        <span class="token string-literal singleline"><span class="token string">"width"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"100%"</span></span> <span class="token comment">// courtesy of the 'infix fun String.by'</span>
        <span class="token string-literal singleline"><span class="token string">"height"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"100%"</span></span>
        <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"red"</span></span>
    <span class="token punctuation">}</span>

    <span class="token string-literal singleline"><span class="token string">"circle"</span></span> <span class="token punctuation">{</span>
        <span class="token string-literal singleline"><span class="token string">"cx"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"150"</span></span>
        <span class="token string-literal singleline"><span class="token string">"cy"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"100"</span></span>
        <span class="token string-literal singleline"><span class="token string">"r"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"80"</span></span>
        <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"green"</span></span>
    <span class="token punctuation">}</span>

    <span class="token string-literal singleline"><span class="token string">"text"</span></span> <span class="token punctuation">{</span>
        <span class="token string-literal singleline"><span class="token string">"transform"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"rotate(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">rotation</span></span><span class="token string">, 150, 100)"</span></span>
        <span class="token string-literal singleline"><span class="token string">"x"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"150"</span></span>
        <span class="token string-literal singleline"><span class="token string">"y"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"125"</span></span>
        <span class="token string-literal singleline"><span class="token string">"font-size"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"60"</span></span>
        <span class="token string-literal singleline"><span class="token string">"text-anchor"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"middle"</span></span>
        <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">by</span> <span class="token string-literal singleline"><span class="token string">"white"</span></span>
        <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"SVG"</span></span> <span class="token comment">// courtesy of the 'operator fun String.unaryPlus()'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="attaching-the-virtual-dom-to-the-actual-dom">Attaching the virtual DOM to the actual DOM</h3>
<p>We have a tree of nodes, but we still need to render them to screen and somehow relate the <code class="language-text">Node</code> to an actual element. Since I want to keep most of my code platform-agnostic I try to keep everything in the common module and implement platform specific code via the <code class="language-text">actual / expect</code> mechanism or via plain old interfaces.</p>
<p>In this code I decided to link the <code class="language-text">Node</code> to an platform specific "element" by creating a <code class="language-text">Mounted&lt;T></code> data class, which implies that the <code class="language-text">Node</code> is mounted to <em>some</em> <code class="language-text">T</code>.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">val</span> element<span class="token operator">:</span> T<span class="token punctuation">,</span> <span class="token keyword">val</span> container<span class="token operator">:</span> T<span class="token operator">?</span><span class="token punctuation">,</span> <span class="token keyword">val</span> node<span class="token operator">:</span> Node<span class="token punctuation">,</span> <span class="token keyword">val</span> childNodes<span class="token operator">:</span> List<span class="token operator">&lt;</span>Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">)</span></code></pre></div>
<p>In this case the <code class="language-text">container</code> is the <em>parent</em> element. It can be <code class="language-text">null</code> because the top-level node (e.g. <code class="language-text">html</code>) won't have a container.</p>
<p>Now, to actually perform reconciliation we need to have some way of manipulating the target DOM. I call this a <code class="language-text">Target&lt;T></code>, which should be an interface which implements the minimal set of methods for doing all the required tasks of reconciling the virtual DOM with the actual DOM.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Target<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">createElement</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> T
    <span class="token keyword">fun</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span>element<span class="token operator">:</span> T<span class="token punctuation">,</span> key<span class="token operator">:</span> String<span class="token punctuation">,</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">setText</span><span class="token punctuation">(</span>element<span class="token operator">:</span> T<span class="token punctuation">,</span> text<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">appendChild</span><span class="token punctuation">(</span>container<span class="token operator">:</span> T<span class="token operator">?</span><span class="token punctuation">,</span> child<span class="token operator">:</span> T<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">remove</span><span class="token punctuation">(</span>element<span class="token operator">:</span> T<span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">removeAttribute</span><span class="token punctuation">(</span>element<span class="token operator">:</span> T<span class="token punctuation">,</span> key<span class="token operator">:</span> String<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="reconciliation">Reconciliation</h3>
<p>We now can create a class, <code class="language-text">Renderer&lt;T></code> in this case, which does all the 'heavy lifting' of the reconciliation, given a certain <code class="language-text">Node</code> and a <code class="language-text">Target&lt;T></code>.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> Renderer<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> target<span class="token operator">:</span> Target<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> root<span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">val</span> rootElement <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> root<span class="token operator">?</span><span class="token punctuation">.</span>element

    <span class="token keyword">fun</span> <span class="token function">render</span><span class="token punctuation">(</span>node<span class="token operator">:</span> Node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root <span class="token operator">=</span> root<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> <span class="token function">updateNode</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">?:</span> <span class="token function">mount</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>So, when the <code class="language-text">root</code> is <code class="language-text">null</code> it means there is nothing mounted yet, so we mount the current node, otherwise we update it. Afterwards we set the <code class="language-text">root</code> item to the new <code class="language-text">Mounted</code> node.</p>
<h4 id="mounting">Mounting</h4>
<p>Mounting is easy and is written as a simple function that mounts the node and it's children by rendering each <code class="language-text">Node</code> to the <code class="language-text">Target&lt;T></code>.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> Renderer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">mount</span><span class="token punctuation">(</span>node<span class="token operator">:</span> Node<span class="token punctuation">,</span> container<span class="token operator">:</span> T<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> element <span class="token operator">=</span> <span class="token function">renderNodeWithoutChildren</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token keyword">val</span> mountedChildren <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> <span class="token function">mount</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> element<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        target<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> element<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">Mounted</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> node<span class="token punctuation">,</span> mountedChildren<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">renderNodeWithoutChildren</span><span class="token punctuation">(</span>node<span class="token operator">:</span> Node<span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token punctuation">{</span>
        <span class="token keyword">val</span> element <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name<span class="token punctuation">,</span> node<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span>
        node<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-></span>
            target<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        target<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> node<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">return</span> element
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Afterwards we'll have a full tree of <code class="language-text">Mounted&lt;T></code> classes which relate a <code class="language-text">Node</code> to an actual DOM element <code class="language-text">T</code>.</p>
<h4 id="updating">Updating</h4>
<p>When updating we need to update <em>a</em> <code class="language-text">Mounted&lt;T></code> with the new information in a new <code class="language-text">Node</code>.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> Render<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateNode</span><span class="token punctuation">(</span>current<span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> updated<span class="token operator">:</span> Node<span class="token punctuation">)</span><span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">{</span>
            current<span class="token punctuation">.</span>node <span class="token operator">==</span> updated <span class="token operator">-></span> current
            current<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">!=</span> updated<span class="token punctuation">.</span>name <span class="token operator">-></span> <span class="token function">replaceNode</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> updated<span class="token punctuation">)</span>
            <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token function">updateNodeDetailed</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> updated<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We distinguish 3 separate cases here:</p>
<ol>
<li>The current node and the updated node are the same. We just return the current and don't update anything. Please note the <code class="language-text">==</code> works here because we use <code class="language-text">data</code> classes and the <code class="language-text">equals</code> is done by contents and not by reference. This is similar to <code class="language-text">case</code> classes in Scala.</li>
<li>The name (or tag) is different. There is no way to reconcile this apart from fully replacing the node.</li>
<li>They are different and not just by name, we need to do a detailed update.</li>
</ol>
<p>When we are doing a detailed update it is actually only based on 3 different changes: attributes, text content and children:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> Render<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateNodeDetailed</span><span class="token punctuation">(</span>current<span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> updated<span class="token operator">:</span> Node<span class="token punctuation">)</span><span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> current
            <span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> <span class="token function">updateAttributes</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> updated<span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> <span class="token function">updateText</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> updated<span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> updated<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateAttributes</span><span class="token punctuation">(</span>current<span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> updated<span class="token operator">:</span> Node<span class="token punctuation">)</span><span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        updated<span class="token punctuation">.</span>attributes <span class="token operator">-></span> current
        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> leftKeys <span class="token operator">=</span> current<span class="token punctuation">.</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> rightKeys <span class="token operator">=</span> updated<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> toRemove <span class="token operator">=</span> leftKeys <span class="token operator">-</span> rightKeys
            <span class="token keyword">val</span> toSet <span class="token operator">=</span> rightKeys<span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> current<span class="token punctuation">.</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>it<span class="token punctuation">]</span> <span class="token operator">!=</span> updated<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>it<span class="token punctuation">]</span> <span class="token punctuation">}</span>

            toRemove<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> target<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>element<span class="token punctuation">,</span> it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
            toSet<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> target<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>element<span class="token punctuation">,</span> it<span class="token punctuation">,</span> updated<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>it<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            current<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>node <span class="token operator">=</span> current<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>attributes <span class="token operator">=</span> updated<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateText</span><span class="token punctuation">(</span>current<span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> updated<span class="token operator">:</span> Node<span class="token punctuation">)</span><span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>node<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        updated<span class="token punctuation">.</span>text <span class="token operator">-></span> current
        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            target<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>element<span class="token punctuation">,</span> updated<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            current<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>node <span class="token operator">=</span> current<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>text <span class="token operator">=</span> updated<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>current<span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> updated<span class="token operator">:</span> Node<span class="token punctuation">)</span><span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> indices <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> until <span class="token function">max</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>size<span class="token punctuation">,</span> updated<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> mountedChildren <span class="token operator">=</span> indices<span class="token punctuation">.</span><span class="token function">mapNotNull</span> <span class="token punctuation">{</span> i <span class="token operator">-></span>
            <span class="token keyword">val</span> mountedChild <span class="token operator">=</span> current<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span><span class="token function">getOrNull</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token keyword">val</span> updatedChild <span class="token operator">=</span> updated<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span><span class="token function">getOrNull</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token function">updateChild</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>container<span class="token punctuation">,</span> mountedChild<span class="token punctuation">,</span> updatedChild<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> current<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
            node <span class="token operator">=</span> current<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
                childNodes <span class="token operator">=</span> mountedChildren<span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span>node <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            childNodes <span class="token operator">=</span> mountedChildren
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <code class="language-text">updateAttributes</code> and <code class="language-text">updateText</code> are pretty straightforward. The <code class="language-text">updateChildren</code> however requires some more explanation. I am using a <strong>very naive</strong> approach of matching the nodes purely by index in the <code class="language-text">childNodes</code> list. This means I <strong>do not take reordering</strong> into account at all. I think I'll add it later, but I wanted to have everything working first.</p>
<p>The <code class="language-text">updateChild</code> method is implemented as follows:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> Renderer<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">updateChild</span><span class="token punctuation">(</span>container<span class="token operator">:</span> T<span class="token operator">?</span><span class="token punctuation">,</span> mounted<span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">,</span> updated<span class="token operator">:</span> Node<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Mounted<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">{</span>
        mounted <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> updated <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token function">mount</span><span class="token punctuation">(</span>updated<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
        mounted <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> updated <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            target<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mounted<span class="token punctuation">.</span>element<span class="token punctuation">)</span>
            <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
        mounted <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> updated <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">-></span> <span class="token keyword">null</span> <span class="token comment">// for completeness... should not happen</span>
        <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token function">updateNode</span><span class="token punctuation">(</span>mounted<span class="token operator">!!</span><span class="token punctuation">,</span> updated<span class="token operator">!!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>When <code class="language-text">updated</code> is added we should <code class="language-text">mount</code> it. If <code class="language-text">updated</code> is <code class="language-text">null</code> and thus removed, we should remove it. Otherwise we should recursively call the <code class="language-text">updateNode</code> method again.</p>
<h4 id="implementing-a-browser-target">Implementing a Browser target</h4>
<p>The browser target is now made by just implementing <code class="language-text">Target&lt;Element></code> where <code class="language-text">Element</code> refers to the <code class="language-text">org.w3c.dom.Element</code>.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">BrowserDocumentTarget</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> root<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">:</span> Renderer<span class="token punctuation">.</span>Target<span class="token operator">&lt;</span>Element<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createElement</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> namespace<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Element <span class="token punctuation">{</span>
        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setAttribute</span><span class="token punctuation">(</span>element<span class="token operator">:</span> Element<span class="token punctuation">,</span> key<span class="token operator">:</span> String<span class="token punctuation">,</span> value<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// &lt;- this is waaay faster somehow. Reported to JetBrains.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setText</span><span class="token punctuation">(</span>element<span class="token operator">:</span> Element<span class="token punctuation">,</span> text<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span>textContent <span class="token operator">=</span> text
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">appendChild</span><span class="token punctuation">(</span>container<span class="token operator">:</span> Element<span class="token operator">?</span><span class="token punctuation">,</span> child<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>container <span class="token operator">?:</span> root<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">remove</span><span class="token punctuation">(</span>element<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">removeAttribute</span><span class="token punctuation">(</span>element<span class="token operator">:</span> Element<span class="token punctuation">,</span> key<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Well, this is pretty straightforward. It feels a bit redundant, but it is a small price I like to pay to keep most of the stuff platform-agnostic.</p>
<h3 id="demo">Demo</h3>
<p>We can now our virtual DOM for a test ride by making a bunch of bouncing balls. I am just dumping the full code of the example here, because it is basically pretty straightforward. Nevertheless, in short, the following happens:</p>
<ol>
<li>A state <code class="language-text">S</code> is initialized</li>
<li>A <code class="language-text">render</code> function transforms the state to a <code class="language-text">Node</code></li>
<li>An <code class="language-text">update</code> function updates the state</li>
<li>An interval is started of 60Hz</li>
<li>Every tick the state is recalculated and a new <code class="language-text">Node</code> tree is rendered to screen</li>
</ol>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span><span class="token keyword">val</span> x<span class="token operator">:</span> Double<span class="token punctuation">,</span> <span class="token keyword">val</span> y<span class="token operator">:</span> Double<span class="token punctuation">,</span> <span class="token keyword">val</span> dx<span class="token operator">:</span> Double<span class="token punctuation">,</span> <span class="token keyword">val</span> dy<span class="token operator">:</span> Double<span class="token punctuation">)</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Color</span><span class="token punctuation">(</span><span class="token keyword">val</span> red<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">val</span> green<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">val</span> blue<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> Int<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token char">'0'</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">red<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">green<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">blue<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Ball</span><span class="token punctuation">(</span><span class="token keyword">val</span> dynamics<span class="token operator">:</span> Dynamics<span class="token punctuation">,</span> <span class="token keyword">val</span> radius<span class="token operator">:</span> Double<span class="token punctuation">,</span> <span class="token keyword">val</span> color<span class="token operator">:</span> Color<span class="token punctuation">)</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token keyword">val</span> width<span class="token operator">:</span> Double<span class="token punctuation">,</span> <span class="token keyword">val</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">State</span><span class="token punctuation">(</span><span class="token keyword">val</span> area<span class="token operator">:</span> Area<span class="token punctuation">,</span> <span class="token keyword">val</span> balls<span class="token operator">:</span> List<span class="token operator">&lt;</span>Ball<span class="token operator">></span><span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token function">initState</span><span class="token punctuation">(</span>noOfBalls<span class="token operator">:</span> Int<span class="token punctuation">,</span> width<span class="token operator">:</span> Double<span class="token punctuation">,</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span><span class="token operator">:</span> State <span class="token operator">=</span> <span class="token function">State</span><span class="token punctuation">(</span>
    area <span class="token operator">=</span> <span class="token function">Area</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span>
    balls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> until noOfBalls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span>
        <span class="token function">Ball</span><span class="token punctuation">(</span>
            dynamics <span class="token operator">=</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>
                x <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span>
                y <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
                dx <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> width <span class="token operator">/</span> <span class="token number">5000.0</span><span class="token punctuation">,</span>
                dy <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> height <span class="token operator">/</span> <span class="token number">5000.0</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            radius <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token function">minOf</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            color <span class="token operator">=</span> <span class="token function">Color</span><span class="token punctuation">(</span>
                red <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                green <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                blue <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">fun</span> <span class="token function">renderState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> State<span class="token punctuation">)</span> <span class="token operator">=</span> svg <span class="token punctuation">{</span>
    <span class="token string-literal singleline"><span class="token string">"width"</span></span> <span class="token keyword">by</span> state<span class="token punctuation">.</span>area<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token string-literal singleline"><span class="token string">"height"</span></span> <span class="token keyword">by</span> state<span class="token punctuation">.</span>area<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    state<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> ball <span class="token operator">-></span>
        <span class="token string-literal singleline"><span class="token string">"circle"</span></span> <span class="token punctuation">{</span>
            <span class="token string-literal singleline"><span class="token string">"cx"</span></span> <span class="token keyword">by</span> ball<span class="token punctuation">.</span>dynamics<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token string-literal singleline"><span class="token string">"cy"</span></span> <span class="token keyword">by</span> ball<span class="token punctuation">.</span>dynamics<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token string-literal singleline"><span class="token string">"r"</span></span> <span class="token keyword">by</span> ball<span class="token punctuation">.</span>radius<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token string-literal singleline"><span class="token string">"fill"</span></span> <span class="token keyword">by</span> ball<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">walls</span><span class="token punctuation">(</span>u<span class="token operator">:</span> Double<span class="token punctuation">,</span> du<span class="token operator">:</span> Double<span class="token punctuation">,</span> limit<span class="token operator">:</span> Double<span class="token punctuation">)</span><span class="token operator">:</span> Pair<span class="token operator">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">{</span>
    u <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">-></span> <span class="token function">abs</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token keyword">to</span> <span class="token operator">-</span>du
    u <span class="token operator">></span> limit <span class="token operator">-></span> limit <span class="token operator">-</span> <span class="token punctuation">(</span>u <span class="token operator">-</span> limit<span class="token punctuation">)</span> <span class="token keyword">to</span> <span class="token operator">-</span>du
    <span class="token keyword">else</span> <span class="token operator">-></span> u <span class="token keyword">to</span> du
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">updateState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> State<span class="token punctuation">,</span> dt<span class="token operator">:</span> Double<span class="token punctuation">)</span><span class="token operator">:</span> State <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
    balls <span class="token operator">=</span> state<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> ball <span class="token operator">-></span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y0<span class="token punctuation">,</span> dx0<span class="token punctuation">,</span> dy0<span class="token punctuation">)</span> <span class="token operator">=</span> ball<span class="token punctuation">.</span>dynamics
        <span class="token keyword">val</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> dx1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">walls</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> dx0 <span class="token operator">*</span> dt<span class="token punctuation">,</span> dx0<span class="token punctuation">,</span> state<span class="token punctuation">.</span>area<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
        <span class="token keyword">val</span> <span class="token punctuation">(</span>y1<span class="token punctuation">,</span> dy1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">walls</span><span class="token punctuation">(</span>y0 <span class="token operator">+</span> dy0 <span class="token operator">*</span> dt<span class="token punctuation">,</span> dy0<span class="token punctuation">,</span> state<span class="token punctuation">.</span>area<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
        ball<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
            dynamics <span class="token operator">=</span> <span class="token function">Dynamics</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> dx1<span class="token punctuation">,</span> dy1<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> Update<span class="token operator">&lt;</span>S<span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> state<span class="token operator">:</span> S<span class="token punctuation">,</span>
    <span class="token keyword">val</span> render<span class="token operator">:</span> <span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">-></span> Node<span class="token punctuation">,</span>
    <span class="token keyword">val</span> update<span class="token operator">:</span> <span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">-></span> S<span class="token punctuation">,</span>
    <span class="token keyword">val</span> renderer<span class="token operator">:</span> Renderer<span class="token operator">&lt;</span>Element<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> newState <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        <span class="token keyword">val</span> newVDom <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span>
        renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>newVDom<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">copy</span><span class="token punctuation">(</span>
            state <span class="token operator">=</span> newState<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">fun</span> <span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token function">build</span><span class="token punctuation">(</span>mount<span class="token operator">:</span> Element<span class="token punctuation">,</span> initialState<span class="token operator">:</span> S<span class="token punctuation">,</span> render<span class="token operator">:</span> <span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">-></span> Node<span class="token punctuation">,</span> update<span class="token operator">:</span> <span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">-></span> S<span class="token punctuation">)</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> vDom <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span>
            <span class="token keyword">val</span> target <span class="token operator">=</span> <span class="token function">BrowserDocumentTarget</span><span class="token punctuation">(</span>mount<span class="token punctuation">)</span>
            <span class="token keyword">val</span> renderer <span class="token operator">=</span> <span class="token function">Renderer</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
            renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>vDom<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">Update</span><span class="token punctuation">(</span>initialState<span class="token punctuation">,</span> render<span class="token punctuation">,</span> update<span class="token punctuation">,</span> renderer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"app"</span></span><span class="token punctuation">)</span><span class="token operator">!!</span>
    <span class="token keyword">val</span> dt <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span>
    <span class="token keyword">var</span> updater <span class="token operator">=</span> Update<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
        mount <span class="token operator">=</span> container<span class="token punctuation">,</span>
        initialState <span class="token operator">=</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1280.0</span><span class="token punctuation">,</span> <span class="token number">1024.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        render <span class="token operator">=</span> <span class="token punctuation">{</span> state <span class="token operator">-></span> <span class="token function">renderState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        update <span class="token operator">=</span> <span class="token punctuation">{</span> state <span class="token operator">-></span> <span class="token function">updateState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> dt<span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    window<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">{</span> updater <span class="token operator">=</span> updater<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> dt<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And this results in the following nice animation (please note, the GIF's FPS is turned waaaaaay down). It runs at a smooth 60FPS, although the GIF doesn't make that immediately clear:</p>
<p><img src="/static/stress-9e487326c091094213a8f70615e359b8.gif" alt="Bouncing balls"></p>
<h2 id="conclusion">Conclusion</h2>
<p>This was a fun exercise again and I learned a lot, however there are some things I want to improve:</p>
<ol>
<li>Events: Currently I have no event support, that needs to be added.</li>
<li>Lazy node evaluation: It isn't necessary to reconstruct the whole node tree. It can be done lazily if the inputs are changed.</li>
<li>Take order into account</li>
</ol>
<p>I had a lot of fun coding this and I hope you learn something. If you want to ask questions, don't hesitate to contact me via Twitter <a href="https://twitter.com/avwie">@avwie</a>, or look at <a href="https://github.com/avwie/scribbles/tree/532982fc6809a20511fee8927c9142a14a0066ec">my repository of the coding examples</a>. </p></div></main><footer class="container"><p>Build <!-- -->8702bce<!-- --> - <!-- -->2022-08-05T08:01:04.000Z</p></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YZ9NCTW594"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YZ9NCTW594', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/virtual-dom-in-kotlin";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-4e8c86bd5f82e31157fb.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-a877529cf1e94834f497.js"],"component---src-templates-post-js":["/component---src-templates-post-js-8030923d6a02a65604f1.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-8030923d6a02a65604f1.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-e3e290561e79912dfd37.js" async=""></script><script src="/app-4e8c86bd5f82e31157fb.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-6eddbd64c4246bd21a97.js" async=""></script></body></html>