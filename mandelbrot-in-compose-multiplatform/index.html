<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><title>avwie&#x27;s programming blog</title><style data-href="/styles.e5d39825b48065011f83.css" data-identity="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap);:root{--primary-color:#3a6ea5;--primary-light:#c6d8eb;--primary-dark:#004e98;--secondary-color:#ff6b6b;--text-color:#222;--text-light:#555;--background-color:#f9f9f9;--card-background:#fff;--border-color:#e0e0e0;--shadow-color:rgba(0,0,0,.05);--code-background:#f5f7f9;--transition-speed:0.3s;--container-width:800px;--spacing-xs:0.25rem;--spacing-sm:0.5rem;--spacing-md:1rem;--spacing-lg:2rem;--spacing-xl:3rem;--border-radius:8px}*{box-sizing:border-box}body{background-color:var(--background-color);color:var(--text-color);font-family:Open Sans,sans-serif;font-size:16px;font-weight:300;line-height:1.8;margin:0;transition:background-color var(--transition-speed),color var(--transition-speed)}body code[class*=language-],body pre[class*=language-]{word-wrap:normal;background:none;color:#111b27;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body code[class*=language-] ::selection,body code[class*=language-]::selection,body pre[class*=language-] ::selection,body pre[class*=language-]::selection{background:#8da1b9}body pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body :not(pre)>code[class*=language-],body pre[class*=language-]{background:#e3eaf2}body :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em .3em;white-space:normal}body .token.cdata,body .token.comment,body .token.doctype,body .token.prolog{color:#3c526d}body .token.punctuation{color:#111b27}body .token.delimiter.important,body .token.selector .parent,body .token.tag,body .token.tag .token.punctuation{color:#006d6d}body .token.attr-name,body .token.boolean,body .token.boolean.important,body .token.constant,body .token.number,body .token.selector .token.attribute{color:#755f00}body .token.class-name,body .token.key,body .token.parameter,body .token.property,body .token.property-access,body .token.variable{color:#005a8e}body .token.attr-value,body .token.color,body .token.inserted,body .token.selector .token.value,body .token.string,body .token.string .token.url-link{color:#116b00}body .token.builtin,body .token.keyword-array,body .token.package,body .token.regex{color:#af00af}body .token.function,body .token.selector .token.class,body .token.selector .token.id{color:#7c00aa}body .token.atrule .token.rule,body .token.combinator,body .token.keyword,body .token.operator,body .token.pseudo-class,body .token.pseudo-element,body .token.selector,body .token.unit{color:#a04900}body .token.deleted,body .token.important{color:#c22f2e}body .token.keyword-this,body .token.this{color:#005a8e}body .token.bold,body .token.important,body .token.keyword-this,body .token.this{font-weight:700}body .token.delimiter.important{font-weight:inherit}body .token.italic{font-style:italic}body .token.entity{cursor:help}body .language-markdown .token.title,body .language-markdown .token.title .token.punctuation{color:#005a8e;font-weight:700}body .language-markdown .token.blockquote.punctuation{color:#af00af}body .language-markdown .token.code{color:#006d6d}body .language-markdown .token.hr.punctuation{color:#005a8e}body .language-markdown .token.url>.token.content{color:#116b00}body .language-markdown .token.url-link{color:#755f00}body .language-markdown .token.list.punctuation{color:#af00af}body .language-json .token.operator,body .language-markdown .token.table-header{color:#111b27}body .language-scss .token.variable{color:#006d6d}body .token.cr:before,body .token.lf:before,body .token.space:before,body .token.tab:not(:empty):before{color:#3c526d}body div.code-toolbar>.toolbar a,body div.code-toolbar>.toolbar button{background:#005a8e;color:#e3eaf2}body div.code-toolbar>.toolbar a:focus,body div.code-toolbar>.toolbar a:hover,body div.code-toolbar>.toolbar button:focus,body div.code-toolbar>.toolbar button:hover{background:rgba(0,90,142,.855);color:#e3eaf2;text-decoration:none}body div.code-toolbar>.toolbar span,body div.code-toolbar>.toolbar span:focus,body div.code-toolbar>.toolbar span:hover{background:#3c526d;color:#e3eaf2}body .line-highlight{background:rgba(141,161,185,.184);background:linear-gradient(90deg,rgba(141,161,185,.184) 70%,rgba(141,161,185,.145))}body .line-highlight:before,body .line-highlight[data-end]:after{background-color:#3c526d;box-shadow:0 1px #8da1b9;color:#e3eaf2}body pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(60,82,109,.122)}body .line-numbers .line-numbers-rows{background:rgba(208,218,231,.478);border-right:1px solid rgba(141,161,185,.478)}body .line-numbers-rows>span:before{color:rgba(60,82,109,.855)}body .rainbow-braces .token.punctuation.brace-level-1,body .rainbow-braces .token.punctuation.brace-level-5,body .rainbow-braces .token.punctuation.brace-level-9{color:#755f00}body .rainbow-braces .token.punctuation.brace-level-10,body .rainbow-braces .token.punctuation.brace-level-2,body .rainbow-braces .token.punctuation.brace-level-6{color:#af00af}body .rainbow-braces .token.punctuation.brace-level-11,body .rainbow-braces .token.punctuation.brace-level-3,body .rainbow-braces .token.punctuation.brace-level-7{color:#005a8e}body .rainbow-braces .token.punctuation.brace-level-12,body .rainbow-braces .token.punctuation.brace-level-4,body .rainbow-braces .token.punctuation.brace-level-8{color:#7c00aa}body pre.diff-highlight>code .token.deleted:not(.prefix),body pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(194,47,46,.122)}body pre.diff-highlight>code .token.inserted:not(.prefix),body pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(17,107,0,.122)}body .command-line-prompt{border-right:1px solid rgba(141,161,185,.478)}body .command-line-prompt>span:before{color:rgba(60,82,109,.855)}body h1,body h2,body h3,body h4,body h5,body h6{color:var(--primary-dark);font-family:Lora,serif;font-weight:500;line-height:1.3;margin-bottom:var(--spacing-md);margin-top:var(--spacing-lg)}body h1{font-size:2.5rem;margin-top:var(--spacing-xl)}body h2{font-size:2rem}body h3{font-size:1.5rem}body p{margin-bottom:var(--spacing-md)}body a{color:var(--primary-color);text-decoration:none;transition:color var(--transition-speed)}body a:hover{color:var(--primary-dark);text-decoration:underline}body blockquote{background-color:var(--primary-light);border-left:4px solid var(--primary-color);border-radius:0 var(--border-radius) var(--border-radius) 0;color:var(--text-color);font-style:italic;margin:var(--spacing-lg) 0;padding:var(--spacing-md) var(--spacing-lg)}body blockquote p{margin:0}body nav{background-color:var(--primary-dark);box-shadow:0 2px 4px var(--shadow-color);padding:var(--spacing-md) 0;position:-webkit-sticky;position:sticky;top:0;width:100%;z-index:1000}body nav *{color:#fff}body nav>.container{align-items:center;display:flex;flex-direction:row;justify-content:space-between}body nav a{font-size:1.2rem;font-weight:600}body nav a:hover{opacity:.9;text-decoration:none}body nav .social{display:flex;flex-direction:row;gap:var(--spacing-md)}body nav .social a{align-items:center;display:flex;justify-content:center;transition:-webkit-transform var(--transition-speed);transition:transform var(--transition-speed);transition:transform var(--transition-speed),-webkit-transform var(--transition-speed)}body nav .social a:hover{-webkit-transform:scale(1.1);transform:scale(1.1)}body nav .social a.dark-mode{cursor:pointer}body nav .social img{height:24px;width:24px}body .container{margin:0 auto;max-width:var(--container-width);padding:0 var(--spacing-md);width:100%}body main.container{min-height:calc(100vh - 200px);padding-bottom:var(--spacing-xl);padding-top:var(--spacing-lg)}body .index>div{margin-bottom:var(--spacing-xl)}body .posts{display:grid;gap:var(--spacing-lg);grid-template-columns:1fr}@media(min-width:768px){body .posts{grid-template-columns:repeat(2,1fr)}}body .posts .post{background-color:var(--card-background);border-radius:var(--border-radius);box-shadow:0 4px 6px var(--shadow-color);display:flex;flex-direction:column;height:100%;padding:var(--spacing-lg);transition:box-shadow var(--transition-speed),-webkit-transform var(--transition-speed);transition:transform var(--transition-speed),box-shadow var(--transition-speed);transition:transform var(--transition-speed),box-shadow var(--transition-speed),-webkit-transform var(--transition-speed)}body .posts .post:hover{box-shadow:0 10px 15px var(--shadow-color);-webkit-transform:translateY(-5px);transform:translateY(-5px)}body .posts .post h2{font-size:1.5rem;margin-bottom:var(--spacing-sm);margin-top:0}body .posts .post p{margin:var(--spacing-xs) 0}body .posts .post .date,body .posts .post .reading-time{color:var(--text-light);font-size:.9rem;margin-bottom:var(--spacing-sm)}body .posts .post .excerpt{flex-grow:1;margin-bottom:var(--spacing-md)}body .posts .post a.read-more{display:inline-block;font-weight:600;padding:var(--spacing-xs) 0;position:relative}body .posts .post a.read-more:after{content:"â†’";margin-left:var(--spacing-xs);transition:-webkit-transform var(--transition-speed);transition:transform var(--transition-speed);transition:transform var(--transition-speed),-webkit-transform var(--transition-speed)}body .posts .post a.read-more:hover:after{-webkit-transform:translateX(4px);transform:translateX(4px)}body footer{border-top:1px solid var(--border-color);color:var(--text-light);font-size:.9rem;padding:var(--spacing-lg) 0;text-align:center}code[class*=language-],pre[class*=language-]{border-radius:var(--border-radius);font-family:Source Code Pro,monospace!important;font-size:.9rem!important;font-style:normal!important;font-weight:400!important;margin:var(--spacing-lg) 0}pre[class*=language-]{box-shadow:0 2px 4px var(--shadow-color);padding:var(--spacing-md)!important}body.dark{@import"https://fonts.googleapis.com/css2?family=Fira+Code&display=swap";--primary-color:#64b5f6;--primary-light:#2c3e50;--primary-dark:#1e88e5;--secondary-color:#ff7043;--text-color:#fff;--text-light:#ccc;--background-color:#121212;--card-background:#1e1e1e;--border-color:#333;--shadow-color:rgba(0,0,0,.2);--code-background:#2d2d2d}body.dark code[class*=language-],body.dark pre[class*=language-]{color:#a9b7c6;direction:ltr;font-family:Fira Code,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}body.dark code[class*=language-] ::selection,body.dark code[class*=language-]::selection,body.dark pre[class*=language-] ::selection,body.dark pre[class*=language-]::selection{background:rgba(33,66,131,.85);color:inherit}body.dark pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}body.dark :not(pre)>code[class*=language-],body.dark pre[class*=language-]{background:#2b2b2b}body.dark :not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}body.dark .token.cdata,body.dark .token.comment,body.dark .token.prolog{color:gray}body.dark .token.atrule,body.dark .token.boolean,body.dark .token.delimiter,body.dark .token.important,body.dark .token.keyword,body.dark .token.selector{color:#cc7832}body.dark .token.attr-name,body.dark .token.operator,body.dark .token.punctuation{color:#a9b7c6}body.dark .token.builtin,body.dark .token.doctype,body.dark .token.tag,body.dark .token.tag .punctuation{color:#e8bf6a}body.dark .token.entity,body.dark .token.number,body.dark .token.symbol{color:#6897bb}body.dark .token.constant,body.dark .token.property,body.dark .token.variable{color:#9876aa}body.dark .token.char,body.dark .token.string{color:#6a8759}body.dark .token.attr-value,body.dark .token.attr-value .punctuation{color:#a5c261}body.dark .token.attr-value .punctuation:first-child{color:#a9b7c6}body.dark .token.url{color:#287bde;text-decoration:underline}body.dark .token.function{color:#ffc66d}body.dark .token.regex{background:#364135}body.dark .token.bold{font-weight:700}body.dark .token.italic{font-style:italic}body.dark .token.inserted{background:#294436}body.dark .token.deleted{background:#484a4a}body.dark code.language-css .token.property,body.dark code.language-css .token.property+.token.punctuation{color:#a9b7c6}body.dark code.language-css .token.id,body.dark code.language-css .token.selector>.token.attribute,body.dark code.language-css .token.selector>.token.class,body.dark code.language-css .token.selector>.token.pseudo-class,body.dark code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}body.dark blockquote{background-color:var(--primary-light);color:var(--text-color)}body.dark a{color:var(--primary-color)}body.dark a:hover{color:var(--primary-light)}body.dark .post{background-color:var(--card-background)}</style><meta name="generator" content="Gatsby 3.14.6"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="avwie&#x27;s programming blog" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-b6d1bec96c52ba5be7bf.js"/><link as="script" rel="preload" href="/framework-a24df75546761fdaa7be.js"/><link as="script" rel="preload" href="/app-4e8c86bd5f82e31157fb.js"/><link as="script" rel="preload" href="/291a736a4998dc6bb1e7dae6dfd245355445eafd-ef6357f687c91485d3ff.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-650a5f25cc8126c645de.js"/><link as="fetch" rel="preload" href="/page-data/mandelbrot-in-compose-multiplatform/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3406609010.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav><div class="container"><a href="/">@avwie&#x27;s programming blog</a><div class="social"><a title="Github" href="https://github.com/avwie" target="_blank" rel="noreferrer"><img alt="Github" width="24" height="24" src="/layout/github-48.png"/></a><a title="Mail" href="mailto:info@avwie.nl" target="_blank" rel="noreferrer"><img alt="Mail" width="24" height="24" src="/layout/mail-48.png"/></a><a title="Twitter" href="https://twitter.com/avwie" target="_blank" rel="noreferrer"><img alt="Twitter" width="24" height="24" src="/layout/twitter-48.png"/></a><a class="dark-mode"><img alt="dark-mode" width="24" height="24" src="/layout/dark-mode-48.png"/></a></div></div></nav><main class="container"><h1>Building a Mandelbrot viewer in Compose Multiplatform</h1><h4>14 Oct, 2022</h4><div><p>I decided to experiment with Compose Multiplatform, the declarative UI framework, even though I hardly know Compose. Since I am not an Android developer it was a bit confusing to get started with, because there are multiple artifacts that are called 'Compose'. This is related to the origin of Compose. </p>
<p>As far as I understand it it is as follows: JetPack Compose is the declarative UI toolkit being developed by the Google Android team. This consists of a few components:</p>
<ul>
<li>The Compose Runtime, which is the core of Compose and is not specifically related to UI's. It is a very novel way of working with tree structures that mutate over time. And since UI's can be modelled as trees this is a nice fit.</li>
<li>Compose UI, the layer which sits on top of the runtime and contains the UI building blocks</li>
<li>Compose Material, the Material Design implementation in Compose UI</li>
</ul>
<p>However, Jetbrains (not affiliated at all with JetPack) identified that the Compose Runtime is not at all bound to the Android platform and forked it, resulting in:</p>
<ul>
<li>Compose Multiplatform, the runtime and the building blocks for using Compose Runtime in Kotlin Multiplatform Common code</li>
<li>Compose for Desktop, contains Compose UI and Compose Material implementations for the JVM</li>
<li>Compose for Web, contains a Compose implementation for the DOM, which allows you to write Composables for the Web</li>
</ul>
<p>More can be found here: <a href="https://www.jetbrains.com/lp/compose-mpp/">Compose Multiplatform</a></p>
<p>However.... there is also an experimental directory in their repository: <a href="https://github.com/JetBrains/compose-jb/tree/master/experimental">https://github.com/JetBrains/compose-jb/tree/master/experimental</a>. And that one contains very interesting examples. It appears that they are experimenting with making it possible to reuse Compose UI and Compose Material across all platforms. This includes JVM, Native desktop targets, iOS targets, and a Web target via HTML Canvas.</p>
<p>Together with my idea to test coroutines for calculating solutions to <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel">embarrassingly parallel</a> problems I had a nice small coding target. I wanted to make a Mandelbrot Viewer in Kotlin Compose Multiplatform, making it work in the most amount of platforms available with only common code.</p>
<h2 id="mandelbrot-calculation">Mandelbrot calculation</h2>
<p>Much has been said about the Mandelbrot and I am not going to rehash that here. It is a very well described problem and I will only be showing the implementation. </p>
<p>The core algorithm is pretty simple:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">mandelbrot</span><span class="token punctuation">(</span>cx0<span class="token operator">:</span> Double<span class="token punctuation">,</span> cy0<span class="token operator">:</span> Double<span class="token punctuation">,</span> limit<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token punctuation">(</span>xn<span class="token punctuation">,</span> yn<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span> <span class="token keyword">to</span> <span class="token number">0.0</span>

    <span class="token keyword">var</span> xtemp<span class="token operator">:</span> Double
    <span class="token keyword">var</span> ytemp<span class="token operator">:</span> Double<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>xn <span class="token operator">*</span> xn <span class="token operator">+</span> yn <span class="token operator">*</span> yn <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        xtemp <span class="token operator">=</span> xn <span class="token operator">*</span> xn <span class="token operator">-</span> yn <span class="token operator">*</span> yn
        ytemp <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> xn <span class="token operator">*</span> yn
        xn <span class="token operator">=</span> xtemp <span class="token operator">+</span> cx0
        yn <span class="token operator">=</span> ytemp <span class="token operator">+</span> cy0
        i<span class="token operator">++</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Here <code class="language-text">cx0</code> and <code class="language-text">cy0</code> are the starting points in the complex plane (<code class="language-text">cx0 + i * cxy0</code>) which is used as the input. The <code class="language-text">limit</code> is the amount of iteratons until the algorithm decides the starting point is part of the Mandelbrot set.</p>
<p>Since this is only 1 pixel we need to expand it to a full map. I'll use a simple datastructure for that:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">MandelbrotMap</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> options<span class="token operator">:</span> Options<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> buffer<span class="token operator">:</span> IntArray
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Options</span><span class="token punctuation">(</span>
        <span class="token keyword">val</span> xMin<span class="token operator">:</span> Double<span class="token punctuation">,</span>
        <span class="token keyword">val</span> xMax<span class="token operator">:</span> Double<span class="token punctuation">,</span>
        <span class="token keyword">val</span> xRes<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        <span class="token keyword">val</span> yMin<span class="token operator">:</span> Double<span class="token punctuation">,</span>
        <span class="token keyword">val</span> yMax<span class="token operator">:</span> Double<span class="token punctuation">,</span>
        <span class="token keyword">val</span> yRes<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        <span class="token keyword">val</span> limit<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">128</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <code class="language-text">buffer</code> is a flat array which will contain the results from the calculations for the complete viewport, which is described by the <code class="language-text">Options</code> data structure. To calculate the Map we use the following routine:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span>options<span class="token operator">:</span> Options<span class="token punctuation">,</span> parallel<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token operator">=</span> coroutineScope <span class="token punctuation">{</span>
    <span class="token keyword">val</span> buffer <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>xRes <span class="token operator">*</span> options<span class="token punctuation">.</span>yRes<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token number">0</span> until options<span class="token punctuation">.</span>yRes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> y <span class="token operator">-></span>
        <span class="token keyword">val</span> block <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token number">0</span> until options<span class="token punctuation">.</span>xRes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> x <span class="token operator">-></span>
                <span class="token keyword">val</span> cx0 <span class="token operator">=</span> options<span class="token punctuation">.</span>xMin <span class="token operator">+</span> x <span class="token operator">*</span> options<span class="token punctuation">.</span>deltaX
                <span class="token keyword">val</span> cy0 <span class="token operator">=</span> options<span class="token punctuation">.</span>yMin <span class="token operator">+</span> y <span class="token operator">*</span> options<span class="token punctuation">.</span>deltaY
                buffer<span class="token punctuation">[</span>y <span class="token operator">*</span> options<span class="token punctuation">.</span>xRes <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mandelbrot</span><span class="token punctuation">(</span>cx0<span class="token punctuation">,</span> cy0<span class="token punctuation">,</span> options<span class="token punctuation">.</span>limit<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parallel<span class="token punctuation">)</span> launch <span class="token punctuation">{</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">MandelbrotMap</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This is where the parallelization happens. I have a parameter called <code class="language-text">parallel</code> which decides whether or not we split the work. Currently I decided to launch a coroutine for every row. This is completely arbitrary. Since this algorithm is embarrassingly parallel, we don't need to worry about shared mutable state. Every pixel writes in its own index in the buffer. Please note that we defer the context of the coroutine to the caller of this function.</p>
<h2 id="mandelbrot-plotting">Mandelbrot plotting</h2>
<p>Now we have a linear array of integer values which is not very pleasing to the eye. So we need to convert it to a bitmap. Since I want to use it in Compose I figured I needed to render it inside a <code class="language-text">Canvas</code> which contains a <code class="language-text">drawImage</code> function. This <code class="language-text">drawImage</code> function requires a <code class="language-text">androidx.compose.ui.graphics.ImageBitmap</code>. But I found no way to implement such an <code class="language-text">ImageBitmap</code> interface. However, with the help from the Kotli Slack channel I learned that we can use a <code class="language-text">org.jetbrains.skia.Bitmap</code> and leverage the extension function <code class="language-text">toComposeImageBitmap</code> on that class to transform it. </p>
<p>Now I only needed to find out how to make a <code class="language-text">Bitmap</code>. After scouring Slack and diving into the code of <a href="https://github.com/kirill-grouchnikov">Kirill Grouchnikov</a> I managed to create a Skia Bitmap using a nice helper function:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> BitmapBuilderScope <span class="token punctuation">{</span>
    <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token keyword">set</span><span class="token punctuation">(</span>index<span class="token operator">:</span> Int<span class="token punctuation">,</span> color<span class="token operator">:</span> Color<span class="token punctuation">)</span>
    <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token keyword">set</span><span class="token punctuation">(</span>x<span class="token operator">:</span> Int<span class="token punctuation">,</span> y<span class="token operator">:</span> Int<span class="token punctuation">,</span> color<span class="token operator">:</span> Color<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">buildBitmap</span><span class="token punctuation">(</span>width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">,</span> block<span class="token operator">:</span> BitmapBuilderScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> Bitmap <span class="token punctuation">{</span>
    <span class="token keyword">val</span> builder <span class="token operator">=</span> <span class="token function">BitmapBuilder</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    <span class="token function">block</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">BitmapBuilder</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">private</span> <span class="token keyword">val</span> height<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> BitmapBuilderScope <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> bytes <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>width <span class="token operator">*</span> height <span class="token operator">*</span> ColorType<span class="token punctuation">.</span>RGBA_8888<span class="token punctuation">.</span>bytesPerPixel<span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token keyword">set</span><span class="token punctuation">(</span>index<span class="token operator">:</span> Int<span class="token punctuation">,</span> color<span class="token operator">:</span> Color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bytes<span class="token punctuation">[</span>index <span class="token operator">*</span> ColorType<span class="token punctuation">.</span>RGBA_8888<span class="token punctuation">.</span>bytesPerPixel <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>red <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        bytes<span class="token punctuation">[</span>index <span class="token operator">*</span> ColorType<span class="token punctuation">.</span>RGBA_8888<span class="token punctuation">.</span>bytesPerPixel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>green <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        bytes<span class="token punctuation">[</span>index <span class="token operator">*</span> ColorType<span class="token punctuation">.</span>RGBA_8888<span class="token punctuation">.</span>bytesPerPixel <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>blue <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        bytes<span class="token punctuation">[</span>index <span class="token operator">*</span> ColorType<span class="token punctuation">.</span>RGBA_8888<span class="token punctuation">.</span>bytesPerPixel <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token keyword">set</span><span class="token punctuation">(</span>x<span class="token operator">:</span> Int<span class="token punctuation">,</span> y<span class="token operator">:</span> Int<span class="token punctuation">,</span> color<span class="token operator">:</span> Color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>x <span class="token keyword">in</span> <span class="token number">0</span> until width<span class="token punctuation">)</span>
        <span class="token function">require</span><span class="token punctuation">(</span>y <span class="token keyword">in</span> <span class="token number">0</span> until height<span class="token punctuation">)</span>
        <span class="token keyword">val</span> index <span class="token operator">=</span> y <span class="token operator">*</span> width <span class="token operator">+</span> x
        <span class="token keyword">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> color<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Bitmap <span class="token punctuation">{</span>
        <span class="token keyword">val</span> bitmap <span class="token operator">=</span> <span class="token function">Bitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> info <span class="token operator">=</span> <span class="token function">ImageInfo</span><span class="token punctuation">(</span>
            colorInfo <span class="token operator">=</span> <span class="token function">ColorInfo</span><span class="token punctuation">(</span>
                colorType <span class="token operator">=</span> ColorType<span class="token punctuation">.</span>RGBA_8888<span class="token punctuation">,</span>
                alphaType <span class="token operator">=</span> ColorAlphaType<span class="token punctuation">.</span>PREMUL<span class="token punctuation">,</span>
                colorSpace <span class="token operator">=</span> ColorSpace<span class="token punctuation">.</span>sRGB
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            width <span class="token operator">=</span> width<span class="token punctuation">,</span>
            height <span class="token operator">=</span> height
        <span class="token punctuation">)</span>
        bitmap<span class="token punctuation">.</span><span class="token function">allocPixels</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
        bitmap<span class="token punctuation">.</span><span class="token function">installPixels</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bitmap
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>And rendering the Mandelbrot buffer becomes trivial now;</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">asBitmap</span><span class="token punctuation">(</span>colorMap<span class="token operator">:</span> ColorMap<span class="token punctuation">)</span><span class="token operator">:</span> Bitmap <span class="token operator">=</span> <span class="token function">buildBitmap</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> min <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">minOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token number">0</span>
    <span class="token keyword">val</span> max <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">maxOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?:</span> options<span class="token punctuation">.</span>limit

    <span class="token comment">// precalcualte the color map values</span>
    <span class="token keyword">val</span> colors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">..</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> colorMap<span class="token punctuation">[</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">toTypedArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token label symbol">@MandelbrotMap</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">forEachIndexed</span> <span class="token punctuation">{</span> index<span class="token punctuation">,</span>  value <span class="token operator">-></span>
        <span class="token keyword">val</span> color <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span>limit <span class="token operator">-></span> Color<span class="token punctuation">.</span>Black
            <span class="token keyword">else</span> <span class="token operator">-></span> colors<span class="token punctuation">[</span>value <span class="token operator">-</span> min<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> color
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As you can see we need a <code class="language-text">ColorMap</code>, which is defined as:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token keyword">interface</span> ColorMap <span class="token punctuation">{</span>
    <span class="token keyword">operator</span> <span class="token keyword">fun</span> <span class="token keyword">get</span><span class="token punctuation">(</span>value<span class="token operator">:</span> Float<span class="token punctuation">)</span><span class="token operator">:</span> Color
<span class="token punctuation">}</span></code></pre></div>
<p>The implementation is in my repository, but not important for this post.</p>
<h2 id="building-the-viewmodel">Building the ViewModel</h2>
<p>I like to work with ViewModels. They contain all the interactions and all the important state-handling so the view itself can just to the thing it is meant to... creating a view.</p>
<p>The whole viewmodel is written as:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">MandelbrotViewerModel</span><span class="token punctuation">(</span>scope<span class="token operator">:</span> CoroutineScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> currentCalculationJob <span class="token operator">:</span> Job <span class="token operator">=</span> <span class="token function">Job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> minResolution <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> viewPorts <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span>
        <span class="token function">Viewport</span><span class="token punctuation">(</span>
            width <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            height <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
            x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.141</span><span class="token punctuation">,</span>
            y <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.2678</span><span class="token punctuation">,</span>
            xScale <span class="token operator">=</span> <span class="token number">0.1</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> limits <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> parallel <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> colorMaps <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span>ColorMap<span class="token punctuation">.</span>Plasma<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mandelbrots <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span>MandelbrotMap<span class="token punctuation">.</span>UNIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> options <span class="token operator">=</span> <span class="token function">combine</span><span class="token punctuation">(</span>viewPorts<span class="token punctuation">,</span> limits<span class="token punctuation">)</span> <span class="token punctuation">{</span> viewPort<span class="token operator">:</span> Viewport<span class="token punctuation">,</span> limit<span class="token operator">:</span> Int <span class="token operator">-></span>
        MandelbrotMap<span class="token punctuation">.</span>Options<span class="token punctuation">.</span><span class="token function">fromViewport</span><span class="token punctuation">(</span>viewPort<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">val</span> bitmaps <span class="token operator">=</span> <span class="token function">combine</span><span class="token punctuation">(</span>mandelbrots<span class="token punctuation">,</span> colorMaps<span class="token punctuation">)</span> <span class="token punctuation">{</span> mandelbrot<span class="token punctuation">,</span> colorMap <span class="token operator">-></span> mandelbrot<span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span>colorMap<span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token keyword">init</span> <span class="token punctuation">{</span>
        scope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Default<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// here we offload the calculations to the Default dispatcher</span>
            <span class="token function">combine</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> parallel<span class="token punctuation">)</span> <span class="token punctuation">{</span> options<span class="token operator">:</span> MandelbrotMap<span class="token punctuation">.</span>Options<span class="token punctuation">,</span> parallel<span class="token operator">:</span> Boolean <span class="token operator">-></span>
                <span class="token function">calculateMandelbrotMaps</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> resolutions <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> minResolution<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span>colorMap<span class="token operator">:</span> ColorMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colorMaps<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">{</span> colorMap <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">updateSize</span><span class="token punctuation">(</span>size<span class="token operator">:</span> IntSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewPorts<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>width <span class="token operator">=</span> size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> height <span class="token operator">=</span> size<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">updatePosition</span><span class="token punctuation">(</span>offset<span class="token operator">:</span> Offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewPorts<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">{</span> viewPort <span class="token operator">-></span>
            <span class="token keyword">val</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span> MandelbrotMap<span class="token punctuation">.</span>Options
                <span class="token punctuation">.</span><span class="token function">fromViewport</span><span class="token punctuation">(</span>viewPort<span class="token punctuation">,</span> limits<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">convertScreenCoordinates</span><span class="token punctuation">(</span>offset<span class="token punctuation">.</span>x<span class="token punctuation">,</span> offset<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
            viewPort<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>x <span class="token operator">=</span> x<span class="token punctuation">,</span> y <span class="token operator">=</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">zoom</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> Float<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewPorts<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">{</span> viewPort <span class="token operator">-></span> viewPort<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>xScale <span class="token operator">=</span> viewPort<span class="token punctuation">.</span>xScale <span class="token operator">*</span> amount<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setParallel</span><span class="token punctuation">(</span>parallel<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parallel<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">{</span> parallel <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setMinResolution</span><span class="token punctuation">(</span>resolution<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        minResolution <span class="token operator">=</span> resolution
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">calculateMandelbrotMaps</span><span class="token punctuation">(</span>options<span class="token operator">:</span> MandelbrotMap<span class="token punctuation">.</span>Options<span class="token punctuation">,</span> parallel<span class="token operator">:</span> Boolean<span class="token punctuation">,</span> resolutions<span class="token operator">:</span> List<span class="token operator">&lt;</span>Int<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=</span> coroutineScope <span class="token punctuation">{</span>
        <span class="token comment">// this can probably be done nicer, but don't know how atm.</span>
        <span class="token comment">// the idea is to cancel any running calculations when the inputs change</span>
        currentCalculationJob<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        currentCalculationJob <span class="token operator">=</span> launch <span class="token punctuation">{</span>
            resolutions<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> resolution <span class="token operator">-></span>
                mandelbrots<span class="token punctuation">.</span><span class="token function">update</span> <span class="token punctuation">{</span>
                    MandelbrotMap<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">withResolution</span><span class="token punctuation">(</span>resolution<span class="token punctuation">)</span><span class="token punctuation">,</span> parallel<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>I like to refrain from using any Compose states in the view models, and only rely on <code class="language-text">StateFlow</code> for states and <code class="language-text">Flow</code> for derived states. The exposed functions modify the inputs for the calculations of the maps and on any change of the input parameters the <code class="language-text">mandelbrots</code> StateFlow is updated with the latest <code class="language-text">MandelbrotMap</code>. The <code class="language-text">bitmaps</code> Flow is a simple mapping of <code class="language-text">MandelbrotMap</code> to <code class="language-text">Bitmap</code>.</p>
<p>Another interesting trick is that I calculate the Mandelbrot with increased resolutions. This means that when navigating to the Mandelbrot you get a coarse low-res view fast, and a high-res view later. </p>
<h2 id="building-the-compose-view">Building the Compose View</h2>
<p>Now is the interesting part. We are making a view in <code class="language-text">common</code> only code. This required some <code class="language-text">gradle.kts</code> dependencies:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin">plugins <span class="token punctuation">{</span>
    <span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"multiplatform"</span></span><span class="token punctuation">)</span> version <span class="token string-literal singleline"><span class="token string">"1.7.10"</span></span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jetbrains.compose"</span></span><span class="token punctuation">)</span> version <span class="token string-literal singleline"><span class="token string">"1.2.0"</span></span>
<span class="token punctuation">}</span>

kotlin <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
    sourceSets <span class="token punctuation">{</span>
        <span class="token keyword">val</span> commonMain <span class="token keyword">by</span> getting <span class="token punctuation">{</span>
            dependencies <span class="token punctuation">{</span>
                <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:1.6.4"</span></span><span class="token punctuation">)</span>
                <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"org.jetbrains.skiko:skiko:0.7.35"</span></span><span class="token punctuation">)</span>
                <span class="token function">implementation</span><span class="token punctuation">(</span>compose<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span>
                <span class="token function">implementation</span><span class="token punctuation">(</span>compose<span class="token punctuation">.</span>material<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We start with the main app:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Composable</span> <span class="token keyword">fun</span> <span class="token function">MandelbrotApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> scope <span class="token operator">=</span> <span class="token function">rememberCoroutineScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> model <span class="token operator">=</span> remember <span class="token punctuation">{</span> <span class="token function">MandelbrotViewerModel</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    MaterialTheme <span class="token punctuation">{</span>
        <span class="token function">MandelbrotViewer</span><span class="token punctuation">(</span>model <span class="token operator">=</span> model<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The viewer is defined like this:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Composable</span> <span class="token keyword">fun</span> <span class="token function">MandelbrotViewer</span><span class="token punctuation">(</span>model<span class="token operator">:</span> MandelbrotViewerModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> requester <span class="token operator">=</span> remember <span class="token punctuation">{</span> <span class="token function">FocusRequester</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        requester<span class="token punctuation">.</span><span class="token function">requestFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    Box <span class="token punctuation">{</span>
        <span class="token function">MandelbrotPlot</span><span class="token punctuation">(</span>requester<span class="token punctuation">,</span> model<span class="token punctuation">)</span>

        <span class="token function">Box</span><span class="token punctuation">(</span>modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">align</span><span class="token punctuation">(</span>Alignment<span class="token punctuation">.</span>BottomCenter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">MandelbrotControls</span><span class="token punctuation">(</span>requester<span class="token punctuation">,</span> model<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We need the <code class="language-text">requester</code> there to bring back focus to the canvas in the plot part. </p>
<p>The <code class="language-text">MandelbrotControls</code> are not that interesting and can be viewed in the Github repo, however the <code class="language-text">MandelbrotPlot</code> is interesting and is defined as follows:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@OptIn</span><span class="token punctuation">(</span>ExperimentalComposeUiApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Composable</span> <span class="token keyword">fun</span> <span class="token function">MandelbrotPlot</span><span class="token punctuation">(</span>
    requester<span class="token operator">:</span> FocusRequester<span class="token punctuation">,</span>
    model<span class="token operator">:</span> MandelbrotViewerModel
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> bitmap <span class="token keyword">by</span> model<span class="token punctuation">.</span>bitmaps<span class="token punctuation">.</span><span class="token function">collectAsState</span><span class="token punctuation">(</span>EMPTY_BITMAP<span class="token punctuation">)</span>
    <span class="token keyword">val</span> minResolution <span class="token operator">=</span> LocalDensity<span class="token punctuation">.</span>current<span class="token punctuation">.</span>density<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>minResolution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">setMinResolution</span><span class="token punctuation">(</span>minResolution<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">Canvas</span><span class="token punctuation">(</span>modifier <span class="token operator">=</span> Modifier
        <span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">focusRequester</span><span class="token punctuation">(</span>requester<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">focusable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onPointerEvent</span><span class="token punctuation">(</span>PointerEventType<span class="token punctuation">.</span>Release<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> position <span class="token operator">=</span> it<span class="token punctuation">.</span>changes<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>position
            requester<span class="token punctuation">.</span><span class="token function">requestFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            model<span class="token punctuation">.</span><span class="token function">updatePosition</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">onKeyEvent</span> <span class="token punctuation">{</span>
            <span class="token keyword">when</span> <span class="token punctuation">{</span>
                it<span class="token punctuation">.</span>type <span class="token operator">!=</span> KeyEventType<span class="token punctuation">.</span>KeyUp <span class="token operator">-></span> <span class="token boolean">false</span>
                it<span class="token punctuation">.</span>key <span class="token operator">==</span> Key<span class="token punctuation">.</span>DirectionUp <span class="token operator">-></span> <span class="token punctuation">{</span>
                    model<span class="token punctuation">.</span><span class="token function">zoom</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                it<span class="token punctuation">.</span>key <span class="token operator">==</span> Key<span class="token punctuation">.</span>DirectionDown <span class="token operator">-></span> <span class="token punctuation">{</span>
                    model<span class="token punctuation">.</span><span class="token function">zoom</span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">onSizeChanged</span> <span class="token punctuation">{</span> size <span class="token operator">-></span> model<span class="token punctuation">.</span><span class="token function">updateSize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">drawImage</span><span class="token punctuation">(</span>
            image <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">asComposeImageBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dstSize <span class="token operator">=</span> <span class="token function">IntSize</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As can be seen this is pretty straightforward! I handle some UI events and I set the minimum resolution to the LocalDensitity.</p>
<h2 id="launching-it-on-jvm-js-and-ios">Launching it on JVM, JS and iOS</h2>
<p>Looking at the examples in the experimental folder of Jetbrains I decided to copy/paste most of the <code class="language-text">gradle</code> configuration. However there were some issues:</p>
<ul>
<li>Kotlin 1.7.20 contains the new native memory model, but the JS part doesn't compile. So I needed to set some properties in the gradle.properties file</li>
<li>I can't get Arm64 targets working, I think because they aren't supported yet</li>
</ul>
<p>Since this is highly experimental I am okay with that.</p>
<p>However, after some tinkering I managed to get it working on JVM, JS, and iPad!</p>
<video controls width="100%">
    <source src="/movies/mandelbrot.mp4" type="video/mp4">
</video>
<h2 id="conclusion">Conclusion</h2>
<p>This was very fun to do and it amazed me how far I got. The Slack channel of Kotlin was amazingly helpful once again.
Seeing as it is highly experimental it really shows it has a lot of potential.</p>
<p>I can't understate how awesome it would be to have shared UI code across platforms. Granted, there are big differences between platforms, so you probably need to do platform-specific modifications. However, it would be awesome if this can be done from the comfort of Kotlin code.</p>
<p>The code for the repository can be found here: <a href="https://github.com/avwie/mandelbrot-compose-multiplatform">https://github.com/avwie/mandelbrot-compose-multiplatform</a>
Please let me know on Github if you have any questions!</p></div></main><footer class="container"><p>Build <!-- -->55859ee<!-- --> - <!-- -->2025-05-11T08:40:09.000Z</p></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YZ9NCTW594"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YZ9NCTW594', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/mandelbrot-in-compose-multiplatform";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-ec707b41bccf15b2b27f.js"],"app":["/app-4e8c86bd5f82e31157fb.js"],"component---src-pages-404-js":["/component---src-pages-404-js-aa0ffeb8181716267d64.js"],"component---src-pages-index-js":["/component---src-pages-index-js-f2b90683571a7299fa82.js"],"component---src-templates-post-js":["/component---src-templates-post-js-650a5f25cc8126c645de.js"]};/*]]>*/</script><script src="/polyfill-ec707b41bccf15b2b27f.js" nomodule=""></script><script src="/component---src-templates-post-js-650a5f25cc8126c645de.js" async=""></script><script src="/291a736a4998dc6bb1e7dae6dfd245355445eafd-ef6357f687c91485d3ff.js" async=""></script><script src="/app-4e8c86bd5f82e31157fb.js" async=""></script><script src="/framework-a24df75546761fdaa7be.js" async=""></script><script src="/webpack-runtime-b6d1bec96c52ba5be7bf.js" async=""></script></body></html>